# WHY: Strict Refactoring Skill è§£èª¬æ›¸

> **å¯¾è±¡èª­è€…:** ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°çµŒé¨“1000æ™‚é–“ç¨‹åº¦ã®ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢  
> **ç›®çš„:** å„ãƒ«ãƒ¼ãƒ«ã®ã€Œãªãœã€ã‚’ç†è§£ã—ã€é•å’Œæ„Ÿãªãé©ç”¨ã§ãã‚‹ã‚ˆã†ã«ãªã‚‹ã“ã¨

---

# Part 0: å‰æçŸ¥è­˜

## 0.1 ãªãœè¨­è¨ˆãƒ«ãƒ¼ãƒ«ãŒå¿…è¦ã‹

### ã€Œå‹•ãã‚³ãƒ¼ãƒ‰ã€ã¨ã€Œè‰¯ã„ã‚³ãƒ¼ãƒ‰ã€ã®é•ã„

ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ã‚’å§‹ã‚ãŸã°ã‹ã‚Šã®é ƒã¯ã€Œå‹•ãã‚³ãƒ¼ãƒ‰ã€ã‚’æ›¸ãã“ã¨ã«é›†ä¸­ã—ã¾ã™ã€‚ãƒ†ã‚¹ãƒˆãŒé€šã‚Œã°æˆåŠŸã€ç”»é¢ã«è¡¨ç¤ºã•ã‚Œã‚Œã°å®Œæˆã€‚ã“ã‚Œã¯æ­£ã—ã„ã‚¹ã‚¿ãƒ¼ãƒˆã§ã™ã€‚

ã—ã‹ã—ã€å®Ÿå‹™ã§çµŒé¨“ã‚’ç©ã‚€ã¨å¿…ãšã“ã‚“ãªå ´é¢ã«é­é‡ã—ã¾ã™ï¼š

- ã€Œ3ãƒ¶æœˆå‰ã«è‡ªåˆ†ãŒæ›¸ã„ãŸã‚³ãƒ¼ãƒ‰ãŒèª­ã‚ãªã„ã€
- ã€Œ1ç®‡æ‰€ç›´ã—ãŸã‚‰åˆ¥ã®å ´æ‰€ãŒå£Šã‚ŒãŸã€
- ã€Œã“ã®ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ã„ãŸäººãŒé€€è·ã—ã¦ã€èª°ã‚‚è§¦ã‚Œãªã„ã€

**å‹•ãã‚³ãƒ¼ãƒ‰**ã¨**è‰¯ã„ã‚³ãƒ¼ãƒ‰**ã®é•ã„ã¯ã€**å¤‰æ›´ã®ã—ã‚„ã™ã•**ã§ã™ï¼š

| è¦³ç‚¹ | å‹•ãã‚³ãƒ¼ãƒ‰ | è‰¯ã„ã‚³ãƒ¼ãƒ‰ |
|------|-----------|-----------|
| åˆå›é–‹ç™º | é€Ÿã„ | ã‚„ã‚„é…ã„ |
| ãƒã‚°ä¿®æ­£ | å›°é›£ï¼ˆã©ã“ã‚’ç›´ã›ã°ã„ã„ã‹åˆ†ã‹ã‚‰ãªã„ï¼‰ | å®¹æ˜“ï¼ˆå½±éŸ¿ç¯„å›²ãŒæ˜ç¢ºï¼‰ |
| æ©Ÿèƒ½è¿½åŠ  | å›°é›£ï¼ˆæ—¢å­˜ã‚³ãƒ¼ãƒ‰ã‚’å£Šã—ãã†ï¼‰ | å®¹æ˜“ï¼ˆæ‹¡å¼µãƒã‚¤ãƒ³ãƒˆãŒæ˜ç¢ºï¼‰ |
| ãƒãƒ¼ãƒ é–‹ç™º | å›°é›£ï¼ˆäººã«ã‚ˆã£ã¦æ›¸ãæ–¹ãŒãƒãƒ©ãƒãƒ©ï¼‰ | å®¹æ˜“ï¼ˆå…±é€šãƒ«ãƒ¼ãƒ«ãŒã‚ã‚‹ï¼‰ |
| å¼•ãç¶™ã | å›°é›£ï¼ˆæ›¸ã„ãŸæœ¬äººã—ã‹åˆ†ã‹ã‚‰ãªã„ï¼‰ | å®¹æ˜“ï¼ˆæ§‹é€ ãŒäºˆæ¸¬å¯èƒ½ï¼‰ |

### è¨­è¨ˆãƒ«ãƒ¼ãƒ«ã®ä¾¡å€¤

è¨­è¨ˆãƒ«ãƒ¼ãƒ«ã¯ã€Œåˆ¶ç´„ã€ã§ã¯ãªãã€Œã‚¬ãƒ¼ãƒ‰ãƒ¬ãƒ¼ãƒ«ã€ã§ã™ã€‚

**ã‚¬ãƒ¼ãƒ‰ãƒ¬ãƒ¼ãƒ«**ã¨ã¯ã€é“è·¯ã®ç«¯ã«è¨­ç½®ã•ã‚ŒãŸé˜²è­·æŸµã®ã“ã¨ã€‚é‹è»¢æ‰‹ã®è‡ªç”±ã‚’å¥ªã†ãŸã‚ã§ã¯ãªãã€å´–ã‹ã‚‰è½ã¡ãªã„ã‚ˆã†ã«ã™ã‚‹ãŸã‚ã«ã‚ã‚Šã¾ã™ã€‚è¨­è¨ˆãƒ«ãƒ¼ãƒ«ã‚‚åŒã˜ã§ã€ã€Œæ‚ªã„è¨­è¨ˆã€ã¨ã„ã†å´–ã‹ã‚‰è½ã¡ãªã„ãŸã‚ã®ã‚‚ã®ã§ã™ã€‚

è¨­è¨ˆãƒ«ãƒ¼ãƒ«ãŒã‚ã‚‹ã¨ï¼š
1. **åˆ¤æ–­ã®è² è·ãŒæ¸›ã‚‹** - ã€Œã“ã®ã‚±ãƒ¼ã‚¹ã¯ã©ã†æ›¸ãã¹ãã‹ï¼Ÿã€ã«å³ç­”ã§ãã‚‹
2. **ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒæ¥½ã«ãªã‚‹** - ã€Œãƒ«ãƒ¼ãƒ«ã«æ²¿ã£ã¦ã„ã‚‹ã‹ã€ã§åˆ¤æ–­ã§ãã‚‹
3. **ãƒãƒ¼ãƒ ã®å…±é€šè¨€èªãŒã§ãã‚‹** - ã€Œã“ã‚Œã¯Commandã ã‹ã‚‰...ã€ã§é€šã˜ã‚‹

---

## 0.2 ã“ã®æ–‡æ›¸ã§ä½¿ã†ç”¨èªã¨è¨˜æ³•

### ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°åŸºç¤ç”¨èª

| ç”¨èª | æ„å‘³ | ä¾‹ |
|------|------|-----|
| **ã‚¯ãƒ©ã‚¹** | ãƒ‡ãƒ¼ã‚¿ã¨å‡¦ç†ã‚’ã¾ã¨ã‚ãŸè¨­è¨ˆå›³ | `class User { ... }` |
| **ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹** | ã‚¯ãƒ©ã‚¹ã‹ã‚‰ä½œã£ãŸå®Ÿä½“ | `new User()` |
| **ãƒ¡ã‚½ãƒƒãƒ‰** | ã‚¯ãƒ©ã‚¹ã«å±ã™ã‚‹é–¢æ•° | `user.save()` |
| **ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿** | ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä½œæˆæ™‚ã«å‘¼ã°ã‚Œã‚‹ç‰¹åˆ¥ãªãƒ¡ã‚½ãƒƒãƒ‰ | `constructor(name) { ... }` |
| **ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹** | ã€Œã“ã®ãƒ¡ã‚½ãƒƒãƒ‰ã‚’æŒã£ã¦ã„ã‚‹ã“ã¨ã€ã¨ã„ã†å¥‘ç´„ | `interface Savable { save(): void }` |
| **ç¶™æ‰¿** | è¦ªã‚¯ãƒ©ã‚¹ã®æ©Ÿèƒ½ã‚’å­ã‚¯ãƒ©ã‚¹ãŒå¼•ãç¶™ã | `class Dog extends Animal` |

### TypeScript è¨˜æ³•

æœ¬æ–‡æ›¸ã®ã‚³ãƒ¼ãƒ‰ä¾‹ã¯TypeScriptã§è¨˜è¿°ã—ã¦ã„ã¾ã™ï¼š

| è¨˜æ³• | æ„å‘³ | ä¾‹ |
|------|------|-----|
| `readonly` | ä¸€åº¦è¨­å®šã—ãŸã‚‰å¤‰æ›´ã§ããªã„ | `readonly name: string` |
| `async/await` | å®Œäº†ã‚’å¾…ã¤å¿…è¦ãŒã‚ã‚‹å‡¦ç† | `await db.save(user)` |
| `Promise<T>` | ã€Œå¾Œã§TãŒå±Šãã€ã¨ã„ã†ç´„æŸ | `Promise<User>` |
| `T \| E` | Tã¾ãŸã¯Eã®ã©ã¡ã‚‰ã‹ | `string \| null` |
| `interface` | ãƒ¡ã‚½ãƒƒãƒ‰ã®å¥‘ç´„ã‚’å®šç¾© | `interface Repository { ... }` |

### ãƒ†ã‚¹ãƒˆç”¨èª

| ç”¨èª | æ„å‘³ |
|------|------|
| **ãƒ¢ãƒƒã‚¯ï¼ˆMockï¼‰** | ãƒ†ã‚¹ãƒˆç”¨ã®å½ç‰©ã€‚**å‘¼ã³å‡ºã—ã‚’æ¤œè¨¼ã™ã‚‹**ï¼ˆä½•å›å‘¼ã°ã‚ŒãŸã‹ã€ã©ã‚“ãªå¼•æ•°ã‹ï¼‰ |
| **ã‚¹ã‚¿ãƒ–ï¼ˆStubï¼‰** | ãƒ†ã‚¹ãƒˆç”¨ã®å½ç‰©ã€‚**æ±ºã¾ã£ãŸå€¤ã‚’è¿”ã™**ã ã‘ã§ã€å‘¼ã³å‡ºã—ã¯æ¤œè¨¼ã—ãªã„ |
| **ãƒ•ã‚£ã‚¯ã‚¹ãƒãƒ£** | ãƒ†ã‚¹ãƒˆã§ä½¿ã†ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ |
| **InMemoryå®Ÿè£…** | æœ¬ç‰©ã¨åŒã˜ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚’æŒã¤ã€ãƒ¡ãƒ¢ãƒªä¸Šã§å‹•ä½œã™ã‚‹ãƒ†ã‚¹ãƒˆç”¨å®Ÿè£… |

---

## 0.3 OOP ã¨é–¢æ•°å‹ã®åŸºç¤

### ç´”ç²‹é–¢æ•°

**ç´”ç²‹é–¢æ•°**ã¨ã¯ã€ä»¥ä¸‹ã®2ã¤ã‚’æº€ãŸã™é–¢æ•°ã§ã™ï¼š
1. **åŒã˜å…¥åŠ›ã«ã¯å¸¸ã«åŒã˜å‡ºåŠ›** - 10å›å‘¼ã‚“ã§ã‚‚100å›å‘¼ã‚“ã§ã‚‚åŒã˜çµæœ
2. **å‰¯ä½œç”¨ãŒãªã„** - é–¢æ•°ã®å¤–ã®ä¸–ç•Œã«å½±éŸ¿ã‚’ä¸ãˆãªã„

```typescript
// âœ… ç´”ç²‹é–¢æ•°: ä½•åº¦å‘¼ã‚“ã§ã‚‚åŒã˜çµæœ
function add(a: number, b: number): number {
  return a + b;  // add(1, 2) ã¯å¸¸ã« 3
}

// âŒ ç´”ç²‹ã§ãªã„: å‘¼ã¶ãŸã³ã«çµæœãŒå¤‰ã‚ã‚‹
let total = 0;
function addToTotal(amount: number): number {
  total += amount;  // å¤–éƒ¨å¤‰æ•°ã‚’å¤‰æ›´ã—ã¦ã„ã‚‹
  return total;     // 1å›ç›®ã¯100ã€2å›ç›®ã¯200...
}
```

**ãªãœç´”ç²‹é–¢æ•°ãŒè‰¯ã„ã®ã‹:**
- ãƒ†ã‚¹ãƒˆãŒç°¡å˜ï¼ˆå…¥åŠ›ã‚’ä¸ãˆã¦å‡ºåŠ›ã‚’ç¢ºèªã™ã‚‹ã ã‘ï¼‰
- ãƒã‚°ãŒè¦‹ã¤ã‘ã‚„ã™ã„ï¼ˆå…¥åŠ›ã¨å‡ºåŠ›ã ã‘è¦‹ã‚Œã°ã„ã„ï¼‰
- å®‰å…¨ã«å†åˆ©ç”¨ã§ãã‚‹ï¼ˆä»–ã®å ´æ‰€ã«å½±éŸ¿ã—ãªã„ï¼‰

### å‰¯ä½œç”¨

**å‰¯ä½œç”¨**ã¨ã¯ã€é–¢æ•°ã®å¤–éƒ¨ã«å½±éŸ¿ã‚’ä¸ãˆã‚‹ã“ã¨ã§ã™ã€‚

| å‰¯ä½œç”¨ã®ä¾‹ | ãªãœå•é¡Œã‹ |
|-----------|-----------|
| DBã«ä¿å­˜ã™ã‚‹ | é–¢æ•°ã‚’å‘¼ã¶ãŸã³ã«DBã®ä¸­èº«ãŒå¤‰ã‚ã‚‹ |
| ãƒ•ã‚¡ã‚¤ãƒ«ã«æ›¸ãè¾¼ã‚€ | ãƒ•ã‚¡ã‚¤ãƒ«ã®å†…å®¹ãŒå¤‰ã‚ã‚‹ |
| ãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã™ã‚‹ | å–ã‚Šæ¶ˆã›ãªã„æ“ä½œãŒå®Ÿè¡Œã•ã‚Œã‚‹ |
| ç¾åœ¨æ™‚åˆ»ã‚’å–å¾—ã™ã‚‹ | å‘¼ã¶ãŸã³ã«çµæœãŒå¤‰ã‚ã‚‹ |
| ãƒ©ãƒ³ãƒ€ãƒ ãªå€¤ã‚’ç”Ÿæˆã™ã‚‹ | å‘¼ã¶ãŸã³ã«çµæœãŒå¤‰ã‚ã‚‹ |

å‰¯ä½œç”¨ãŒã‚ã‚‹é–¢æ•°ã¯ã€ŒåŒã˜å¼•æ•°ã§å‘¼ã‚“ã§ã‚‚çµæœãŒå¤‰ã‚ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ã€ãŸã‚ã€ãƒ†ã‚¹ãƒˆãŒé›£ã—ããªã‚Šã¾ã™ã€‚

**æœ¬ã‚¹ã‚­ãƒ«ã®ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ:** å‰¯ä½œç”¨ã‚’ã€ŒCommandã€ã¨ã„ã†ã‚«ãƒ†ã‚´ãƒªã«é›†ç´„ã—ã€å‰¯ä½œç”¨ã®ãªã„å‡¦ç†ã‚’ã€ŒQueryã€ã€ŒTransitionã€ã¨ã—ã¦åˆ†é›¢ã™ã‚‹ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ãƒ†ã‚¹ãƒˆã—ã‚„ã™ã„éƒ¨åˆ†ã¨ãƒ†ã‚¹ãƒˆãŒé›£ã—ã„éƒ¨åˆ†ã‚’æ˜ç¢ºã«åˆ†ã‘ã¾ã™ã€‚

### ã‚¤ãƒŸãƒ¥ãƒ¼ã‚¿ãƒ“ãƒªãƒ†ã‚£ï¼ˆä¸å¤‰æ€§ï¼‰

**ã‚¤ãƒŸãƒ¥ãƒ¼ã‚¿ãƒ“ãƒªãƒ†ã‚£**ã¨ã¯ã€ä¸€åº¦ä½œã£ãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å¤‰æ›´ã—ãªã„ã“ã¨ã§ã™ã€‚å¤‰æ›´ãŒå¿…è¦ãªå ´åˆã¯ã€æ–°ã—ã„ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œã£ã¦è¿”ã—ã¾ã™ã€‚

```typescript
// âŒ ãƒŸãƒ¥ãƒ¼ã‚¿ãƒ–ãƒ«ï¼ˆå¤‰æ›´å¯èƒ½ï¼‰: ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆè‡ªä½“ã‚’å¤‰æ›´
class User {
  age: number;
  birthday() {
    this.age++;  // è‡ªåˆ†è‡ªèº«ã‚’å¤‰æ›´
  }
}

// âœ… ã‚¤ãƒŸãƒ¥ãƒ¼ã‚¿ãƒ–ãƒ«ï¼ˆä¸å¤‰ï¼‰: æ–°ã—ã„ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’è¿”ã™
class User {
  constructor(readonly name: string, readonly age: number) {}
  
  birthday(): User {
    return new User(this.name, this.age + 1);  // æ–°ã—ã„ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’è¿”ã™
  }
}
```

**ãªãœã‚¤ãƒŸãƒ¥ãƒ¼ã‚¿ãƒ–ãƒ«ãŒè‰¯ã„ã®ã‹:**
- ã€Œã„ã¤å¤‰ã‚ã£ãŸã‹ã€ã‚’è¿½è·¡ã—ãªãã¦ã„ã„
- è¤‡æ•°ã®å ´æ‰€ã§å…±æœ‰ã—ã¦ã‚‚å®‰å…¨
- ãƒã‚°ã®åŸå› ã‚’ç‰¹å®šã—ã‚„ã™ã„

**ãªãœãƒŸãƒ¥ãƒ¼ã‚¿ãƒ–ãƒ«ã‚’é¿ã‘ã‚‹ã®ã‹:**
- ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆAã‚’é–¢æ•°ã«æ¸¡ã—ãŸã‚‰ã€ä¸­ã§å¤‰æ›´ã•ã‚Œã¦ã„ãŸã€ã¨ã„ã†ãƒã‚°ãŒèµ·ãã‚‹
- ã€Œã“ã®å€¤ã¯ã„ã¤å¤‰ã‚ã£ãŸï¼Ÿã€ãŒåˆ†ã‹ã‚‰ãªããªã‚‹

---

## 0.4 æœ¬ã‚¹ã‚­ãƒ«ã®å“²å­¦

### OOPä¸»è»¸ + é–¢æ•°å‹ã®è‰¯ã„ã¨ã“å–ã‚Š

æœ¬ã‚¹ã‚­ãƒ«ã¯ã€ç´”ç²‹ãªã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆæŒ‡å‘ã§ã‚‚ç´”ç²‹ãªé–¢æ•°å‹ã§ã‚‚ã‚ã‚Šã¾ã›ã‚“ã€‚ä¸¡æ–¹ã®è‰¯ã„ã¨ã“ã‚ã‚’å–ã‚Šå…¥ã‚Œã¦ã„ã¾ã™ï¼š

| å–ã‚Šå…¥ã‚ŒãŸæ¦‚å¿µ | å‡ºå…¸ | èª¬æ˜ | ãªãœå–ã‚Šå…¥ã‚ŒãŸã‹ |
|--------------|------|------|----------------|
| ã‚¯ãƒ©ã‚¹ | OOP | ãƒ‡ãƒ¼ã‚¿ã¨æŒ¯ã‚‹èˆã„ã‚’ã¾ã¨ã‚ã‚‹ | è²¬å‹™ã‚’æ˜ç¢ºã«ã§ãã‚‹ |
| ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ | OOP | å®Ÿè£…ã‚’å·®ã—æ›¿ãˆå¯èƒ½ã«ã™ã‚‹ | ãƒ†ã‚¹ãƒˆã—ã‚„ã™ããªã‚‹ |
| ç´”ç²‹é–¢æ•° | é–¢æ•°å‹ | å‰¯ä½œç”¨ã®ãªã„è¨ˆç®— | ãƒ†ã‚¹ãƒˆãŒç°¡å˜ã«ãªã‚‹ |
| ã‚¤ãƒŸãƒ¥ãƒ¼ã‚¿ãƒ“ãƒªãƒ†ã‚£ | é–¢æ•°å‹ | ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å¤‰æ›´ã—ãªã„ | ãƒã‚°ãŒæ¸›ã‚‹ |
| Resultå‹ | é–¢æ•°å‹ | æˆåŠŸ/å¤±æ•—ã‚’å‹ã§è¡¨ç¾ | ã‚¨ãƒ©ãƒ¼å‡¦ç†ãŒæ˜ç¢ºã«ãªã‚‹ |

**å–ã‚Šå…¥ã‚Œãªã‹ã£ãŸã‚‚ã®:**
| æ¦‚å¿µ | ãªãœå–ã‚Šå…¥ã‚Œãªã‹ã£ãŸã‹ |
|------|---------------------|
| ç¶™æ‰¿ | è¦ªã‚¯ãƒ©ã‚¹ã‚’å¤‰æ›´ã™ã‚‹ã¨å­ã‚¯ãƒ©ã‚¹ãŒå£Šã‚Œã‚„ã™ã„ |
| ãƒ¢ãƒŠãƒ‰å¤‰æ›å­ | å­¦ç¿’ã‚³ã‚¹ãƒˆãŒé«˜ã™ãã‚‹ |
| é«˜åº¦ãªå‹ãƒ¬ãƒ™ãƒ«ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚° | ãƒãƒ¼ãƒ å…¨å“¡ãŒç†è§£ã§ãã‚‹ç¯„å›²ã«ç•™ã‚ã‚‹ |

### ãƒ«ãƒ¼ãƒ«ã®å„ªå…ˆé †ä½

```
1. è¨€èª/ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã®æ§‹æ–‡åˆ¶ç´„ï¼ˆå¤‰ãˆã‚‰ã‚Œãªã„ï¼‰
2. æœ¬ã‚¹ã‚­ãƒ«ã®ãƒ«ãƒ¼ãƒ«ï¼ˆåŸå‰‡å¾“ã†ï¼‰
3. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå›ºæœ‰ã®ãƒ«ãƒ¼ãƒ«ï¼ˆãƒãƒ¼ãƒ åˆæ„ï¼‰
4. å€‹äººã®å¥½ã¿ï¼ˆæœ€ã‚‚ä½ã„ï¼‰
```

ä¾‹ï¼šNestJSã§ã¯ã€ŒDIã‚³ãƒ³ãƒ†ãƒŠã€ã¨ã„ã†ä»•çµ„ã¿ã§Repositoryã‚’æ³¨å…¥ã™ã‚‹ã®ãŒæ¨™æº–ã§ã™ã€‚æœ¬ã‚¹ã‚­ãƒ«ã§ã¯ã€Œãƒ¡ã‚½ãƒƒãƒ‰å¼•æ•°ã§å—ã‘å–ã‚‹ã€ãŒåŸå‰‡ã§ã™ãŒã€NestJSã‚’ä½¿ã†å ´åˆã¯ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã®æµå„€ã«å¾“ã„ã¾ã™ã€‚

---

> **ğŸ’¡ ç†è«–çš„èƒŒæ™¯ã«ã¤ã„ã¦**
> 
> æœ¬ã‚¹ã‚­ãƒ«ã®ãƒ«ãƒ¼ãƒ«ã¯ã€50å¹´ä»¥ä¸Šã®è¨­è¨ˆç ”ç©¶ã«åŸºã¥ã„ã¦ã„ã¾ã™ã€‚
> ã€Œãªãœã“ã®ãƒ«ãƒ¼ãƒ«ãªã®ã‹ã€ã®ç†è«–çš„æ ¹æ‹ ï¼ˆå‡é›†åº¦/çµåˆåº¦ã€SOLIDåŸå‰‡ã€Code Smellsï¼‰ã¯
> **[Part A: ç†è«–çš„èƒŒæ™¯](#part-a-ç†è«–çš„èƒŒæ™¯--ãªãœã“ã‚Œã‚‰ã®ãƒ«ãƒ¼ãƒ«ãªã®ã‹)** ã§è§£èª¬ã—ã¦ã„ã¾ã™ã€‚
> 
> ã¾ãšã¯ãƒ«ãƒ¼ãƒ«ã‚’å­¦ã³ã€ã€Œãªãœï¼Ÿã€ãŒæ°—ã«ãªã£ãŸã‚‰Part Aã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

---

# Part 1: 4åˆ†é¡ï¼ˆCommand / Transition / Query / ReadModelï¼‰

## 1.1 ãªãœåˆ†é¡ãŒå¿…è¦ã‹

### å•é¡Œ: ã€Œä½•ã§ã‚‚ã§ãã‚‹ã‚¯ãƒ©ã‚¹ã€

å¤šãã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã¯ã€ã“ã‚“ãªã‚¯ãƒ©ã‚¹ã‚’è¦‹ã‹ã‘ã¾ã™ï¼š

```typescript
// âŒ å…¸å‹çš„ãªã€Œä½•ã§ã‚‚ã§ãã‚‹ã€ã‚¯ãƒ©ã‚¹
class OrderService {
  async processOrder(orderId: string, userId: string): Promise<Order> {
    // 1. DBã‹ã‚‰èª­ã¿å–ã‚Š
    const order = await this.db.query('SELECT * FROM orders WHERE id = ?', [orderId]);
    
    // 2. æ¨©é™ãƒã‚§ãƒƒã‚¯ï¼ˆè¨ˆç®—ï¼‰
    const user = await this.db.query('SELECT * FROM users WHERE id = ?', [userId]);
    if (user.role !== 'admin' && order.userId !== userId) {
      throw new Error('æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“');
    }
    
    // 3. åœ¨åº«ãƒã‚§ãƒƒã‚¯ï¼ˆå¤–éƒ¨APIå‘¼ã³å‡ºã—ï¼‰
    const stock = await this.inventoryApi.getStock(order.productId);
    if (stock < order.quantity) {
      throw new Error('åœ¨åº«ä¸è¶³');
    }
    
    // 4. æ±ºæ¸ˆï¼ˆå¤–éƒ¨ã¸ã®æ›¸ãè¾¼ã¿ï¼‰
    await this.paymentGateway.charge(order.amount, order.paymentMethod);
    
    // 5. DBæ›´æ–°ï¼ˆæ›¸ãè¾¼ã¿ï¼‰
    await this.db.execute('UPDATE orders SET status = ? WHERE id = ?', ['paid', orderId]);
    
    // 6. ãƒ¡ãƒ¼ãƒ«é€ä¿¡ï¼ˆå¤–éƒ¨ã¸ã®æ›¸ãè¾¼ã¿ï¼‰
    await this.emailService.send(user.email, 'æ³¨æ–‡ç¢ºå®š', '...');
    
    return order;
  }
}
```

**ã“ã®ã‚³ãƒ¼ãƒ‰ã®å•é¡Œç‚¹:**

| å•é¡Œ | å…·ä½“çš„ã«ä½•ãŒå›°ã‚‹ã‹ |
|------|------------------|
| **ãƒ†ã‚¹ãƒˆå›°é›£** | DBã€å¤–éƒ¨APIã€æ±ºæ¸ˆã€ãƒ¡ãƒ¼ãƒ«ã®4ã¤ã‚’ãƒ¢ãƒƒã‚¯ã—ãªã„ã¨ãƒ†ã‚¹ãƒˆã§ããªã„ |
| **è²¬å‹™ä¸æ˜ç¢º** | ã€Œåœ¨åº«ãƒ­ã‚¸ãƒƒã‚¯ã‚’å¤‰ãˆãŸã„ã€â†’ã©ã“ã‚’å¤‰ãˆã‚‹ï¼Ÿå…¨ä½“ã‚’èª­ã¾ãªã„ã¨åˆ†ã‹ã‚‰ãªã„ |
| **å†åˆ©ç”¨ä¸å¯èƒ½** | ã€Œåœ¨åº«ãƒã‚§ãƒƒã‚¯ã ã‘ä½¿ã„ãŸã„ã€â†’ã§ããªã„ã€ã‚³ãƒ”ãƒšã™ã‚‹ã—ã‹ãªã„ |
| **å¤‰æ›´ãŒæ€–ã„** | 1è¡Œå¤‰ãˆãŸã‚‰ä½•ãŒå£Šã‚Œã‚‹ã‹åˆ†ã‹ã‚‰ãªã„ |

### ãªãœã€Œåˆ†é¡ã€ã§è§£æ±ºã§ãã‚‹ã®ã‹

å•é¡Œã®æ ¹æœ¬åŸå› ã¯ã€Œå‰¯ä½œç”¨ã®ã‚ã‚‹å‡¦ç†ã€ã¨ã€Œå‰¯ä½œç”¨ã®ãªã„å‡¦ç†ã€ãŒæ··åœ¨ã—ã¦ã„ã‚‹ã“ã¨ã§ã™ã€‚

ã“ã‚Œã‚’åˆ†é¡ã—ã¦åˆ†é›¢ã™ã‚‹ã¨ï¼š
- å‰¯ä½œç”¨ã®ãªã„éƒ¨åˆ†ï¼ˆè¨ˆç®—ï¼‰â†’ ãƒ†ã‚¹ãƒˆãŒç°¡å˜
- å‰¯ä½œç”¨ã®ã‚ã‚‹éƒ¨åˆ†ï¼ˆDBæ“ä½œç­‰ï¼‰â†’ ãƒ¢ãƒƒã‚¯ãŒå¿…è¦ã ãŒã€ç¯„å›²ãŒé™å®šã•ã‚Œã‚‹

### è§£æ±º: 4åˆ†é¡

| åˆ†é¡ | å®šç¾© | çŠ¶æ…‹å¤‰æ›´ | å¤–éƒ¨ãƒªã‚½ãƒ¼ã‚¹ | ãƒ†ã‚¹ãƒˆã®ã—ã‚„ã™ã• |
|------|------|:------:|:------:|:------:|
| **Command** | æ°¸ç¶šçŠ¶æ…‹ã‚’å¤‰æ›´ã€å¤–éƒ¨ã«ä½œç”¨ | ã‚ã‚Š | ãƒ¡ã‚½ãƒƒãƒ‰å¼•æ•° | â–³ ãƒ¢ãƒƒã‚¯å¿…è¦ |
| **Transition** | å‹ A â†’ å‹ B ã¸ã®å¤‰æ› | ãªã— | ãªã— | â— ãƒ¢ãƒƒã‚¯ä¸è¦ |
| **Query** | å€¤ã®è¨ˆç®—ãƒ»å°å‡º | ãªã— | ãªã— | â— ãƒ¢ãƒƒã‚¯ä¸è¦ |
| **ReadModel** | èª­ã¿å–ã‚Šå°‚ç”¨ã§ãƒ‡ãƒ¼ã‚¿å–å¾— | ãªã— | ãƒ¡ã‚½ãƒƒãƒ‰å¼•æ•° | â–³ ãƒ¢ãƒƒã‚¯å¿…è¦ |

**ãªãœ4ã¤ãªã®ã‹ï¼ˆ3ã¤ã§ã‚‚5ã¤ã§ã‚‚ãªãï¼‰:**

| åˆ†é¡æ•° | å•é¡Œ |
|--------|------|
| 2ã¤ï¼ˆCQS: Command/Queryï¼‰ | ã€ŒDBã‹ã‚‰èª­ã‚€ã€ã¨ã€Œè¨ˆç®—ã™ã‚‹ã€ãŒåŒºåˆ¥ã§ããªã„ |
| 3ã¤ï¼ˆCommand/Query/ReadModelï¼‰ | ã€Œãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã€ã¨ã€Œè¨ˆç®—ã€ãŒåŒºåˆ¥ã§ããªã„ |
| **4ã¤ï¼ˆæœ¬ã‚¹ã‚­ãƒ«ï¼‰** | å‰¯ä½œç”¨ã®æœ‰ç„¡ Ã— èª­ã¿æ›¸ãã®çµ„ã¿åˆã‚ã›ã‚’ç¶²ç¾… |
| 5ã¤ä»¥ä¸Š | è¤‡é›‘ã™ãã¦åˆ¤æ–­ãŒé›£ã—ã„ |

### åˆ¤æ–­ãƒ•ãƒ­ãƒ¼

```
ã“ã®ã‚¯ãƒ©ã‚¹ã¯...
â”œâ”€ æ°¸ç¶šåŒ–/å¤–éƒ¨é€šä¿¡ã‚’è¡Œã†ï¼Ÿ
â”‚   â”œâ”€ YES + æ›¸ãè¾¼ã¿ â†’ Command
â”‚   â”‚   ä¾‹: ç¨Ÿè­°ã‚’ç”³è«‹ã™ã‚‹ã€æ³¨æ–‡ã‚’ç¢ºå®šã™ã‚‹
â”‚   â””â”€ YES + èª­ã¿å–ã‚Šã®ã¿ â†’ ReadModel
â”‚       ä¾‹: æ‰¿èªå¾…ã¡ç¨Ÿè­°ã®ä¸€è¦§ã‚’å–å¾—ã™ã‚‹
â””â”€ NOï¼ˆç´”ç²‹ãªè¨ˆç®—ã ã‘ï¼‰
    â”œâ”€ å…¥åŠ›å‹ã¨å‡ºåŠ›å‹ãŒç•°ãªã‚‹ï¼Ÿ â†’ Transition
    â”‚   ä¾‹: ã€Œæœªæ¤œè¨¼ã®å…¥åŠ›ã€â†’ã€Œæ¤œè¨¼æ¸ˆã¿ã®å…¥åŠ›ã€
    â””â”€ åŒã˜æ¦‚å¿µã®è¨ˆç®—ï¼Ÿ â†’ Query
        ä¾‹: ã€Œä¾¡æ ¼ã€ã¨ã€Œç¨ç‡ã€â†’ã€Œç¨é¡ã€ã‚’è¨ˆç®—
```

---

## 1.2 ä»£æ›¿ã‚¢ãƒ—ãƒ­ãƒ¼ãƒæ¯”è¼ƒ

| ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ | èª¬æ˜ | é•·æ‰€ | çŸ­æ‰€ | æ¡ç”¨ |
|-----------|------|------|------|:----:|
| **æœ¬ã‚¹ã‚­ãƒ«: 4åˆ†é¡** | Command/Transition/Query/ReadModel | è²¬å‹™æ˜ç¢ºã€ãƒ†ã‚¹ãƒˆå®¹æ˜“ | å­¦ç¿’ã‚³ã‚¹ãƒˆ | âœ… |
| **CQSï¼ˆ2åˆ†é¡ï¼‰** | æ›¸ãè¾¼ã¿(Command)ã¨èª­ã¿å–ã‚Š(Query)ã ã‘åˆ†ã‘ã‚‹ | ã‚·ãƒ³ãƒ—ãƒ« | ã€ŒDBèª­ã¿å–ã‚Šã€ã¨ã€Œè¨ˆç®—ã€ã®åŒºåˆ¥ãªã— | â–³ |
| **ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£** | UseCase/Entity/Gatewayç­‰ã®å±¤ã§åˆ†ã‘ã‚‹ | å±¤ã®åˆ†é›¢ãŒæ˜ç¢º | å°è¦æ¨¡ã«ã¯éå‰°ã€ãƒ•ã‚¡ã‚¤ãƒ«æ•°ãŒå¤šã„ | â–³ |
| **åˆ†é¡ãªã—** | è‡ªç”±ã«è¨­è¨ˆ | æŸ”è»Ÿ | ä¸€è²«æ€§ãªã—ã€ãƒ¬ãƒ“ãƒ¥ãƒ¼å›°é›£ | âŒ |

**ãªãœCQSã§ã¯ä¸ååˆ†ã‹:**

CQSï¼ˆCommand Query Separationï¼‰ã¯ã€Œæ›¸ãè¾¼ã¿ã€ã¨ã€Œèª­ã¿å–ã‚Šã€ã‚’åˆ†ã‘ã‚‹å¤å…¸çš„ãªè€ƒãˆæ–¹ã§ã™ã€‚ã—ã‹ã—ï¼š

```typescript
// CQSã§ã¯ä¸¡æ–¹ã€ŒQueryã€ã«ãªã‚‹ãŒ...
class TaxCalculator {
  calculate(price: number, rate: number): number {
    return price * rate;  // ç´”ç²‹ãªè¨ˆç®— â†’ ãƒ¢ãƒƒã‚¯ä¸è¦ã§ãƒ†ã‚¹ãƒˆå¯èƒ½
  }
}

class OrderFinder {
  async findById(id: string): Promise<Order> {
    return this.db.query(...);  // DBèª­ã¿å–ã‚Š â†’ DBã®ãƒ¢ãƒƒã‚¯ãŒå¿…è¦
  }
}
```

ãƒ†ã‚¹ãƒˆæ–¹æ³•ãŒå…¨ãç•°ãªã‚‹ã®ã«åŒã˜ã€ŒQueryã€æ‰±ã„ã§ã¯ã€ã©ã“ãŒãƒ†ã‚¹ãƒˆã—ã‚„ã™ãã¦ã©ã“ãŒé›£ã—ã„ã‹åˆ†ã‹ã‚Šã¾ã›ã‚“ã€‚æœ¬ã‚¹ã‚­ãƒ«ã§ã¯å‰è€…ã‚’Queryã€å¾Œè€…ã‚’ReadModelã¨åŒºåˆ¥ã—ã¾ã™ã€‚

---

## 1.3 Command

**Command**ã¯ã€æ°¸ç¶šçŠ¶æ…‹ã‚’å¤‰æ›´ã™ã‚‹ã€ã¾ãŸã¯å¤–éƒ¨ã‚·ã‚¹ãƒ†ãƒ ã«ä½œç”¨ã™ã‚‹ã‚¯ãƒ©ã‚¹ã§ã™ã€‚

**ä¾‹:** ç¨Ÿè­°ã‚’ç”³è«‹ã™ã‚‹ã€æ³¨æ–‡ã‚’ç¢ºå®šã™ã‚‹ã€ãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã™ã‚‹

### Pending Object Pattern

ã€ŒçŠ¶æ…‹é·ç§»ã€ã‚’ã€Œå‹ã€ã§è¡¨ç¾ã™ã‚‹ãƒ‘ã‚¿ãƒ¼ãƒ³ã§ã™ã€‚

```typescript
// ã€Œä¸‹æ›¸ãç¨Ÿè­°ã€â†’ã€Œç”³è«‹æ¸ˆã¿ç¨Ÿè­°ã€ã¨ã„ã†çŠ¶æ…‹é·ç§»ã‚’å‹ã§è¡¨ç¾
class DraftRingi {
  async submit(repository: RingiRepository): Promise<SubmittedRingi> {
    const submitted = new SubmittedRingi(this.id, this.data);
    await repository.save(submitted);
    return submitted;
  }
}

class SubmittedRingi {
  async approve(repository: RingiRepository): Promise<ApprovedRingi> {
    // ...
  }
}
```

### ãªãœ Pending Object Pattern ãªã®ã‹ â€” 4ã¤ã®ä»£æ›¿æ¡ˆã¨ã®æ¯”è¼ƒ

çŠ¶æ…‹é·ç§»ã‚’ã©ã†è¡¨ç¾ã™ã‚‹ã‹ã€‚ã“ã‚Œã«ã¯4ã¤ã®æ–¹æ³•ãŒã‚ã‚Šã¾ã™ï¼š

| æ–¹æ³• | æ¦‚è¦ | æ¡ç”¨ |
|------|------|:----:|
| **â‘  å˜ä¸€ã‚¯ãƒ©ã‚¹ + status ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰** | `ringi.status = 'submitted'` ã§çŠ¶æ…‹å¤‰æ›´ | âŒ |
| **â‘¡ State Machine ãƒ©ã‚¤ãƒ–ãƒ©ãƒª** | XStateç­‰ã§çŠ¶æ…‹é·ç§»ã‚’å®šç¾© | âŒ |
| **â‘¢ Event Sourcing** | ã‚¤ãƒ™ãƒ³ãƒˆã®åˆ—ã¨ã—ã¦çŠ¶æ…‹ã‚’è¡¨ç¾ | âŒ |
| **â‘£ Pending Object Pattern** | çŠ¶æ…‹ã”ã¨ã«åˆ¥ã‚¯ãƒ©ã‚¹ï¼ˆ`DraftRingi` â†’ `SubmittedRingi`ï¼‰ | âœ… |

---

#### âŒ æ¡ˆâ‘  å˜ä¸€ã‚¯ãƒ©ã‚¹ + status ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’æ¡ç”¨ã—ãªã‹ã£ãŸç†ç”±

```typescript
// å˜ä¸€ã‚¯ãƒ©ã‚¹æ–¹å¼
class Ringi {
  status: 'draft' | 'submitted' | 'approved' | 'rejected';
  submittedAt?: Date;
  approvedAt?: Date;
  approvedBy?: EmployeeId;
  rejectedAt?: Date;
  rejectedReason?: string;
  
  submit() {
    if (this.status !== 'draft') throw new Error('Invalid state');
    this.status = 'submitted';
    this.submittedAt = new Date();
  }
  
  approve(approver: EmployeeId) {
    if (this.status !== 'submitted') throw new Error('Invalid state');
    this.status = 'approved';
    this.approvedAt = new Date();
    this.approvedBy = approver;
  }
}
```

**å•é¡Œ1: ä¸æ­£ãªçŠ¶æ…‹ãŒã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã‚’é€šã‚‹**

```typescript
// âŒ å‹ã‚·ã‚¹ãƒ†ãƒ ãŒå®ˆã£ã¦ãã‚Œãªã„
const ringi = new Ringi();
ringi.status = 'approved';
ringi.approvedAt = undefined;  // æ‰¿èªæ¸ˆã¿ãªã®ã« approvedAt ãŒãªã„ï¼
// â†’ ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã‚¨ãƒ©ãƒ¼ã«ãªã‚‰ãªã„ã€‚å®Ÿè¡Œæ™‚ã«åˆã‚ã¦æ°—ã¥ã
```

**å•é¡Œ2: nullable åœ°ç„**

```typescript
// âŒ ã€Œã“ã®çŠ¶æ…‹ã§ã¯nullã®ã¯ãšã€ã‚’å…¨éƒ¨è¦šãˆã¦ã„ãªã„ã¨ã„ã‘ãªã„
if (ringi.status === 'approved') {
  console.log(ringi.approvedAt!);  // ! ãŒå¿…è¦ã€‚æœ¬å½“ã«å­˜åœ¨ã™ã‚‹ï¼Ÿ
  console.log(ringi.approvedBy!);  // ! ãŒå¿…è¦ã€‚æœ¬å½“ã«å­˜åœ¨ã™ã‚‹ï¼Ÿ
  console.log(ringi.rejectedReason);  // ã“ã‚Œã¯nullã®ã¯ãš...ãŸã¶ã‚“...
}
```

**å•é¡Œ3: switchã®å¢—æ®–**

```typescript
// âŒ çŠ¶æ…‹ãŒå¢—ãˆã‚‹ãŸã³ã«å…¨switchã‚’ä¿®æ­£
function getRingiLabel(ringi: Ringi): string {
  switch (ringi.status) {
    case 'draft': return 'ä¸‹æ›¸ã';
    case 'submitted': return 'ç”³è«‹ä¸­';
    case 'approved': return 'æ‰¿èªæ¸ˆ';
    case 'rejected': return 'å´ä¸‹';
    // æ–°ã—ã„çŠ¶æ…‹ 'pending_resubmit' ã‚’è¿½åŠ  â†’ ã“ã®switchå¿˜ã‚Œã¦æœ¬ç•ªã§ã‚¯ãƒ©ãƒƒã‚·ãƒ¥
  }
}
```

**å‡ºå…¸: bloc library (Flutter) ã®å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ**
> "Concrete Class and Status Enum: Not Type Safe. Possible to emit a malformed state, leading to bugs."

---

#### âŒ æ¡ˆâ‘¡ State Machine ãƒ©ã‚¤ãƒ–ãƒ©ãƒªï¼ˆXStateç­‰ï¼‰ã‚’æ¡ç”¨ã—ãªã‹ã£ãŸç†ç”±

```typescript
// XState ã§ã®çŠ¶æ…‹é·ç§»å®šç¾©
const ringiMachine = createMachine({
  id: 'ringi',
  initial: 'draft',
  states: {
    draft: {
      on: { SUBMIT: 'submitted' }
    },
    submitted: {
      on: { APPROVE: 'approved', REJECT: 'rejected' }
    },
    approved: { type: 'final' },
    rejected: { type: 'final' }
  }
});
```

**å•é¡Œ1: å­¦ç¿’ã‚³ã‚¹ãƒˆãŒé«˜ã„**

XState ã¯å¼·åŠ›ã ãŒã€ãƒãƒ¼ãƒ å…¨å“¡ãŒç¿’å¾—ã™ã‚‹ã«ã¯æ™‚é–“ãŒã‹ã‹ã‚‹ã€‚

**å‡ºå…¸: Mediumè¨˜äº‹ "Don't use XState (at least, not with React)"**
> "XState actively works against React's natural data flow, leading to confusing code."

**å•é¡Œ2: å˜ç´”ãªã‚±ãƒ¼ã‚¹ã«ã¯éå‰°**

```typescript
// âŒ 4çŠ¶æ…‹ã®ç¨Ÿè­°ãƒ•ãƒ­ãƒ¼ã«ã“ã‚Œã¯å¤§ã’ã•
const ringiMachine = createMachine({
  // 50è¡Œã®è¨­å®š...
});

// âœ… 4ã¤ã®ã‚¯ãƒ©ã‚¹ã§ååˆ†
class DraftRingi { }
class SubmittedRingi { }
class ApprovedRingi { }
class RejectedRingi { }
```

**å‡ºå…¸: GitHub Discussion "Need suggestions on migrating away from XState"**
> "XState is way too sophisticated for our relatively simple customer onboarding application. The complexity is not justified."

**å•é¡Œ3: ãƒ‡ãƒãƒƒã‚°ãŒè¤‡é›‘**

çŠ¶æ…‹é·ç§»å›³ã¯ç¾ã—ã„ãŒã€å®Ÿéš›ã«ã©ã®ã‚¤ãƒ™ãƒ³ãƒˆã§ã©ã†é·ç§»ã—ãŸã‹ã‚’è¿½è·¡ã™ã‚‹ã®ãŒé›£ã—ã„ã€‚

**ã„ã¤XStateã‚’æ¤œè¨ã™ã¹ãã‹:**
- çŠ¶æ…‹ãŒ10å€‹ä»¥ä¸Šã‚ã‚‹
- çŠ¶æ…‹é·ç§»ãŒè¤‡é›‘ãªåˆ†å²ã‚’æŒã¤ï¼ˆæ¡ä»¶ä»˜ãé·ç§»ã€ã‚¬ãƒ¼ãƒ‰æ¡ä»¶å¤šæ•°ï¼‰
- UIã®çŠ¶æ…‹ç®¡ç†ï¼ˆloading, error, success, retrying, ...ï¼‰

---

#### âŒ æ¡ˆâ‘¢ Event Sourcing ã‚’æ¡ç”¨ã—ãªã‹ã£ãŸç†ç”±

```typescript
// Event Sourcing æ–¹å¼
interface RingiEvent {
  type: 'Created' | 'Submitted' | 'Approved' | 'Rejected';
  timestamp: Date;
  payload: unknown;
}

class Ringi {
  private events: RingiEvent[] = [];
  
  submit() {
    this.events.push({ type: 'Submitted', timestamp: new Date(), payload: {} });
  }
  
  // ç¾åœ¨ã®çŠ¶æ…‹ã¯ events ã‚’å†ç”Ÿã—ã¦è¨ˆç®—
  get status(): string {
    return this.events.reduce((state, event) => {
      switch (event.type) {
        case 'Submitted': return 'submitted';
        case 'Approved': return 'approved';
        // ...
      }
    }, 'draft');
  }
}
```

**å•é¡Œ1: ã€Œæœ¬ã§èª­ã‚“ã ã‚‰å®Œç’§ã«è¦‹ãˆãŸã€‚æœ¬ç•ªã¯æ‚ªå¤¢ã ã£ãŸã€**

**å‡ºå…¸: Mediumè¨˜äº‹ "Event Sourcing Looked Perfect in the Book. Production Was a Nightmare."**
> "Initial appeal of immutable events, audit trails, and CQRS quickly dissolved into distributed debugging hell."

**å•é¡Œ2: Eventual Consistency ãƒã‚°**

```typescript
// âŒ ã‚ˆãã‚ã‚‹ãƒã‚°ï¼šæ³¨æ–‡ç›´å¾Œã«ç¢ºèªç”»é¢ã§ã€Œæ³¨æ–‡ãŒã‚ã‚Šã¾ã›ã‚“ã€
// ç†ç”±ï¼šRead Model ãŒ Event Store ã«è¿½ã„ã¤ã„ã¦ã„ãªã„

async function submitOrder(order: Order) {
  await eventStore.append(new OrderSubmittedEvent(order));
  // â†‘ ã‚¤ãƒ™ãƒ³ãƒˆä¿å­˜å®Œäº†
  
  // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
  redirect('/orders/' + order.id);
  // â†“ ã—ã‹ã— Read Model ã¯ã¾ã æ›´æ–°ã•ã‚Œã¦ã„ãªã„ï¼
}
```

**å•é¡Œ3: ãƒ‡ãƒãƒƒã‚°ãŒè€ƒå¤å­¦ã«ãªã‚‹**

ã€Œãªãœã“ã®ç¨Ÿè­°ãŒå´ä¸‹ã•ã‚ŒãŸã‹ã€ã‚’èª¿ã¹ã‚‹ãŸã‚ã«ã€ã‚¤ãƒ™ãƒ³ãƒˆ100ä¸‡ä»¶ã‚’å†ç”Ÿã™ã‚‹ã“ã¨ã«ãªã‚‹ã€‚

**å•é¡Œ4: ã‚¹ã‚­ãƒ¼ãƒå¤‰æ›´ãŒæ°¸é ã«æ®‹ã‚‹**

ã‚¤ãƒ™ãƒ³ãƒˆã¯ä¸å¤‰ã€‚ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’è¿½åŠ ã—ãŸã‚‰ã€éå»ã‚¤ãƒ™ãƒ³ãƒˆã¨ã®äº’æ›æ€§ã‚³ãƒ¼ãƒ‰ãŒæ°¸é ã«å¿…è¦ã€‚

```typescript
// âŒ 2å¹´å‰ã®ã‚¤ãƒ™ãƒ³ãƒˆã¨ã®äº’æ›æ€§ã‚³ãƒ¼ãƒ‰
function handleSubmittedEvent(event: SubmittedEvent) {
  // v1: applicantId ãŒ string ã ã£ãŸ
  // v2: applicantId ã‚’ EmployeeId ã«å¤‰æ›´
  // v3: applicantId ã‚’å»ƒæ­¢ã€applicant ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«å¤‰æ›´
  const applicant = event.version === 1 
    ? EmployeeId.fromString(event.applicantId as string)
    : event.version === 2
    ? event.applicantId
    : event.applicant.id;
  // ã“ã®ã‚³ãƒ¼ãƒ‰ã¯æ°¸é ã«æ¶ˆã›ãªã„
}
```

**å•é¡Œ5: ã‚¤ãƒ³ãƒ•ãƒ©ã‚³ã‚¹ãƒˆãŒ4å€**

Event Store + è¤‡æ•° Read Model + Message Queue = é€šå¸¸ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã®4å€ã®ã‚³ã‚¹ãƒˆã€‚

**ã„ã¤ Event Sourcing ã‚’æ¤œè¨ã™ã¹ãã‹:**
- ç›£æŸ»ãƒ­ã‚°ãŒæ³•çš„è¦ä»¶ã¨ã—ã¦å¿…é ˆ
- ã€Œä»»æ„ã®éå»æ™‚ç‚¹ã®çŠ¶æ…‹ã‚’å†ç¾ã€ãŒå¿…è¦
- é‡‘èãƒ»åŒ»ç™‚ãªã©ã€å¤‰æ›´å±¥æ­´ã®å®Œå…¨æ€§ãŒæœ€é‡è¦

---

#### âœ… æ¡ˆâ‘£ Pending Object Pattern ã‚’æ¡ç”¨ã—ãŸç†ç”±

```typescript
class DraftRingi {
  constructor(readonly id: RingiId, readonly data: RingiData) {}
  
  async submit(repository: RingiRepository): Promise<SubmittedRingi> {
    const submitted = new SubmittedRingi(this.id, this.data, new Date());
    await repository.save(submitted);
    return submitted;
  }
  
  // approve() ãƒ¡ã‚½ãƒƒãƒ‰ã¯å­˜åœ¨ã—ãªã„ï¼
  // â†’ ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã‚¨ãƒ©ãƒ¼ã§ä¸æ­£ãªé·ç§»ã‚’é˜²ã
}

class SubmittedRingi {
  constructor(
    readonly id: RingiId,
    readonly data: RingiData,
    readonly submittedAt: Date  // å¿…é ˆï¼nullã«ãªã‚‰ãªã„
  ) {}
  
  async approve(repository: RingiRepository, approver: Employee): Promise<ApprovedRingi> {
    // ...
  }
  
  // submit() ãƒ¡ã‚½ãƒƒãƒ‰ã¯å­˜åœ¨ã—ãªã„ï¼
}

class ApprovedRingi {
  constructor(
    readonly id: RingiId,
    readonly data: RingiData,
    readonly submittedAt: Date,
    readonly approvedAt: Date,      // å¿…é ˆï¼
    readonly approvedBy: EmployeeId // å¿…é ˆï¼
  ) {}
  
  // submit() ã‚‚ approve() ã‚‚å­˜åœ¨ã—ãªã„ï¼
}
```

| ãƒ¡ãƒªãƒƒãƒˆ | èª¬æ˜ |
|---------|------|
| **ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«æ™‚ã«ä¸æ­£é·ç§»ã‚’æ¤œå‡º** | `DraftRingi` ã« `approve()` ãŒãªã„ã®ã§ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã‚¨ãƒ©ãƒ¼ |
| **nullable ãŒãªã„** | `ApprovedRingi.approvedAt` ã¯å¿…é ˆã€‚`?` ã‚‚ `!` ã‚‚ä¸è¦ |
| **å„çŠ¶æ…‹ãŒç‹¬ç«‹ã—ã¦ãƒ†ã‚¹ãƒˆå¯èƒ½** | `DraftRingi` ã®ãƒ†ã‚¹ãƒˆã¨ `SubmittedRingi` ã®ãƒ†ã‚¹ãƒˆã‚’åˆ†é›¢ |
| **Event Sourcing ã®è¤‡é›‘ã•ãªã—** | ã‚¤ãƒ³ãƒ•ãƒ©ã¯é€šå¸¸ã®DBã€è¿½åŠ ã‚³ã‚¹ãƒˆãªã— |

**å”¯ä¸€ã®ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ: ã‚¯ãƒ©ã‚¹æ•°ãŒå¢—ãˆã‚‹**

çŠ¶æ…‹ãŒ5ã¤ãªã‚‰5ã‚¯ãƒ©ã‚¹ã€‚ã“ã‚Œã¯ã€ŒçŠ¶æ…‹é·ç§»ã®è¤‡é›‘ã•ã‚’æ˜ç¤ºçš„ã«ã—ãŸã€çµæœã§ã‚ã‚Šã€è¤‡é›‘ã•è‡ªä½“ã¯å…ƒã‹ã‚‰ã‚ã£ãŸã‚‚ã®ã§ã™ã€‚

**ã€Œãªãœ Pending ã¨ã„ã†åå‰ã‹ã€:**
`DraftRingi` ã¯ã€Œã¾ã ç”³è«‹ã•ã‚Œã¦ã„ãªã„ï¼ä¿ç•™ä¸­ï¼ˆPendingï¼‰ã®ç¨Ÿè­°ã€ã‚’è¡¨ã—ã¾ã™ã€‚`submit()` ã‚’å‘¼ã¶ã¨ `SubmittedRingi` ã«ãªã‚‹ï¼ã€Œä¿ç•™ã€ãŒè§£é™¤ã•ã‚Œã‚‹ã€ã¨ã„ã†ã‚¤ãƒ¡ãƒ¼ã‚¸ã§ã™ã€‚

---

### çŠ¶æ…‹æ•°ãŒå¢—ãˆãŸã‚‰ã©ã†ã™ã‚‹ã‹

| çŠ¶æ…‹æ•° | æ¨å¥¨ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ |
|--------|---------------|
| 2-4 | Pending Object Patternï¼ˆæœ¬ã‚¹ã‚­ãƒ«ï¼‰ |
| 5-7 | Pending Object Patternã€ã¾ãŸã¯ State ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆGoFï¼‰ã‚’æ¤œè¨ |
| 8ä»¥ä¸Š | State Machine ãƒ©ã‚¤ãƒ–ãƒ©ãƒªï¼ˆXStateç­‰ï¼‰ã‚’æ¤œè¨ |

8çŠ¶æ…‹ã‚’è¶…ãˆãŸã‚‰ã€ã‚¯ãƒ©ã‚¹æ•°ã®ç®¡ç†ãŒå¤§å¤‰ã«ãªã‚‹ã®ã§ã€å°‚ç”¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®å­¦ç¿’ã‚³ã‚¹ãƒˆã‚’æ‰•ã†ä¾¡å€¤ãŒã‚ã‚Šã¾ã™

---

## 1.4 Transition

**Transition**ã¯ã€å‹ A â†’ å‹ B ã¸ã®å¤‰æ›ã‚’è¡Œã†ç´”ç²‹é–¢æ•°ã‚¯ãƒ©ã‚¹ã§ã™ã€‚å‰¯ä½œç”¨ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚

**ä¾‹:** æœªæ¤œè¨¼ã®å…¥åŠ› â†’ æ¤œè¨¼æ¸ˆã¿ã®å…¥åŠ›ã€æ–‡å­—åˆ— â†’ æ—¥ä»˜ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ

```typescript
// ã€Œæœªæ¤œè¨¼ã®ç¨Ÿè­°å…¥åŠ›ã€â†’ã€Œæ¤œè¨¼æ¸ˆã¿ã®ç¨Ÿè­°å…¥åŠ›ã€ã¸ã®å¤‰æ›
class RingiInputValidation {
  constructor(private readonly input: UnvalidatedRingiInput) {}
  
  execute(): Result<ValidatedRingiInput, ValidationError> {
    if (!this.input.title || this.input.title.length === 0) {
      return Result.err(new ValidationError('ã‚¿ã‚¤ãƒˆãƒ«ã¯å¿…é ˆã§ã™'));
    }
    if (this.input.amount < 0) {
      return Result.err(new ValidationError('é‡‘é¡ã¯0ä»¥ä¸Šã§ã™'));
    }
    
    return Result.ok({
      title: this.input.title.trim(),
      amount: this.input.amount,
    });
  }
}
```

**ãªãœCommandã¨åˆ†é›¢ã™ã‚‹ã‹:**

| è¦³ç‚¹ | Command | Transition |
|------|---------|------------|
| ãƒ†ã‚¹ãƒˆ | DBãƒ¢ãƒƒã‚¯ãŒå¿…è¦ | ãƒ¢ãƒƒã‚¯ä¸è¦ã€å…¥åŠ›â†’å‡ºåŠ›ã‚’ç¢ºèªã™ã‚‹ã ã‘ |
| å†åˆ©ç”¨ | å‰¯ä½œç”¨ãŒã‚ã‚‹ã®ã§å†åˆ©ç”¨ã—ã«ãã„ | ã©ã“ã§ã‚‚å®‰å…¨ã«å†åˆ©ç”¨å¯èƒ½ |
| è²¬å‹™ | ã€Œä¿å­˜ã™ã‚‹ã€ã€Œé€ä¿¡ã™ã‚‹ã€ | ã€Œæ¤œè¨¼ã™ã‚‹ã€ã€Œå¤‰æ›ã™ã‚‹ã€ |

---

## 1.5 Query

**Query**ã¯ã€å€¤ã®è¨ˆç®—ãƒ»å°å‡ºã‚’è¡Œã†ç´”ç²‹é–¢æ•°ã‚¯ãƒ©ã‚¹ã§ã™ã€‚å‰¯ä½œç”¨ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚

**ä¾‹:** ç¨é¡è¨ˆç®—ã€å‰²å¼•é©ç”¨ã€åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯

```typescript
// ç¨é¡ã‚’è¨ˆç®—ã™ã‚‹
class TaxOn {
  constructor(
    private readonly price: Money,
    private readonly rate: TaxRate
  ) {}
  
  get amount(): Money {
    return this.price.multiply(this.rate.value);
  }
  
  get priceWithTax(): Money {
    return this.price.add(this.amount);
  }
}

// ä½¿ç”¨ä¾‹
const tax = new TaxOn(Money.of(1000), TaxRate.of(0.1));
console.log(tax.amount);      // 100å††
console.log(tax.priceWithTax); // 1100å††
```

**ãªãœã‚¯ãƒ©ã‚¹ã«ã™ã‚‹ã®ã‹ï¼ˆé–¢æ•°ã§ã¯ãªãï¼‰:**

| é–¢æ•°ã®å ´åˆ | ã‚¯ãƒ©ã‚¹ã®å ´åˆ |
|-----------|-------------|
| `calculateTax(price, rate)` | `new TaxOn(price, rate).amount` |
| `calculatePriceWithTax(price, rate)` | `new TaxOn(price, rate).priceWithTax` |
| åŒã˜å¼•æ•°ã‚’ä½•åº¦ã‚‚æ¸¡ã™ | ä¸€åº¦æ¸¡ã›ã°è¤‡æ•°ã®è¨ˆç®—ãŒã§ãã‚‹ |
| é–¢é€£ã™ã‚‹è¨ˆç®—ãŒãƒãƒ©ãƒãƒ© | é–¢é€£ã™ã‚‹è¨ˆç®—ãŒã¾ã¨ã¾ã‚‹ |

**ãªãœTransitionã§ã¯ãªãQueryã‹:**
- Transition: å‹ãŒå¤‰ã‚ã‚‹ï¼ˆ`UnvalidatedInput` â†’ `ValidatedInput`ï¼‰
- Query: å‹ã¯å¤‰ã‚ã‚‰ãªã„ï¼ˆ`Money` â†’ `Money`ï¼‰ã€åŒã˜æ¦‚å¿µã®åˆ¥ã®è¡¨ç¾

---

## 1.6 ReadModel

**ReadModel**ã¯ã€æ°¸ç¶šå±¤ã‹ã‚‰èª­ã¿å–ã‚Šå°‚ç”¨ã§ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹ã‚¯ãƒ©ã‚¹ã§ã™ã€‚æ›¸ãè¾¼ã¿ã¯è¡Œã„ã¾ã›ã‚“ã€‚

**ä¾‹:** ä¸€è¦§å–å¾—ã€æ¤œç´¢ã€é›†è¨ˆ

```typescript
// æ‰¿èªè€…ã®ç¨Ÿè­°ä¸€è¦§ã‚’å–å¾—ã™ã‚‹
class RingisForApprover {
  constructor(private readonly repository: RingiRepository) {}
  
  async execute(approverId: ApproverId): Promise<readonly RingiSummary[]> {
    return this.repository.findPendingByApprover(approverId);
  }
}
```

**Repositoryï¼ˆãƒªãƒã‚¸ãƒˆãƒªï¼‰ã¨ã¯:**
ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ãƒ»å–å¾—ã‚’æ‹…å½“ã™ã‚‹ã‚¯ãƒ©ã‚¹ã§ã™ã€‚ã€Œãƒ‡ãƒ¼ã‚¿ãŒã©ã“ã«ä¿å­˜ã•ã‚Œã¦ã„ã‚‹ã‹ï¼ˆDBã€ãƒ•ã‚¡ã‚¤ãƒ«ã€APIï¼‰ã€ã‚’éš è”½ã—ã€ã€Œã€‡ã€‡ã‚’ä¿å­˜ã™ã‚‹ã€ã€Œã€‡ã€‡ã‚’å–å¾—ã™ã‚‹ã€ã¨ã„ã†ã‚·ãƒ³ãƒ—ãƒ«ãªã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚’æä¾›ã—ã¾ã™ã€‚

**ãªãœQueryã¨åˆ†é›¢ã™ã‚‹ã‹:**

| è¦³ç‚¹ | Query | ReadModel |
|------|-------|-----------|
| å¤–éƒ¨ãƒªã‚½ãƒ¼ã‚¹ | ä½¿ã‚ãªã„ | Repository ã‚’ä½¿ã† |
| ãƒ†ã‚¹ãƒˆ | ãƒ¢ãƒƒã‚¯ä¸è¦ | Repository ã®ãƒ¢ãƒƒã‚¯ãŒå¿…è¦ |
| ä¾‹ | ç¨é¡è¨ˆç®— | ç¨Ÿè­°ä¸€è¦§å–å¾— |

---

# Part 2: å®Œå…¨ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã¨ä¾å­˜ç”Ÿæˆ

## 2.1 å®Œå…¨ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿

**å®Œå…¨ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿**ã¨ã¯ã€ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã‚’æŠœã‘ãŸæ™‚ç‚¹ã§ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒå®Œå…¨ã«æœ‰åŠ¹ãªçŠ¶æ…‹ã§ã‚ã‚‹ã“ã¨ã§ã™ã€‚

### å•é¡Œ: ä¸å®Œå…¨ãªã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ

```typescript
// âŒ ä¸å®Œå…¨ãªã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒä½œã‚Œã¦ã—ã¾ã†
class User {
  id: string;
  name: string;
  email: string;
  
  setId(id: string) { this.id = id; }
  setName(name: string) { this.name = name; }
  setEmail(email: string) { this.email = email; }
}

// å•é¡Œ: å¿…è¦ãªå€¤ãŒè¨­å®šã•ã‚Œã¦ã„ãªã„ã¾ã¾ä½¿ã‚ã‚Œã‚‹
const user = new User();
user.setName("ç”°ä¸­");
// id ã¨ email ãŒ undefined ã®ã¾ã¾ï¼
saveToDatabase(user);  // ğŸ’¥ ã‚¨ãƒ©ãƒ¼ã¾ãŸã¯ä¸æ­£ãªãƒ‡ãƒ¼ã‚¿
```

### ãªãœå®Œå…¨ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ãªã®ã‹ â€” 5ã¤ã®ä»£æ›¿æ¡ˆã¨ã®æ¯”è¼ƒ

ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆç”Ÿæˆã«ã¯5ã¤ã®æ–¹æ³•ãŒã‚ã‚Šã¾ã™ï¼š

| æ–¹æ³• | æ¦‚è¦ | æ¡ç”¨ |
|------|------|:----:|
| **â‘  Setteræ³¨å…¥** | `new User()` â†’ `user.setName(...)` | âŒ |
| **â‘¡ Builder ãƒ‘ã‚¿ãƒ¼ãƒ³** | `UserBuilder().name(...).email(...).build()` | âŒ |
| **â‘¢ Factory Class** | `UserFactory.create(data)` | âŒ |
| **â‘£ Two-phase initialization** | `new User()` â†’ `user.init(data)` | âŒ |
| **â‘¤ å®Œå…¨ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ + Static Factory** | `new User(id, name, email)` ã¾ãŸã¯ `User.create(data)` | âœ… |

---

#### âŒ æ¡ˆâ‘  Setteræ³¨å…¥ã‚’æ¡ç”¨ã—ãªã‹ã£ãŸç†ç”±

```typescript
class User {
  id?: UserId;
  name?: UserName;
  email?: Email;
  
  setId(id: UserId) { this.id = id; }
  setName(name: UserName) { this.name = name; }
  setEmail(email: Email) { this.email = email; }
}
```

**å•é¡Œ1: ä¸å®Œå…¨ãªã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒå­˜åœ¨ã§ãã‚‹**

```typescript
const user = new User();
user.setName(UserName.of("ç”°ä¸­"));
// user.id = undefined, user.email = undefined
saveToDatabase(user);  // ğŸ’¥ å®Ÿè¡Œæ™‚ã‚¨ãƒ©ãƒ¼
```

**å•é¡Œ2: ã€Œè¨­å®šæ¸ˆã¿ã‹ã€ã‚’å¸¸ã«è€ƒãˆã‚‹å¿…è¦ãŒã‚ã‚‹**

```typescript
function sendWelcomeEmail(user: User) {
  // email ã¯è¨­å®šã•ã‚Œã¦ã„ã‚‹ï¼Ÿ id ã¯ï¼Ÿ ç¢ºèªãŒå¿…è¦...
  if (!user.email) throw new Error('Email not set');
  if (!user.id) throw new Error('ID not set');
  // ã‚„ã£ã¨å‡¦ç†ã§ãã‚‹
}
```

---

#### âŒ æ¡ˆâ‘¡ Builder ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’æ¡ç”¨ã—ãªã‹ã£ãŸç†ç”±

```typescript
class UserBuilder {
  private id?: UserId;
  private name?: UserName;
  private email?: Email;
  
  withId(id: UserId) { this.id = id; return this; }
  withName(name: UserName) { this.name = name; return this; }
  withEmail(email: Email) { this.email = email; return this; }
  
  build(): User {
    return new User(this.id!, this.name!, this.email!);  // ! ã§å¼·åˆ¶
  }
}
```

**å•é¡Œ1: `build()` ã‚’å‘¼ã¶ã¾ã§ä¸å®Œå…¨**

```typescript
const builder = new UserBuilder().withName(UserName.of("ç”°ä¸­"));
// builder ã¯ä¸å®Œå…¨ãªçŠ¶æ…‹ã€‚build() ã‚’å‘¼ã¶ã¾ã§åˆ†ã‹ã‚‰ãªã„
```

**å•é¡Œ2: å¿…é ˆé …ç›®ã‚’å¿˜ã‚Œã¦ã‚‚ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«é€šã‚‹**

```typescript
const user = new UserBuilder()
  .withName(UserName.of("ç”°ä¸­"))
  // id ã¨ email ã‚’å¿˜ã‚ŒãŸï¼
  .build();  // ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã‚¨ãƒ©ãƒ¼ã«ãªã‚‰ãªã„ã€‚å®Ÿè¡Œæ™‚ã«ğŸ’¥
```

**å•é¡Œ3: ã€Œå‹å®‰å…¨ãªBuilderã€ã¯ä½œã‚Œã‚‹ãŒè¤‡é›‘**

å‹å®‰å…¨ãªBuilderã‚’ä½œã‚‹ã“ã¨ã¯å¯èƒ½ã§ã™ãŒã€TypeScriptã§ã¯éå¸¸ã«è¤‡é›‘ã«ãªã‚Šã¾ã™ï¼š

```typescript
// å‹å®‰å…¨ãªBuilderï¼ˆè¤‡é›‘ã™ãã‚‹ä¾‹ï¼‰
type BuilderState = { id: boolean; name: boolean; email: boolean };
class UserBuilder<S extends BuilderState> {
  // è¤‡é›‘ãªå‹å®šç¾©ãŒç¶šã...
}
```

**Builderã‚’è¨±å®¹ã™ã‚‹å ´åˆ:** å¼•æ•°ãŒ10å€‹ä»¥ä¸Šã‚ã‚Šã€å¤šããŒã‚ªãƒ—ã‚·ãƒ§ãƒŠãƒ«ã®å ´åˆã¯ Builder ã®æ–¹ãŒèª­ã¿ã‚„ã™ã„ã“ã¨ã‚‚ã‚ã‚Šã¾ã™ã€‚ãŸã ã—ã€ãã‚Œã¯ã€Œå¼•æ•°ãŒå¤šã™ãã‚‹ã€ã¨ã„ã†ã‚·ã‚°ãƒŠãƒ«ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚

---

#### âŒ æ¡ˆâ‘¢ Factory Class ã‚’æ¡ç”¨ã—ãªã‹ã£ãŸç†ç”±

```typescript
class UserFactory {
  static create(data: UserData): User {
    // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ­ã‚¸ãƒƒã‚¯
    if (!data.email.includes('@')) throw new Error('Invalid email');
    
    return new User(
      UserId.generate(),
      UserName.of(data.name),
      Email.of(data.email)
    );
  }
}
```

**å•é¡Œ1: ãƒ“ã‚¸ãƒã‚¹ãƒ«ãƒ¼ãƒ«ãŒåˆ†æ•£ã™ã‚‹**

```typescript
// âŒ User ã®ãƒ«ãƒ¼ãƒ«ãŒã©ã“ã«ã‚ã‚‹ï¼Ÿ
class User {
  // ä¸€éƒ¨ã®ãƒ«ãƒ¼ãƒ«ãŒã“ã“ã«...
}

class UserFactory {
  // ä¸€éƒ¨ã®ãƒ«ãƒ¼ãƒ«ãŒã“ã“ã«...
}

class UserValidator {
  // ã•ã‚‰ã«åˆ¥ã®ãƒ«ãƒ¼ãƒ«ãŒã“ã“ã«...
}

// ã€ŒUser ã®ãƒ“ã‚¸ãƒã‚¹ãƒ«ãƒ¼ãƒ«å…¨éƒ¨è¦‹ã›ã¦ã€â†’ 3ãƒ•ã‚¡ã‚¤ãƒ«é–‹ãå¿…è¦
```

**å•é¡Œ2: Factory ãŒã€Œç¥ã‚¯ãƒ©ã‚¹ã€ã«ãªã‚ŠãŒã¡**

```typescript
class UserFactory {
  static create(data: UserData): User { }
  static createFromOAuth(profile: OAuthProfile): User { }
  static createAdmin(data: AdminData): User { }
  static createGuest(): User { }
  static createFromCsv(row: string[]): User { }
  // ã©ã‚“ã©ã‚“è†¨ã‚‰ã‚€...
}
```

**Factory Class ã‚’è¨±å®¹ã™ã‚‹å ´åˆ:**
- è¤‡æ•°ã® Aggregate ã‚’å”èª¿ã—ã¦ç”Ÿæˆã™ã‚‹å¿…è¦ãŒã‚ã‚‹å ´åˆ
- å¤–éƒ¨ãƒªã‚½ãƒ¼ã‚¹ï¼ˆIDç”Ÿæˆã‚µãƒ¼ãƒ“ã‚¹ç­‰ï¼‰ãŒå¿…è¦ã§ã€DIã‚³ãƒ³ãƒ†ãƒŠã§ç®¡ç†ã—ãŸã„å ´åˆ

---

#### âŒ æ¡ˆâ‘£ Two-phase initialization ã‚’æ¡ç”¨ã—ãªã‹ã£ãŸç†ç”±

```typescript
class User {
  private id?: UserId;
  private name?: UserName;
  private email?: Email;
  private initialized = false;
  
  constructor() {}  // ç©ºã®ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿
  
  init(data: UserData) {
    if (this.initialized) throw new Error('Already initialized');
    this.id = UserId.generate();
    this.name = UserName.of(data.name);
    this.email = Email.of(data.email);
    this.initialized = true;
  }
  
  getName(): UserName {
    if (!this.initialized) throw new Error('Not initialized');
    return this.name!;
  }
}
```

**å•é¡Œ1: åˆæœŸåŒ–å¿˜ã‚Œ**

```typescript
const user = new User();
// init() ã‚’å‘¼ã³å¿˜ã‚ŒãŸï¼
user.getName();  // ğŸ’¥ å®Ÿè¡Œæ™‚ã‚¨ãƒ©ãƒ¼
```

**å•é¡Œ2: å…¨ãƒ¡ã‚½ãƒƒãƒ‰ã§ãƒã‚§ãƒƒã‚¯ãŒå¿…è¦**

```typescript
// âŒ å…¨ãƒ¡ã‚½ãƒƒãƒ‰ã« initialized ãƒã‚§ãƒƒã‚¯ãŒå…¥ã‚‹
getName(): UserName {
  if (!this.initialized) throw new Error('Not initialized');
  return this.name!;
}

getEmail(): Email {
  if (!this.initialized) throw new Error('Not initialized');
  return this.email!;
}
// ã‚³ãƒ”ãƒšåœ°ç„
```

---

#### âœ… æ¡ˆâ‘¤ å®Œå…¨ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ + Static Factory ã‚’æ¡ç”¨ã—ãŸç†ç”±

```typescript
class User {
  private constructor(
    readonly id: UserId,
    readonly name: UserName,
    readonly email: Email
  ) {}
  
  // å˜ç´”ãªç”Ÿæˆ
  static create(data: ValidatedUserData): User {
    return new User(
      UserId.generate(),
      UserName.of(data.name),
      Email.of(data.email)
    );
  }
  
  // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ä»˜ãç”Ÿæˆï¼ˆå¤±æ•—ã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ï¼‰
  static createFromInput(
    input: UnvalidatedUserInput
  ): Result<User, ValidationError> {
    const validation = new UserInputValidation(input).execute();
    if (!validation.ok) return validation;
    
    return Result.ok(User.create(validation.value));
  }
}
```

| ãƒ¡ãƒªãƒƒãƒˆ | èª¬æ˜ |
|---------|------|
| **ä¸å®Œå…¨ãªã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒå­˜åœ¨ã—ãªã„** | ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã§å…¨ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å¿…é ˆ |
| **ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«æ™‚ã«ãƒã‚§ãƒƒã‚¯** | å¼•æ•°å¿˜ã‚Œã¯ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã‚¨ãƒ©ãƒ¼ |
| **ãƒ“ã‚¸ãƒã‚¹ãƒ«ãƒ¼ãƒ«ãŒ1ç®‡æ‰€** | User ã®ãƒ«ãƒ¼ãƒ«ã¯ User ã‚¯ãƒ©ã‚¹ã«ã‚ã‚‹ |
| **å¤±æ•—ã™ã‚‹ç”Ÿæˆã‚’å‹ã§è¡¨ç¾** | `createFromInput` ã¯ `Result` ã‚’è¿”ã™ |

**private constructor + static factory ã®çµ„ã¿åˆã‚ã›:**

```typescript
// âŒ public constructor ã ã¨ã€ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ã‚¹ã‚­ãƒƒãƒ—ã§ãã‚‹
const user = new User(id, name, email);  // èª°ã§ã‚‚å‘¼ã¹ã‚‹

// âœ… private constructor + static factory
class User {
  private constructor(...) {}  // å¤–ã‹ã‚‰å‘¼ã¹ãªã„
  
  static create(data: ValidatedData): User {
    // ã“ã“ã‚’é€šã‚‰ãªã„ã¨ User ã¯ä½œã‚Œãªã„
    return new User(...);
  }
}
```

**å®Œå…¨ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã®å”¯ä¸€ã®ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ: å¼•æ•°ãŒå¤šããªã‚‹**

```typescript
// å¼•æ•°ãŒå¤šã„å ´åˆ
new User(id, name, email, phone, address, role, createdAt, ...);
```

ã“ã‚Œã«ã¯2ã¤ã®å¯¾å‡¦æ³•ãŒã‚ã‚Šã¾ã™ï¼š

1. **ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«ã¾ã¨ã‚ã‚‹**
```typescript
new User({
  id,
  name,
  email,
  phone,
  address,
  role,
  createdAt,
});
```

2. **ã‚¯ãƒ©ã‚¹ã‚’åˆ†å‰²ã™ã‚‹ï¼ˆæ¨å¥¨ï¼‰**
å¼•æ•°ãŒå¤šã„ã®ã¯ã€Œè²¬å‹™ãŒå¤šã™ãã‚‹ã€ã‚µã‚¤ãƒ³ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“

---

## 2.2 ä¾å­˜ã®4åˆ†é¡ã¨ç”Ÿæˆæ–¹é‡

### ãªãœ4åˆ†é¡ãªã®ã‹ â€” ãƒ†ã‚¹ã‚¿ãƒ“ãƒªãƒ†ã‚£ã‹ã‚‰ã®å°å‡º

ä¾å­˜ã®åˆ†é¡ã¯ã€Œãƒ†ã‚¹ãƒˆæ™‚ã«å·®ã—æ›¿ãˆãŒå¿…è¦ã‹ï¼Ÿã€ã¨ã„ã†åŸºæº–ã‹ã‚‰å°å‡ºã•ã‚Œã¾ã™ï¼š

| åˆ†é¡ | ãƒ†ã‚¹ãƒˆæ™‚ã«å·®ã—æ›¿ãˆå¿…è¦ï¼Ÿ | ç†ç”± | ç”Ÿæˆæ–¹æ³• |
|------|:----------------------:|------|---------|
| **Pure Logic** | âŒ | å¸¸ã«åŒã˜çµæœã‚’è¿”ã™ | ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿å†…ã§ `new` |
| **Configured Logic** | âŒ | ç’°å¢ƒã”ã¨ã«è¨­å®šã‚’åˆ‡ã‚Šæ›¿ãˆã‚Œã°ã‚ˆã„ | ConfigçµŒç”±ã§å†…éƒ¨ç”Ÿæˆ |
| **External Resource** | âœ… | æœ¬ç‰©ã®DBã‚’ä½¿ã„ãŸããªã„ | ãƒ¡ã‚½ãƒƒãƒ‰å¼•æ•°ã§å—ã‘å–ã‚‹ |
| **Non-deterministic** | âœ… | æ™‚åˆ»ã‚’å›ºå®šã—ãŸã„ã€ä¹±æ•°ã‚’åˆ¶å¾¡ã—ãŸã„ | ãƒ¡ã‚½ãƒƒãƒ‰å¼•æ•°ã§å—ã‘å–ã‚‹ |

ã“ã®åˆ†é¡ã®æœ¬è³ªã¯ã€Œ**ãƒ†ã‚¹ãƒˆã§å·®ã—æ›¿ãˆãŒå¿…è¦ãªã‚‚ã®**ã ã‘ã‚’å¤–éƒ¨ã‹ã‚‰æ³¨å…¥ã™ã‚‹ã€ã“ã¨ã§ã™ã€‚

å·®ã—æ›¿ãˆä¸è¦ãªã‚‚ã®ï¼ˆPure Logic, Configured Logicï¼‰ã¾ã§å¤–éƒ¨æ³¨å…¥ã™ã‚‹ã¨ï¼š
- ãƒ†ã‚¹ãƒˆã§ä¸è¦ãªãƒ¢ãƒƒã‚¯ã‚’ä½œã‚‹ç¾½ç›®ã«ãªã‚‹
- ä¾å­˜ã‚°ãƒ©ãƒ•ãŒè¤‡é›‘åŒ–ã™ã‚‹
- ã‚³ãƒ¼ãƒ‰ã®å¯èª­æ€§ãŒä¸‹ãŒã‚‹

é€†ã«ã€å·®ã—æ›¿ãˆå¿…è¦ãªã‚‚ã®ï¼ˆExternal Resource, Non-deterministicï¼‰ã‚’å†…éƒ¨ç”Ÿæˆã™ã‚‹ã¨ï¼š
- ãƒ†ã‚¹ãƒˆã§æœ¬ç‰©ã®DBã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã—ã¾ã†
- ãƒ†ã‚¹ãƒˆçµæœãŒéæ±ºå®šçš„ã«ãªã‚‹ï¼ˆæ™‚åˆ»ä¾å­˜ã§è½ã¡ã‚‹ãƒ†ã‚¹ãƒˆï¼‰
- ãƒ†ã‚¹ãƒˆã®å®Ÿè¡ŒãŒé…ããªã‚‹

---

### ãªãœãƒ¡ã‚½ãƒƒãƒ‰ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ã‹ â€” æ ¸å¿ƒçš„ç†ç”±

**ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¯ `new` ã§ä½œã‚ŠãŸã„ã€‚**

ã“ã‚ŒãŒæ ¸å¿ƒã§ã™ã€‚DIã‚³ãƒ³ãƒ†ãƒŠã¯ã‚µãƒ¼ãƒ“ã‚¹å±¤ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ç®¡ç†ã™ã‚‹ã‚‚ã®ã§ã‚ã‚Šã€ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆï¼ˆEntity, Value Objectï¼‰ã¯ `new DraftRingi(data)` ã®ã‚ˆã†ã«æ‰‹å‹•ã§ç”Ÿæˆã—ã¾ã™ã€‚

```typescript
// ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¯ new ã§ä½œã‚‹ï¼ˆDIã‚³ãƒ³ãƒ†ãƒŠã®å¤–ï¼‰
const draft = new DraftRingi(data);

// ã§ã¯ Repository ã‚’ã©ã†ã‚„ã£ã¦æ¸¡ã™ï¼Ÿ
// â†’ ãƒ¡ã‚½ãƒƒãƒ‰å¼•æ•°ã§æ¸¡ã™
await draft.submit(repository, clock);
```

Factoryãƒ‘ã‚¿ãƒ¼ãƒ³ã§ Repository ã‚’æ¸¡ã™æ–¹æ³•ã‚‚ã‚ã‚Šã¾ã™ãŒï¼š

```typescript
// Factory ãŒå¢—æ®–ã™ã‚‹å•é¡Œ
class RingiFactory {
  createDraft(data) { }
  createFromTemplate(template) { }
  createCopy(original) { }
  createAndSubmit(data) { }
  // ã©ã‚“ã©ã‚“è†¨ã‚‰ã‚€...
}
```

ãƒ¡ã‚½ãƒƒãƒ‰å¼•æ•°ãªã‚‰ Factory ã®å¢—æ®–ã‚’é¿ã‘ã‚‰ã‚Œã¾ã™ã€‚

---

### DDD ã¨ã®ç·Šå¼µé–¢ä¿‚ï¼ˆæ­£ç›´ã«èªã‚ã‚‹ï¼‰

æ­£çµ±æ´¾DDDã§ã¯ã€Œ**Entity ã¯ Repository ã‚’çŸ¥ã‚‰ãªã„**ã€ãŒåŸå‰‡ã§ã™ï¼š

```typescript
// æ­£çµ±æ´¾DDD: Entity ã¯ Repository ã‚’çŸ¥ã‚‰ãªã„
class DraftRingi {
  // Repository ã‚’å¼•æ•°ã«å–ã‚‰ãªã„
}

// Domain Service ãŒ Repository ã‚’ä½¿ã†
class RingiSubmissionService {
  constructor(private readonly repository: RingiRepository) {}
  
  async submit(draft: DraftRingi): Promise<SubmittedRingi> {
    // ãƒ­ã‚¸ãƒƒã‚¯ã¯ã“ã“
  }
}
```

æœ¬ã‚¹ã‚­ãƒ«ã¯ **Rich Domain Model**ï¼ˆãƒ‰ãƒ¡ã‚¤ãƒ³ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆè‡ªèº«ãŒãƒ­ã‚¸ãƒƒã‚¯ã‚’æŒã¤ï¼‰ã‚’å„ªå…ˆã—ã¾ã™ï¼š

```typescript
// æœ¬ã‚¹ã‚­ãƒ«: Entity ãŒãƒ­ã‚¸ãƒƒã‚¯ã‚’æŒã¤
class DraftRingi {
  async submit(repository: RingiRepository, clock: Clock): Promise<SubmittedRingi> {
    // ãƒ­ã‚¸ãƒƒã‚¯ãŒã“ã“ã«ã‚ã‚‹
  }
}
```

ã“ã‚Œã¯ãƒˆãƒ¬ãƒ¼ãƒ‰ã‚ªãƒ•ã§ã™ï¼š

| ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ | ãƒ¡ãƒªãƒƒãƒˆ | ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ |
|-----------|---------|-----------|
| æ­£çµ±æ´¾DDDï¼ˆDomain Serviceï¼‰ | DDDæ•™ç§‘æ›¸é€šã‚Šã€Entity ãŒç´”ç²‹ | ãƒ­ã‚¸ãƒƒã‚¯ãŒåˆ†æ•£ã—ã‚„ã™ã„ |
| æœ¬ã‚¹ã‚­ãƒ«ï¼ˆRich Domain Modelï¼‰ | ãƒ­ã‚¸ãƒƒã‚¯ãŒ Entity ã«é›†ç´„ | Entity ãŒ Repository ã‚’çŸ¥ã‚‹ |

æœ¬ã‚¹ã‚­ãƒ«ãŒ Rich Domain Model ã‚’é¸ã¶ç†ç”±ï¼š
- ã€Œç¨Ÿè­°ã‚’ç”³è«‹ã™ã‚‹ã€ãƒ­ã‚¸ãƒƒã‚¯ã¯ `DraftRingi` ã«æ›¸ãã®ãŒè‡ªç„¶
- ã€Œã©ã“ã‚’è¦‹ã‚Œã°ãƒ­ã‚¸ãƒƒã‚¯ãŒã‚ã‚‹ã‹ã€ãŒæ˜ç¢º
- Anemic Domain Modelï¼ˆè²§è¡€ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ¢ãƒ‡ãƒ«ï¼‰ã‚’é¿ã‘ã‚‰ã‚Œã‚‹

---

### ã“ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ãŒé©ã•ãªã„ã‚±ãƒ¼ã‚¹

ãƒ¡ã‚½ãƒƒãƒ‰ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ãŒé©ã•ãªã„å ´é¢ã‚‚ã‚ã‚Šã¾ã™ï¼š

| ã‚±ãƒ¼ã‚¹ | ãªãœé©ã•ãªã„ã‹ | ä»£æ›¿æ¡ˆ |
|--------|---------------|--------|
| **è¤‡æ•°Aggregate Root ã®å”èª¿** | 1ã¤ã® Entity ãŒè¤‡æ•°ã® Repository ã‚’çŸ¥ã‚‹ã®ã¯è²¬å‹™éå‰° | Application Service |
| **ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å¢ƒç•Œã®åˆ¶å¾¡** | Entity ãŒãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã‚’æ„è­˜ã™ã¹ãã§ãªã„ | Application Service / Unit of Work |
| **è¤‡é›‘ãªãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼** | åˆ†å²ãŒå¤šã™ãã¦ Entity ãŒè‚¥å¤§åŒ– | Saga / Process Manager |
| **å¤–éƒ¨ã‚·ã‚¹ãƒ†ãƒ ã¨ã®ã‚ªãƒ¼ã‚±ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³** | APIå‘¼ã³å‡ºã—ã®é †åºåˆ¶å¾¡ãŒè¤‡é›‘ | Application Service |

ã“ã‚Œã‚‰ã®ã‚±ãƒ¼ã‚¹ã§ã¯ã€æ­£çµ±æ´¾DDDã® Domain Service ã‚„ Application Service ã‚’ä½¿ã†æ–¹ãŒé©åˆ‡ã§ã™ã€‚

---

### 4åˆ†é¡ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆã¾ã¨ã‚ï¼‰

| åˆ†é¡ | å®šç¾© | ä¾‹ | ç”Ÿæˆæ–¹æ³• |
|------|------|-----|---------|
| **Pure Logic** | å¤–éƒ¨ãƒªã‚½ãƒ¼ã‚¹ä¸è¦ã€å¸¸ã«åŒã˜çµæœ | TaxCalculator | ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿å†…ã§ `new` |
| **Configured Logic** | è¨­å®šå€¤ã«ä¾å­˜ã€å¸¸ã«åŒã˜çµæœ | RateCalculator(rate: 0.1) | ConfigçµŒç”±ã§å†…éƒ¨ç”Ÿæˆ |
| **External Resource** | å¤–éƒ¨ãƒªã‚½ãƒ¼ã‚¹ã«ã‚¢ã‚¯ã‚»ã‚¹ | Repository, API Client | ãƒ¡ã‚½ãƒƒãƒ‰å¼•æ•°ã§å—ã‘å–ã‚‹ |
| **Non-deterministic** | å®Ÿè¡Œã”ã¨ã«çµæœãŒå¤‰ã‚ã‚‹ | Clockï¼ˆç¾åœ¨æ™‚åˆ»ï¼‰, Random | ãƒ¡ã‚½ãƒƒãƒ‰å¼•æ•°ã§å—ã‘å–ã‚‹ |

---

### ãªãœã€Œãƒ¡ã‚½ãƒƒãƒ‰å¼•æ•°ã§å—ã‘å–ã‚‹ã€ãªã®ã‹ â€” 4ã¤ã®ä»£æ›¿æ¡ˆã¨ã®æ¯”è¼ƒ

External Resourceï¼ˆRepositoryç­‰ï¼‰ã‚’ã©ã†ã‚„ã£ã¦ã‚¯ãƒ©ã‚¹ã«æ¸¡ã™ã‹ã€‚ã“ã‚Œã«ã¯4ã¤ã®æ–¹æ³•ãŒã‚ã‚Šã¾ã™ï¼š

| æ–¹æ³• | æ¦‚è¦ | æ¡ç”¨ |
|------|------|:----:|
| **â‘  DIã‚³ãƒ³ãƒ†ãƒŠï¼ˆã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿æ³¨å…¥ï¼‰** | NestJS/Springæ–¹å¼ã€‚ã‚³ãƒ³ãƒ†ãƒŠãŒnewæ™‚ã«è‡ªå‹•æ³¨å…¥ | âŒ |
| **â‘¡ Factoryãƒ‘ã‚¿ãƒ¼ãƒ³** | `RingiFactory.create(data, repository)` ã§ç”Ÿæˆæ™‚ã«æ¸¡ã™ | âŒ |
| **â‘¢ Service Locator** | `ServiceLocator.get(RingiRepository)` ã§ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«å–å¾— | âŒ |
| **â‘£ ãƒ¡ã‚½ãƒƒãƒ‰å¼•æ•°** | `draft.submit(repository)` ã§ä½¿ã†æ™‚ã«æ¸¡ã™ | âœ… |

---

#### âŒ æ¡ˆâ‘  DIã‚³ãƒ³ãƒ†ãƒŠï¼ˆã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿æ³¨å…¥ï¼‰ã‚’æ¡ç”¨ã—ãªã‹ã£ãŸç†ç”±

**NestJS ã‚„ Spring ã§æ¨™æº–çš„ãªã‚¢ãƒ—ãƒ­ãƒ¼ãƒ:**
```typescript
// NestJS ã‚¹ã‚¿ã‚¤ãƒ«
@Injectable()
class RingiService {
  constructor(private readonly repository: RingiRepository) {}
  
  async submit(data: RingiData): Promise<SubmittedRingi> {
    const draft = new DraftRingi(data);
    await this.repository.save(draft);
    // ...
  }
}
```

**å•é¡Œ1: ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¯DIã‚³ãƒ³ãƒ†ãƒŠã®å¤–ã§ç”Ÿã¾ã‚Œã‚‹**

`DraftRingi` ã¯ `new DraftRingi(data)` ã§ç”Ÿæˆã•ã‚Œã¾ã™ã€‚DIã‚³ãƒ³ãƒ†ãƒŠã¯ `@Injectable()` ãŒä»˜ã„ãŸã‚¯ãƒ©ã‚¹ã—ã‹ç®¡ç†ã—ã¾ã›ã‚“ã€‚

```typescript
// âŒ ã“ã‚Œã¯ã§ããªã„ â€” DraftRingi ã¯æ‰‹å‹•ã§ new ã™ã‚‹
const draft = container.resolve(DraftRingi);  // DraftRingi ã¯ Entityã€DIã§ç®¡ç†ã—ãªã„
```

DIã‚³ãƒ³ãƒ†ãƒŠã¯ã€Œã‚µãƒ¼ãƒ“ã‚¹å±¤ã€ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆï¼ˆ`RingiService`ï¼‰ã‚’ç®¡ç†ã™ã‚‹ã‚‚ã®ã§ã€ã€Œãƒ‰ãƒ¡ã‚¤ãƒ³ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã€ï¼ˆ`DraftRingi`ï¼‰ã¯ç®¡ç†å¯¾è±¡å¤–ã§ã™ã€‚

**å•é¡Œ2: Anemic Domain Modelï¼ˆè²§è¡€ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ¢ãƒ‡ãƒ«ï¼‰ã‚’èª˜ç™ºã™ã‚‹**

DIã‚³ãƒ³ãƒ†ãƒŠã‚’ä½¿ã†ã¨ã€ãƒ­ã‚¸ãƒƒã‚¯ãŒã€Œã‚µãƒ¼ãƒ“ã‚¹ã€ã«æµå‡ºã—ãŒã¡ã§ã™ï¼š

```typescript
// âŒ DIã‚³ãƒ³ãƒ†ãƒŠæ–¹å¼ â†’ ãƒ­ã‚¸ãƒƒã‚¯ãŒã‚µãƒ¼ãƒ“ã‚¹ã«é›†ä¸­
class RingiService {
  constructor(private readonly repository: RingiRepository) {}
  
  async submit(draft: DraftRingi): Promise<SubmittedRingi> {
    // ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ãŒã“ã“ã«æ›¸ã‹ã‚Œã‚‹
    if (draft.amount.isGreaterThan(MAX)) throw new Error('ä¸Šé™è¶…é');
    const submitted = new SubmittedRingi(draft.id, draft.data, new Date());
    await this.repository.save(submitted);
    return submitted;
  }
}

// DraftRingi ã¯å˜ãªã‚‹ãƒ‡ãƒ¼ã‚¿å…¥ã‚Œç‰©ã«ãªã‚‹ï¼ˆè²§è¡€ï¼‰
class DraftRingi {
  constructor(readonly id: RingiId, readonly data: RingiData) {}
  // ãƒ¡ã‚½ãƒƒãƒ‰ãŒãªã„ï¼
}
```

æœ¬ã‚¹ã‚­ãƒ«ãŒç›®æŒ‡ã™ã®ã¯ã€Œãƒ‰ãƒ¡ã‚¤ãƒ³ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆè‡ªèº«ãŒãƒ­ã‚¸ãƒƒã‚¯ã‚’æŒã¤ã€Rich Domain Model ã§ã™ï¼š

```typescript
// âœ… ãƒ¡ã‚½ãƒƒãƒ‰å¼•æ•°æ–¹å¼ â†’ ãƒ­ã‚¸ãƒƒã‚¯ãŒãƒ‰ãƒ¡ã‚¤ãƒ³ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«
class DraftRingi {
  async submit(repository: RingiRepository, clock: Clock): Promise<SubmittedRingi> {
    // ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ãŒã“ã“ã«ã‚ã‚‹
    const submitted = new SubmittedRingi(this.id, this.data, clock.now());
    await repository.save(submitted);
    return submitted;
  }
}
```

**å•é¡Œ3: ãƒ†ã‚¹ãƒˆã§ã€Œä½¿ã‚ãªã„ä¾å­˜ã€ã‚‚å…¨éƒ¨æ¸¡ã™å¿…è¦ãŒã‚ã‚‹**

```typescript
// âŒ DIã‚³ãƒ³ãƒ†ãƒŠæ–¹å¼ï¼š10ãƒ¡ã‚½ãƒƒãƒ‰ã‚ã‚‹ã‚µãƒ¼ãƒ“ã‚¹
class OrderService {
  constructor(
    private readonly orderRepository: OrderRepository,
    private readonly paymentGateway: PaymentGateway,
    private readonly emailService: EmailService,
    private readonly inventoryApi: InventoryApi,
    private readonly auditLogger: AuditLogger,
  ) {}
  
  async calculateTotal(order: Order): Money { /* repositoryä½¿ã‚ãªã„ */ }
  async validateItems(order: Order): boolean { /* repositoryä½¿ã‚ãªã„ */ }
  // ...
}

// ãƒ†ã‚¹ãƒˆï¼šcalculateTotal ã ã‘ãƒ†ã‚¹ãƒˆã—ãŸã„ã®ã«5ã¤å…¨éƒ¨ãƒ¢ãƒƒã‚¯ã™ã‚‹
const service = new OrderService(
  mockOrderRepository,    // ä½¿ã‚ãªã„ã®ã«ãƒ¢ãƒƒã‚¯å¿…è¦
  mockPaymentGateway,     // ä½¿ã‚ãªã„ã®ã«ãƒ¢ãƒƒã‚¯å¿…è¦
  mockEmailService,       // ä½¿ã‚ãªã„ã®ã«ãƒ¢ãƒƒã‚¯å¿…è¦
  mockInventoryApi,       // ä½¿ã‚ãªã„ã®ã«ãƒ¢ãƒƒã‚¯å¿…è¦
  mockAuditLogger,        // ä½¿ã‚ãªã„ã®ã«ãƒ¢ãƒƒã‚¯å¿…è¦
);
service.calculateTotal(order);  // çµå±€1ã¤ã‚‚ä½¿ã‚ãªã‹ã£ãŸ
```

ãƒ¡ã‚½ãƒƒãƒ‰å¼•æ•°ãªã‚‰ã€ãã®ãƒ¡ã‚½ãƒƒãƒ‰ãŒä½¿ã†ã‚‚ã®ã ã‘æ¸¡ã›ã°ã„ã„ï¼š

```typescript
// âœ… ãƒ¡ã‚½ãƒƒãƒ‰å¼•æ•°æ–¹å¼ï¼šå¿…è¦ãªã‚‚ã®ã ã‘
order.calculateTotal();  // å¼•æ•°ãªã—ã€ãƒ¢ãƒƒã‚¯ä¸è¦
order.submit(repository, clock);  // ä½¿ã†ã‚‚ã®ã ã‘
```

---

#### âŒ æ¡ˆâ‘¡ Factoryãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’æ¡ç”¨ã—ãªã‹ã£ãŸç†ç”±

```typescript
// Factory ãƒ‘ã‚¿ãƒ¼ãƒ³
class RingiFactory {
  constructor(private readonly repository: RingiRepository) {}
  
  async createAndSubmit(data: RingiData): Promise<SubmittedRingi> {
    const draft = new DraftRingi(data);
    // ...submit ãƒ­ã‚¸ãƒƒã‚¯...
    await this.repository.save(submitted);
    return submitted;
  }
}
```

**å•é¡Œ1: ãƒ“ã‚¸ãƒã‚¹ãƒ«ãƒ¼ãƒ«ãŒåˆ†æ•£ã™ã‚‹**

ã€Œç¨Ÿè­°ã®ä¸Šé™ãƒã‚§ãƒƒã‚¯ã€ã¯ã©ã“ã«ã‚ã‚‹ï¼Ÿ`DraftRingi`ï¼Ÿ`RingiFactory`ï¼Ÿä¸¡æ–¹è¦‹ãªã„ã¨åˆ†ã‹ã‚‰ãªã„ã€‚

```typescript
// âŒ çŸ¥è­˜ãŒåˆ†æ•£
class DraftRingi {
  // ã“ã“ã«ã‚‚ä¸€éƒ¨ã®ãƒ«ãƒ¼ãƒ«ãŒ...
}

class RingiFactory {
  // ã“ã“ã«ã‚‚åˆ¥ã®ãƒ«ãƒ¼ãƒ«ãŒ...
}

// ã€Œç¨Ÿè­°ã®ãƒ“ã‚¸ãƒã‚¹ãƒ«ãƒ¼ãƒ«å…¨éƒ¨è¦‹ã›ã¦ã€â†’ 2ãƒ•ã‚¡ã‚¤ãƒ«é–‹ãå¿…è¦
```

**å•é¡Œ2: FactoryãŒã€Œç¥ã‚¯ãƒ©ã‚¹ã€ã«ãªã‚ŠãŒã¡**

```typescript
// âŒ æ™‚é–“ãŒçµŒã¤ã¨...
class RingiFactory {
  createDraft(data) { }
  createFromTemplate(template) { }
  createCopy(original) { }
  createAndSubmit(data) { }
  createForBulkImport(csv) { }
  // ã©ã‚“ã©ã‚“è†¨ã‚‰ã‚€
}
```

---

#### âŒ æ¡ˆâ‘¢ Service Locatorã‚’æ¡ç”¨ã—ãªã‹ã£ãŸç†ç”±

```typescript
// Service Locator ãƒ‘ã‚¿ãƒ¼ãƒ³
class DraftRingi {
  async submit(): Promise<SubmittedRingi> {
    const repository = ServiceLocator.get(RingiRepository);  // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«å–å¾—
    const clock = ServiceLocator.get(Clock);
    // ...
  }
}
```

**å•é¡Œ1: ä¾å­˜ãŒéš ã‚Œã‚‹**

ãƒ¡ã‚½ãƒƒãƒ‰ã‚·ã‚°ãƒãƒãƒ£ã‚’è¦‹ã¦ã‚‚ã€ä½•ã«ä¾å­˜ã—ã¦ã„ã‚‹ã‹åˆ†ã‹ã‚‰ãªã„ï¼š

```typescript
// âŒ ã‚·ã‚°ãƒãƒãƒ£ã‹ã‚‰ä¾å­˜ãŒè¦‹ãˆãªã„
async submit(): Promise<SubmittedRingi>  // ä¸­ã§ä½•ä½¿ã£ã¦ã‚‹ï¼Ÿ

// âœ… ã‚·ã‚°ãƒãƒãƒ£ã«ä¾å­˜ãŒæ˜ç¤ºã•ã‚Œã‚‹
async submit(repository: RingiRepository, clock: Clock): Promise<SubmittedRingi>
```

**å•é¡Œ2: ãƒ†ã‚¹ãƒˆã§ã‚°ãƒ­ãƒ¼ãƒãƒ«çŠ¶æ…‹ã‚’æ“ä½œã™ã‚‹å¿…è¦ãŒã‚ã‚‹**

```typescript
// âŒ ãƒ†ã‚¹ãƒˆå‰ã«ã‚°ãƒ­ãƒ¼ãƒãƒ«çŠ¶æ…‹ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
beforeEach(() => {
  ServiceLocator.register(RingiRepository, new InMemoryRingiRepository());
  ServiceLocator.register(Clock, new FixedClock(...));
});

afterEach(() => {
  ServiceLocator.reset();  // å¿˜ã‚Œã‚‹ã¨æ¬¡ã®ãƒ†ã‚¹ãƒˆã«å½±éŸ¿
});
```

**å•é¡Œ3: ä¸¦åˆ—ãƒ†ã‚¹ãƒˆã§å£Šã‚Œã‚‹**

ã‚°ãƒ­ãƒ¼ãƒãƒ«çŠ¶æ…‹ã‚’å…±æœ‰ã™ã‚‹ãŸã‚ã€ãƒ†ã‚¹ãƒˆã‚’ä¸¦åˆ—å®Ÿè¡Œã™ã‚‹ã¨ç«¶åˆãŒç™ºç”Ÿã—ã¾ã™ã€‚

---

#### âœ… æ¡ˆâ‘£ ãƒ¡ã‚½ãƒƒãƒ‰å¼•æ•°ã‚’æ¡ç”¨ã—ãŸç†ç”±

```typescript
class DraftRingi {
  async submit(repository: RingiRepository, clock: Clock): Promise<SubmittedRingi> {
    const submitted = new SubmittedRingi(this.id, this.data, clock.now());
    await repository.save(submitted);
    return submitted;
  }
}
```

| ãƒ¡ãƒªãƒƒãƒˆ | èª¬æ˜ |
|---------|------|
| **ä¾å­˜ãŒæ˜ç¤ºçš„** | ã‚·ã‚°ãƒãƒãƒ£ã‚’è¦‹ã‚Œã°ä½•ãŒå¿…è¦ã‹åˆ†ã‹ã‚‹ |
| **ãƒ†ã‚¹ãƒˆãŒç°¡å˜** | ä½¿ã†ã‚‚ã®ã ã‘ãƒ¢ãƒƒã‚¯ã™ã‚Œã°ã„ã„ |
| **Rich Domain Model** | ãƒ­ã‚¸ãƒƒã‚¯ãŒãƒ‰ãƒ¡ã‚¤ãƒ³ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆè‡ªèº«ã«ã‚ã‚‹ |
| **ä¸¦åˆ—ãƒ†ã‚¹ãƒˆå¯èƒ½** | ã‚°ãƒ­ãƒ¼ãƒãƒ«çŠ¶æ…‹ãŒãªã„ã®ã§ç«¶åˆã—ãªã„ |

**å”¯ä¸€ã®ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ: å¼•æ•°ãŒå¢—ãˆã‚‹**

```typescript
// å¼•æ•°ãŒå¤šããªã‚‹ã“ã¨ãŒã‚ã‚‹
await draft.submit(repository, clock, notificationService, auditLogger);
```

ã“ã‚Œã¯ã€Œã“ã®ãƒ¡ã‚½ãƒƒãƒ‰ãŒå¤šãã®ã“ã¨ã‚’ã‚„ã‚Šã™ãã¦ã„ã‚‹ã€ã¨ã„ã†ã‚·ã‚°ãƒŠãƒ«ã§ã™ã€‚è²¬å‹™ã‚’åˆ†å‰²ã™ã¹ãã‚µã‚¤ãƒ³ã¨ã—ã¦å—ã‘å…¥ã‚Œã¾ã™ã€‚

---

### ãªãœ4åˆ†é¡ãªã®ã‹ â€” 3åˆ†é¡ã‚„5åˆ†é¡ã§ã¯ãªã

| åˆ†é¡æ•° | å•é¡Œ |
|--------|------|
| **2åˆ†é¡**ï¼ˆPure / Impureï¼‰ | ã€Œè¨­å®šå€¤ã«ä¾å­˜ã€ã¨ã€ŒDBã«ä¾å­˜ã€ã®åŒºåˆ¥ãŒã¤ã‹ãªã„ |
| **3åˆ†é¡**ï¼ˆPure / Config / Externalï¼‰ | ã€Œæ™‚åˆ»ã€ã€Œä¹±æ•°ã€ãŒ External ã«æ··ã–ã‚‹ã€‚ãƒ†ã‚¹ãƒˆæ–¹æ³•ãŒé•ã†ã®ã«åŒã˜æ‰±ã„ã«ãªã‚‹ |
| **4åˆ†é¡**ï¼ˆæœ¬ã‚¹ã‚­ãƒ«ï¼‰ | ç”Ÿæˆæ–¹æ³•ã¨ãƒ†ã‚¹ãƒˆæ–¹æ³•ãŒå®Œå…¨ã«å¯¾å¿œã™ã‚‹ |
| **5åˆ†é¡ä»¥ä¸Š** | è¤‡é›‘ã™ãã¦åˆ¤æ–­ã«æ™‚é–“ãŒã‹ã‹ã‚‹ |

**åˆ¤æ–­ãƒ•ãƒ­ãƒ¼:**
```
ã“ã®ä¾å­˜ã¯...
â”œâ”€ å¤–éƒ¨ãƒªã‚½ãƒ¼ã‚¹ï¼ˆDB, HTTP, Fileï¼‰ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ï¼Ÿ
â”‚   â””â”€ YES â†’ External Resource â†’ ãƒ¡ã‚½ãƒƒãƒ‰å¼•æ•°
â”œâ”€ æ™‚åˆ»ã‚„ä¹±æ•°ã«ä¾å­˜ã™ã‚‹ï¼Ÿ
â”‚   â””â”€ YES â†’ Non-deterministic â†’ ãƒ¡ã‚½ãƒƒãƒ‰å¼•æ•°
â”œâ”€ è¨­å®šå€¤ï¼ˆç¨ç‡ã€ä¸Šé™é¡ç­‰ï¼‰ãŒå¿…è¦ï¼Ÿ
â”‚   â””â”€ YES â†’ Configured Logic â†’ ConfigçµŒç”±ã§ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿å†…ç”Ÿæˆ
â””â”€ ä¸Šè¨˜ã™ã¹ã¦NOï¼Ÿ
    â””â”€ YES â†’ Pure Logic â†’ ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿å†…ã§ç›´æ¥ new
```

---

### Clock ã®æ‰±ã„ â€” ãªãœãƒ¡ã‚½ãƒƒãƒ‰å¼•æ•°ãªã®ã‹

```typescript
// âŒ ç¾åœ¨æ™‚åˆ»ã‚’ç›´æ¥å–å¾—ã™ã‚‹ã¨ã€ãƒ†ã‚¹ãƒˆçµæœãŒæ¯å›å¤‰ã‚ã‚‹
class DraftRingi {
  async submit(repository: RingiRepository): Promise<SubmittedRingi> {
    const submitted = new SubmittedRingi(this.id, new Date());  // æ¯å›é•ã†å€¤
    // ãƒ†ã‚¹ãƒˆã§ã€Œç”³è«‹æ—¥æ™‚ãŒæ­£ã—ã„ã‹ã€ã‚’æ¤œè¨¼ã§ããªã„
  }
}

// âœ… Clockã‚’å¼•æ•°ã§å—ã‘å–ã‚‹ã¨ã€ãƒ†ã‚¹ãƒˆæ™‚ã«å›ºå®šã§ãã‚‹
interface Clock {
  now(): Date;
}

class FixedClock implements Clock {
  constructor(private readonly fixed: Date) {}
  now(): Date { return this.fixed; }
}

class DraftRingi {
  async submit(repository: RingiRepository, clock: Clock): Promise<SubmittedRingi> {
    const submitted = new SubmittedRingi(this.id, clock.now());
    await repository.save(submitted);
    return submitted;
  }
}

// ãƒ†ã‚¹ãƒˆæ™‚
const fixedClock = new FixedClock(new Date('2024-01-15T10:00:00Z'));
await draft.submit(repository, fixedClock);
// submitted.submittedAt ãŒ 2024-01-15T10:00:00Z ã§ã‚ã‚‹ã“ã¨ã‚’æ¤œè¨¼ã§ãã‚‹
```

**ãªãœ `Date.now()` ã‚’ãƒ¢ãƒƒã‚¯ã—ãªã„ã®ã‹:**

```typescript
// âŒ ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ¢ãƒƒã‚¯ â€” ä»–ã®ãƒ†ã‚¹ãƒˆã«å½±éŸ¿ã™ã‚‹å¯èƒ½æ€§
jest.spyOn(Date, 'now').mockReturnValue(1234567890);

// âœ… å¼•æ•°ã§æ¸¡ã™ â€” å½±éŸ¿ç¯„å›²ãŒæ˜ç¢º
await draft.submit(repository, new FixedClock(...));
```

---

# Part 3: Polymorphismï¼ˆå¤šæ…‹æ€§ï¼‰

## 3.1 ç”¨èªèª¬æ˜

**Polymorphismï¼ˆãƒãƒªãƒ¢ãƒ¼ãƒ•ã‚£ã‚ºãƒ ã€å¤šæ…‹æ€§ï¼‰**ã¨ã¯ã€ã€ŒåŒã˜ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚’æŒã¤ç•°ãªã‚‹å®Ÿè£…ã‚’ã€åŒã˜ã‚ˆã†ã«æ‰±ãˆã‚‹ã€ã“ã¨ã§ã™ã€‚

```typescript
// PaymentGateway ã¨ã„ã†ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ï¼ˆå¥‘ç´„ï¼‰
interface PaymentGateway {
  charge(amount: Money): Promise<PaymentResult>;
}

// ç•°ãªã‚‹å®Ÿè£…
class CreditCardPayment implements PaymentGateway {
  async charge(amount: Money): Promise<PaymentResult> {
    // ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰ã§æ±ºæ¸ˆ
  }
}

class BankTransferPayment implements PaymentGateway {
  async charge(amount: Money): Promise<PaymentResult> {
    // éŠ€è¡ŒæŒ¯è¾¼ã§æ±ºæ¸ˆ
  }
}

// ä½¿ã†å´ã¯ã€Œã©ã®æ±ºæ¸ˆæ–¹æ³•ã‹ã€ã‚’çŸ¥ã‚‰ãªãã¦ã„ã„
function processPayment(gateway: PaymentGateway, amount: Money) {
  return gateway.charge(amount);  // ã©ã¡ã‚‰ã®å®Ÿè£…ã§ã‚‚åŒã˜ã‚³ãƒ¼ãƒ‰ã§å‘¼ã¹ã‚‹
}
```

**enumï¼ˆã‚¤ãƒ¼ãƒŠãƒ ï¼‰**ã¨ã¯ã€ã€Œæ±ºã¾ã£ãŸé¸æŠè‚¢ã€ã‚’è¡¨ã™å‹ã§ã™ï¼š

```typescript
enum PaymentMethod {
  CREDIT_CARD = 'credit_card',
  BANK_TRANSFER = 'bank_transfer',
}
```

---

## 3.2 ãªãœ switch ã‚’ç¦æ­¢ã™ã‚‹ã‹

### å•é¡Œ: switch ã®å¢—æ®–

```typescript
// âŒ enum + switch ã§æŒ¯ã‚‹èˆã„ã‚’åˆ†å²
class PaymentProcessor {
  // æ±ºæ¸ˆå‡¦ç†
  async process(method: PaymentMethod, amount: Money) {
    switch (method) {
      case PaymentMethod.CREDIT_CARD:
        // ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰æ±ºæ¸ˆã®ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆ50è¡Œï¼‰
        break;
      case PaymentMethod.BANK_TRANSFER:
        // éŠ€è¡ŒæŒ¯è¾¼ã®ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆ40è¡Œï¼‰
        break;
    }
  }
  
  // è¿”é‡‘å‡¦ç†ï¼šã¾ãŸåŒã˜ switch
  async refund(method: PaymentMethod, transactionId: string) {
    switch (method) {
      case PaymentMethod.CREDIT_CARD:
        // ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰è¿”é‡‘ã®ãƒ­ã‚¸ãƒƒã‚¯
        break;
      case PaymentMethod.BANK_TRANSFER:
        // éŠ€è¡ŒæŒ¯è¾¼è¿”é‡‘ã®ãƒ­ã‚¸ãƒƒã‚¯
        break;
    }
  }
  
  // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèªï¼šã¾ãŸåŒã˜ switch
  async getStatus(method: PaymentMethod, transactionId: string) {
    switch (method) { /* ... */ }
  }
}
```

**å•é¡Œç‚¹:**
- **Shotgun Surgeryï¼ˆæ•£å¼¾éŠƒæ‰‹è¡“ï¼‰**: æ–°ã—ã„æ±ºæ¸ˆæ–¹æ³•ã‚’è¿½åŠ ã™ã‚‹ã¨ãã€å…¨ã¦ã® switch ã‚’ä¿®æ­£ã™ã‚‹å¿…è¦ãŒã‚ã‚‹
- **å·¨å¤§åŒ–**: å„ case ãŒé•·ããªã‚Šã€ãƒ¡ã‚½ãƒƒãƒ‰ãŒæ•°ç™¾è¡Œã«ãªã‚‹
- **ãƒ†ã‚¹ãƒˆå›°é›£**: å…¨ã¦ã®åˆ†å²ã‚’1ã¤ã®ã‚¯ãƒ©ã‚¹ã§ãƒ†ã‚¹ãƒˆã™ã‚‹å¿…è¦ãŒã‚ã‚‹

### è§£æ±º: Polymorphism

```typescript
// âœ… Interface + å®Ÿè£…ã‚¯ãƒ©ã‚¹
interface PaymentGateway {
  process(amount: Money): Promise<PaymentResult>;
  refund(transactionId: string): Promise<RefundResult>;
  getStatus(transactionId: string): Promise<PaymentStatus>;
}

class CreditCardPayment implements PaymentGateway {
  async process(amount: Money) { /* ã‚¯ãƒ¬ã‚«ã®å‡¦ç† */ }
  async refund(transactionId: string) { /* ã‚¯ãƒ¬ã‚«ã®è¿”é‡‘ */ }
  async getStatus(transactionId: string) { /* ã‚¯ãƒ¬ã‚«ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ */ }
}

class BankTransferPayment implements PaymentGateway {
  async process(amount: Money) { /* æŒ¯è¾¼ã®å‡¦ç† */ }
  async refund(transactionId: string) { /* æŒ¯è¾¼ã®è¿”é‡‘ */ }
  async getStatus(transactionId: string) { /* æŒ¯è¾¼ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ */ }
}
```

**ãƒ¡ãƒªãƒƒãƒˆ:**
- æ–°ã—ã„æ±ºæ¸ˆæ–¹æ³•ã‚’è¿½åŠ  â†’ æ–°ã—ã„ã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ ã™ã‚‹ã ã‘ã€æ—¢å­˜ã‚³ãƒ¼ãƒ‰ã¯å¤‰æ›´ä¸è¦
- å„ã‚¯ãƒ©ã‚¹ã‚’å€‹åˆ¥ã«ãƒ†ã‚¹ãƒˆå¯èƒ½
- é–¢é€£ã™ã‚‹ãƒ­ã‚¸ãƒƒã‚¯ãŒ1ã¤ã®ã‚¯ãƒ©ã‚¹ã«ã¾ã¨ã¾ã‚‹

---

## 3.3 ãªãœä»–ã®ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã§ã¯ãªã„ã®ã‹

| ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ | å•é¡Œ |
|-----------|------|
| **switchæ–‡** | æ–°ã—ã„ç¨®é¡è¿½åŠ æ™‚ã«å…¨ switch ã‚’ä¿®æ­£ã€å·¨å¤§åŒ– |
| **Map/è¾æ›¸** | `{ 'credit_card': handler }` ã®ã‚ˆã†ãªå½¢ã€‚å‹å®‰å…¨æ€§ãŒä½ã„ã€ç¶²ç¾…æ€§ãƒã‚§ãƒƒã‚¯ãŒãªã„ |
| **if-else ãƒã‚§ãƒ¼ãƒ³** | switch ã¨åŒã˜å•é¡Œ |

---

## 3.4 ã„ã¤ switch ã‚’è¨±å®¹ã™ã‚‹ã‹

ä»¥ä¸‹ã®3ã¤**å…¨ã¦**ãŒ NO ã®å ´åˆã€switch ã§å¯ï¼š

1. å„åˆ†å²ã§**ç•°ãªã‚‹è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯**ãŒã‚ã‚‹ï¼Ÿ
2. å„åˆ†å²ã‚’**ç‹¬ç«‹ã—ã¦ãƒ†ã‚¹ãƒˆ**ã—ãŸã„ï¼Ÿ
3. ä»Šå¾Œã€åˆ†å²ãŒ**è¿½åŠ ã•ã‚Œã‚‹å¯èƒ½æ€§**ãŒã‚ã‚‹ï¼Ÿ

**è¨±å®¹ã•ã‚Œã‚‹ä¾‹:**

```typescript
// âœ… å€¤ã®é¸æŠã ã‘ï¼ˆãƒ­ã‚¸ãƒƒã‚¯ãªã—ï¼‰
const label = status === 'active' ? 'æœ‰åŠ¹' : 'ç„¡åŠ¹';

// âœ… å¢ƒç•Œå±¤ã§ã®ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰å¤‰æ›ï¼ˆæ‹¡å¼µã•ã‚Œã«ãã„ï¼‰
switch (error.code) {
  case 'NOT_FOUND': return 404;
  case 'UNAUTHORIZED': return 401;
  default: return 500;
}

// âœ… enumãŒå˜ãªã‚‹è­˜åˆ¥å­ï¼ˆæŒ¯ã‚‹èˆã„ãŒãªã„ï¼‰
enum Color { RED, GREEN, BLUE }
```

---

# Part 4: ã‚¨ãƒ©ãƒ¼å‡¦ç†

## 4.1 Result å‹ã¨ã¯

**Resultå‹**ã¨ã¯ã€ã€ŒæˆåŠŸã€ã¾ãŸã¯ã€Œå¤±æ•—ã€ã‚’æˆ»ã‚Šå€¤ã®å‹ã§è¡¨ç¾ã™ã‚‹ä»•çµ„ã¿ã§ã™ã€‚

```typescript
// Resultå‹ã®å®šç¾©
type Result<T, E> = 
  | { ok: true; value: T }   // æˆåŠŸæ™‚: ok ãŒ true ã§ value ã«çµæœ
  | { ok: false; error: E }; // å¤±æ•—æ™‚: ok ãŒ false ã§ error ã«ã‚¨ãƒ©ãƒ¼æƒ…å ±
```

### ãªãœ Result å‹ãªã®ã‹ â€” 5ã¤ã®ä»£æ›¿æ¡ˆã¨ã®æ¯”è¼ƒ

ã‚¨ãƒ©ãƒ¼å‡¦ç†ã«ã¯5ã¤ã®æ–¹æ³•ãŒã‚ã‚Šã¾ã™ï¼š

| æ–¹æ³• | æ¦‚è¦ | æ¡ç”¨ |
|------|------|:----:|
| **â‘  ä¾‹å¤–ï¼ˆthrow/catchï¼‰** | `throw new Error()` ã§ä¸­æ–­ | â–³ æ¡ä»¶ä»˜ã |
| **â‘¡ null/undefined** | å¤±æ•—æ™‚ã« `null` ã‚’è¿”ã™ | âŒ |
| **â‘¢ Go ã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆã‚¿ãƒ—ãƒ«ï¼‰** | `[value, error]` ã‚’è¿”ã™ | âŒ |
| **â‘£ Either/Maybe ãƒ¢ãƒŠãƒ‰** | é–¢æ•°å‹ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ç”±æ¥ | âŒ |
| **â‘¤ Result å‹** | `{ ok, value/error }` ã‚’è¿”ã™ | âœ… |

---

#### â–³ æ¡ˆâ‘  ä¾‹å¤–ï¼ˆthrow/catchï¼‰â€” æ¡ä»¶ä»˜ãã§æ¡ç”¨

```typescript
// ä¾‹å¤–æ–¹å¼
async function submit(data: RingiData): Promise<SubmittedRingi> {
  if (data.amount > MAX) throw new AmountExceededError();
  // ...
}

try {
  await submit(data);
} catch (e) {
  // e ã¯ unknown å‹
}
```

**å•é¡Œ1: å‹ã‚·ã‚°ãƒãƒãƒ£ã«ã‚¨ãƒ©ãƒ¼ãŒè¡¨ã‚Œãªã„**

```typescript
// âŒ ä½•ãŒæŠ•ã’ã‚‰ã‚Œã‚‹ã‹åˆ†ã‹ã‚‰ãªã„
async function submit(data: RingiData): Promise<SubmittedRingi>
// â†‘ ã“ã®é–¢æ•°ãŒ ValidationError? AmountExceededError? DatabaseError? 
// å‹ã‚’è¦‹ã¦ã‚‚åˆ†ã‹ã‚‰ãªã„ã€‚å®Ÿè£…ã‚’èª­ã¾ãªã„ã¨åˆ†ã‹ã‚‰ãªã„ã€‚
```

**å•é¡Œ2: catch å¿˜ã‚Œã¦ã‚‚å‹•ã**

```typescript
// âŒ catch ã‚’å¿˜ã‚Œã¦ã‚‚ TypeScript ã¯è­¦å‘Šã—ãªã„
await submit(data);
// â†‘ ä¾‹å¤–ãŒæŠ•ã’ã‚‰ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ã®ã«ã€catch ãŒãªã„
// ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã¯é€šã‚‹ã€‚æœ¬ç•ªã§åˆã‚ã¦ã‚¯ãƒ©ãƒƒã‚·ãƒ¥ã€‚
```

**å•é¡Œ3: catch ã® e ã¯ unknown å‹**

```typescript
try {
  await submit(data);
} catch (e) {
  // e ã¯ unknown å‹ã€‚ä½•ã®ã‚¨ãƒ©ãƒ¼ã‹åˆ†ã‹ã‚‰ãªã„
  if (e instanceof ValidationError) { ... }
  else if (e instanceof AmountExceededError) { ... }
  else { ... }  // ã“ã‚Œå…¨éƒ¨è¦šãˆã¦ã„ã‚‰ã‚Œã‚‹ï¼Ÿ
}
```

**å‡ºå…¸: Mediumè¨˜äº‹ "How Rust Made Me Ditch Go's Error Hell"**
> "The Result type makes errors visible in the type signature. You cannot ignore them."

**ä¾‹å¤–ã‚’è¨±å®¹ã™ã‚‹å ´åˆï¼ˆInfrastructureErrorï¼‰:**
æœ¬ã‚¹ã‚­ãƒ«ã§ã¯ã€**ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå¯¾å‡¦ã§ããªã„ã‚¨ãƒ©ãƒ¼**ã¯ä¾‹å¤–ã§ throw ã—ã¾ã™ï¼š

```typescript
// âœ… InfrastructureError ã¯ä¾‹å¤–OK
class PostgresRingiRepository {
  async save(ringi: Ringi): Promise<void> {
    try {
      await this.db.execute(...);
    } catch (e) {
      // DBæ¥ç¶šå¤±æ•—ã€ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ãªã©
      throw new InfrastructureError('Database error', e);
    }
  }
}
```

ç†ç”±: DBéšœå®³ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã§ãã‚‹ã“ã¨ã¯ã€Œã—ã°ã‚‰ãå¾…ã£ã¦å†è©¦è¡Œã€ã ã‘ã€‚Result ã§è¿”ã—ã¦ã‚‚æ„å‘³ãŒãªã„ã€‚

---

#### âŒ æ¡ˆâ‘¡ null/undefined ã‚’æ¡ç”¨ã—ãªã‹ã£ãŸç†ç”±

```typescript
// null æ–¹å¼
function findUser(id: string): User | null {
  if (!exists) return null;
  if (!hasPermission) return null;
  return user;
}
```

**å•é¡Œ1: ã‚¨ãƒ©ãƒ¼ã®ç†ç”±ãŒåˆ†ã‹ã‚‰ãªã„**

```typescript
const user = findUser(id);
if (user === null) {
  // ãªãœ nullï¼Ÿ
  // - ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå­˜åœ¨ã—ãªã„ï¼Ÿ
  // - æ¨©é™ãŒãªã„ï¼Ÿ
  // - DBæ¥ç¶šã«å¤±æ•—ã—ãŸï¼Ÿ
  // åˆ†ã‹ã‚‰ãªã„ï¼
}
```

**å•é¡Œ2: null ãƒã‚§ãƒƒã‚¯å¿˜ã‚Œ**

```typescript
// âŒ TypeScript ã® strictNullChecks ã‚’æœ‰åŠ¹ã«ã—ã¦ã„ã¦ã‚‚...
const user = findUser(id);
console.log(user.name);  // ğŸ’¥ user ãŒ null ã‹ã‚‚

// æ¯å› null ãƒã‚§ãƒƒã‚¯ãŒå¿…è¦
if (user) {
  console.log(user.name);  // ã‚ˆã†ã‚„ãå®‰å…¨
}
```

---

#### âŒ æ¡ˆâ‘¢ Go ã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆã‚¿ãƒ—ãƒ«ï¼‰ã‚’æ¡ç”¨ã—ãªã‹ã£ãŸç†ç”±

```typescript
// Go ã‚¹ã‚¿ã‚¤ãƒ«
function findUser(id: string): [User | null, Error | null] {
  if (!exists) return [null, new NotFoundError(id)];
  return [user, null];
}

const [user, err] = findUser(id);
if (err) {
  // ã‚¨ãƒ©ãƒ¼å‡¦ç†
}
```

**å•é¡Œ1: ä¸¡æ–¹ null ã®ã‚±ãƒ¼ã‚¹ã‚’é˜²ã’ãªã„**

```typescript
// âŒ ä¸æ­£ãªçŠ¶æ…‹ãŒå‹ã¨ã—ã¦è¨±å®¹ã•ã‚Œã‚‹
return [null, null];  // ã©ã£ã¡ã‚‚ nullï¼ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«é€šã‚‹
return [user, new Error()];  // ä¸¡æ–¹ã‚ã‚‹ï¼ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«é€šã‚‹
```

**å•é¡Œ2: TypeScript ã®å‹æ¨è«–ã¨ç›¸æ€§ãŒæ‚ªã„**

```typescript
const [user, err] = findUser(id);
if (err) return;

// â†“ ã“ã®æ™‚ç‚¹ã§ user ã¯ null ã˜ã‚ƒãªã„ã¯ãšãªã®ã«...
console.log(user.name);  // TypeScript: "user ã¯ null ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“"
// å‹ãŒçµã‚Šè¾¼ã¾ã‚Œãªã„
```

Result å‹ãªã‚‰å‹ãŒçµã‚Šè¾¼ã¾ã‚Œã‚‹ï¼š

```typescript
// âœ… Result å‹
const result = findUser(id);
if (!result.ok) return;

console.log(result.value.name);  // OK! value ã¯ User å‹
```

---

#### âŒ æ¡ˆâ‘£ Either/Maybe ãƒ¢ãƒŠãƒ‰ã‚’æ¡ç”¨ã—ãªã‹ã£ãŸç†ç”±

```typescript
// Either ãƒ¢ãƒŠãƒ‰ï¼ˆfp-ts ç­‰ï¼‰
import { Either, left, right, chain } from 'fp-ts/Either';

function findUser(id: string): Either<Error, User> {
  if (!exists) return left(new NotFoundError(id));
  return right(user);
}

// ä½¿ã†å´
pipe(
  findUser(id),
  chain(validatePermission),
  chain(loadProfile),
  fold(
    (error) => handleError(error),
    (user) => showUser(user)
  )
);
```

**å•é¡Œ1: å­¦ç¿’ã‚³ã‚¹ãƒˆãŒé«˜ã™ãã‚‹**

`pipe`, `chain`, `fold`, `map`, `flatMap`, `ap`, `sequenceT` ...

ãƒãƒ¼ãƒ å…¨å“¡ãŒã“ã‚Œã‚’ç†è§£ã§ãã‚‹ï¼Ÿæ–°ãƒ¡ãƒ³ãƒãƒ¼ãŒå…¥ã£ã¦ããŸã‚‰ï¼Ÿ

**å•é¡Œ2: æ—¢å­˜ã®ã‚¨ã‚³ã‚·ã‚¹ãƒ†ãƒ ã¨ã®ç›¸æ€§**

```typescript
// âŒ async/await ã¨çµ„ã¿åˆã‚ã›ãŒé¢å€’
async function submit(): Promise<Either<Error, Ringi>> {
  // Either ã¨ Promise ã®çµ„ã¿åˆã‚ã› = TaskEither
  // ã•ã‚‰ã«è¤‡é›‘ã«...
}
```

**å•é¡Œ3: ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒåˆ†ã‹ã‚Šã«ãã„**

fp-ts ã®ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯ TypeScript åˆå¿ƒè€…ã«ã¯æš—å·ã«è¦‹ãˆã¾ã™ã€‚

**Either ã‚’è¨±å®¹ã™ã‚‹å ´åˆ:**
- ãƒãƒ¼ãƒ å…¨å“¡ãŒé–¢æ•°å‹ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ã«ç²¾é€šã—ã¦ã„ã‚‹
- æ—¢å­˜ã‚³ãƒ¼ãƒ‰ãƒ™ãƒ¼ã‚¹ãŒ fp-ts ã‚’ä½¿ã£ã¦ã„ã‚‹

---

#### âœ… æ¡ˆâ‘¤ Result å‹ã‚’æ¡ç”¨ã—ãŸç†ç”±

```typescript
// Result å‹
type Result<T, E> = 
  | { ok: true; value: T }
  | { ok: false; error: E };

function findUser(id: string): Result<User, NotFoundError | PermissionError> {
  if (!exists) return { ok: false, error: new NotFoundError(id) };
  if (!hasPermission) return { ok: false, error: new PermissionError(id) };
  return { ok: true, value: user };
}

// ä½¿ã†å´
const result = findUser(id);
if (!result.ok) {
  // result.error ã¯ NotFoundError | PermissionError å‹
  console.log(result.error.message);
  return;
}
// result.value ã¯ User å‹
console.log(result.value.name);
```

| ãƒ¡ãƒªãƒƒãƒˆ | èª¬æ˜ |
|---------|------|
| **ã‚¨ãƒ©ãƒ¼ãŒå‹ã«è¡¨ã‚Œã‚‹** | `Result<User, NotFoundError>` ã§ä½•ãŒèµ·ãã‚‹ã‹åˆ†ã‹ã‚‹ |
| **ã‚¨ãƒ©ãƒ¼å‡¦ç†ã‚’å¼·åˆ¶** | `if (!result.ok)` ã‚’æ›¸ã‹ãªã„ã¨ value ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ããªã„ |
| **å‹ãŒçµã‚Šè¾¼ã¾ã‚Œã‚‹** | `if (!result.ok) return;` ã®å¾Œã€`result.value` ã¯ User å‹ |
| **å­¦ç¿’ã‚³ã‚¹ãƒˆãŒä½ã„** | `if/else` ãŒåˆ†ã‹ã‚Œã°ä½¿ãˆã‚‹ |

---

### Result å‹ã®æ¬ ç‚¹ã¨å¯¾å‡¦æ³•

**æ¬ ç‚¹1: å†—é•·ã«ãªã‚‹ã“ã¨ãŒã‚ã‚‹**

```typescript
// âŒ æ¯å› if ãƒã‚§ãƒƒã‚¯
const result1 = step1();
if (!result1.ok) return result1;

const result2 = step2(result1.value);
if (!result2.ok) return result2;

const result3 = step3(result2.value);
if (!result3.ok) return result3;
// ç¹°ã‚Šè¿”ã—...
```

**å¯¾å‡¦: ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°**

```typescript
// âœ… andThen ã§ãƒã‚§ãƒ¼ãƒ³
const finalResult = result1
  .andThen(step2)
  .andThen(step3);
```

**æ¬ ç‚¹2: async ã¨ã®çµ„ã¿åˆã‚ã›**

```typescript
// âŒ Promise<Result<T, E>> ã®æ‰±ã„ãŒé¢å€’
const result = await asyncStep1();
if (!result.ok) return result;
// ...
```

**å¯¾å‡¦: AsyncResult ãƒ˜ãƒ«ãƒ‘ãƒ¼**

```typescript
// âœ… AsyncResult
const result = await AsyncResult
  .from(asyncStep1())
  .andThen(asyncStep2)
  .andThen(asyncStep3);
```

---

## 4.2 ã‚¨ãƒ©ãƒ¼ã®2åˆ†é¡

| åˆ†é¡ | å®šç¾© | å‡¦ç†æ–¹æ³• | ä¾‹ |
|------|------|---------|-----|
| **DomainError** | ãƒ“ã‚¸ãƒã‚¹ãƒ«ãƒ¼ãƒ«é•å | Resultå‹ã§è¿”ã™ | é‡‘é¡ä¸Šé™è¶…éã€åœ¨åº«ä¸è¶³ |
| **InfrastructureError** | æŠ€è¡“çš„ãªéšœå®³ | ä¾‹å¤–ã§throw | DBæ¥ç¶šå¤±æ•—ã€ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ |

**ãªãœåˆ†ã‘ã‚‹ã‹:**

| ã‚¨ãƒ©ãƒ¼ç¨®é¡ | ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå¯¾å‡¦å¯èƒ½ï¼Ÿ | ä¾‹ |
|-----------|:----------------:|-----|
| DomainError | âœ… | ã€Œé‡‘é¡ã‚’100ä¸‡å††ä»¥ä¸‹ã«ä¿®æ­£ã—ã¦ãã ã•ã„ã€ |
| InfrastructureError | âŒ | ã€Œã—ã°ã‚‰ãå¾…ã£ã¦ã‹ã‚‰å†è©¦è¡Œã—ã¦ãã ã•ã„ã€ |

DomainError ã¯ã€Œã“ã†ã™ã‚Œã°æˆåŠŸã™ã‚‹ã€ãŒåˆ†ã‹ã‚‹ã®ã§ã€Result ã§è¿”ã—ã¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ä¼ãˆã¾ã™ã€‚
InfrastructureError ã¯ã€Œã©ã†ã—ã‚ˆã†ã‚‚ãªã„ã€ã®ã§ã€ä¾‹å¤–ã§ä¸Šä½ã«ä¼æ¬ã•ã›ã¦ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ã§å‡¦ç†ã—ã¾ã™ã€‚

**åˆ¤æ–­ãƒ•ãƒ­ãƒ¼:**
```
ã“ã®ã‚¨ãƒ©ãƒ¼ã¯...
â”œâ”€ ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå…¥åŠ›ã‚’ä¿®æ­£ã™ã‚Œã°æˆåŠŸã™ã‚‹ï¼Ÿ
â”‚   â””â”€ YES â†’ DomainError â†’ Result å‹
â””â”€ NOï¼ˆã‚·ã‚¹ãƒ†ãƒ éšœå®³ã€ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯éšœå®³ï¼‰
    â””â”€ InfrastructureError â†’ ä¾‹å¤– throw
```

---

# Part 5: è¨­è¨ˆãƒ«ãƒ¼ãƒ«é›†

## 5.1 Interface å„ªå…ˆã€ç¶™æ‰¿ç¦æ­¢

### ç¶™æ‰¿ã®å•é¡Œ

```typescript
// âŒ ç¶™æ‰¿ã®å•é¡Œ: ãƒšãƒ³ã‚®ãƒ³ã¯é³¥ã ãŒé£›ã¹ãªã„
class Bird {
  fly() { console.log("é£›ã¶"); }
}

class Penguin extends Bird {
  fly() { throw new Error("é£›ã¹ã¾ã›ã‚“"); }  // è¦ªã®å¥‘ç´„ã‚’ç ´ã£ã¦ã„ã‚‹
}
```

ã“ã‚Œã¯**ãƒªã‚¹ã‚³ãƒ•ã®ç½®æ›åŸå‰‡ï¼ˆLSPï¼‰**é•åã§ã™ã€‚LSPã¨ã¯ã€Œå­ã‚¯ãƒ©ã‚¹ã¯è¦ªã‚¯ãƒ©ã‚¹ã®ä»£ã‚ã‚Šã«ä½¿ãˆã‚‹ã¹ãã€ã¨ã„ã†åŸå‰‡ã€‚`Bird`ã‚’æœŸå¾…ã™ã‚‹ã‚³ãƒ¼ãƒ‰ã«`Penguin`ã‚’æ¸¡ã™ã¨å£Šã‚Œã¾ã™ã€‚

**ç¶™æ‰¿ã®ä»–ã®å•é¡Œ:**
- **è„†ã„åŸºåº•ã‚¯ãƒ©ã‚¹å•é¡Œ**: è¦ªã‚¯ãƒ©ã‚¹ã‚’å¤‰æ›´ã™ã‚‹ã¨ã€å…¨ã¦ã®å­ã‚¯ãƒ©ã‚¹ãŒå½±éŸ¿ã‚’å—ã‘ã‚‹
- **å¤šé‡ç¶™æ‰¿ä¸å¯**: å¤šãã®è¨€èªã§1ã¤ã®è¦ªã—ã‹æŒã¦ãªã„

### è§£æ±º: Interface + Composition

**Compositionï¼ˆã‚³ãƒ³ãƒã‚¸ã‚·ãƒ§ãƒ³ï¼‰**ã¨ã¯ã€ç¶™æ‰¿ã®ä»£ã‚ã‚Šã«ã€ŒæŒã¤ã€é–¢ä¿‚ã§è¡¨ç¾ã™ã‚‹ã“ã¨ã§ã™ã€‚

```typescript
// âœ… Interface: å¿…è¦ãªæŒ¯ã‚‹èˆã„ã ã‘å®šç¾©
interface Flyer { fly(): void; }
interface Swimmer { swim(): void; }

// ãƒšãƒ³ã‚®ãƒ³ã¯æ³³ã’ã‚‹ãŒé£›ã¹ãªã„
class Penguin implements Swimmer {
  swim() { console.log("æ³³ã"); }
}

// ã‚«ãƒ¢ã¯é£›ã¹ã‚‹ã—æ³³ã’ã‚‹
class Duck implements Flyer, Swimmer {
  fly() { console.log("é£›ã¶"); }
  swim() { console.log("æ³³ã"); }
}
```

---

## 5.2 Early Return Onlyï¼ˆelseç¦æ­¢ï¼‰

### å•é¡Œ: ãƒã‚¹ãƒˆã®æ·±ã„æ¡ä»¶åˆ†å²

```typescript
// âŒ else ã§ãƒã‚¹ãƒˆãŒæ·±ããªã‚‹
function processOrder(order, user) {
  if (order !== null) {
    if (user !== null) {
      if (user.isActive) {
        if (order.items.length > 0) {
          // ã“ã“ã§ã‚„ã£ã¨æœ¬é¡Œã®å‡¦ç†ï¼ˆã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆ4æ®µï¼‰
        } else {
          return { error: "å•†å“ãŒã‚ã‚Šã¾ã›ã‚“" };
        }
      } else {
        return { error: "ç„¡åŠ¹ãªãƒ¦ãƒ¼ã‚¶ãƒ¼" };
      }
    } else {
      return { error: "ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå¿…è¦" };
    }
  } else {
    return { error: "æ³¨æ–‡ãŒå¿…è¦" };
  }
}
```

### è§£æ±º: Early Returnï¼ˆã‚¬ãƒ¼ãƒ‰ç¯€ï¼‰

**ã‚¬ãƒ¼ãƒ‰ç¯€**ã¨ã¯ã€ç•°å¸¸ç³»ã‚’å…ˆã«ãƒã‚§ãƒƒã‚¯ã—ã¦æ—©æœŸã« return ã™ã‚‹ã“ã¨ã§ã™ã€‚

```typescript
// âœ… Early Return ã§å¹³å¦ã«
function processOrder(order, user) {
  // ç•°å¸¸ç³»ã‚’å…ˆã«å‡¦ç†
  if (order === null) return { error: "æ³¨æ–‡ãŒå¿…è¦" };
  if (user === null) return { error: "ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå¿…è¦" };
  if (!user.isActive) return { error: "ç„¡åŠ¹ãªãƒ¦ãƒ¼ã‚¶ãƒ¼" };
  if (order.items.length === 0) return { error: "å•†å“ãŒã‚ã‚Šã¾ã›ã‚“" };
  
  // æœ¬é¡Œã®å‡¦ç†ï¼ˆãƒã‚¹ãƒˆãªã—ï¼‰
  return processPayment(order);
}
```

**else ã‚’è¨±å®¹ã™ã‚‹ä¾‹å¤–:** ä¸¡æ–¹ã¨ã‚‚æ­£å¸¸ç³»ã§ã€åŒã˜å‹ã‚’è¿”ã™å ´åˆ

```typescript
// âœ… ä¸¡æ–¹æ­£å¸¸ç³»ãªã®ã§ else OK
function getDisplayName(user: User): string {
  if (user.nickname) {
    return user.nickname;
  } else {
    return user.fullName;
  }
}
```

---

## 5.3 Primitive Obsession ã®å›é¿

**Primitive Obsessionï¼ˆãƒ—ãƒªãƒŸãƒ†ã‚£ãƒ–å‹ã¸ã®åŸ·ç€ï¼‰**ã¨ã¯ã€`string`ã‚„`number`ãªã©ã®åŸºæœ¬å‹ã‚’ä½¿ã„ã™ãã‚‹å•é¡Œã§ã™ã€‚

### å•é¡Œ: å‹ãŒåŒã˜ã§æ„å‘³ãŒé•ã†

```typescript
// âŒ å…¨éƒ¨ string ãªã®ã§é–“é•ãˆã¦ã‚‚æ°—ã¥ã‹ãªã„
function createUser(name: string, email: string, phone: string) { ... }

// å¼•æ•°ã®é †ç•ªã‚’é–“é•ãˆãŸï¼ã§ã‚‚ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã‚¨ãƒ©ãƒ¼ã«ãªã‚‰ãªã„
createUser("tanaka@example.com", "ç”°ä¸­å¤ªéƒ", "090-1234-5678");
```

### è§£æ±º: å€¤ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ

**å€¤ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ**ã¨ã¯ã€æ„å‘³ã®ã‚ã‚‹å˜ä½ã§å‹ã‚’ä½œã‚‹ã“ã¨ã§ã™ã€‚

```typescript
// âœ… å‹ãŒé•ã†ã®ã§é–“é•ãˆã‚‰ã‚Œãªã„
function createUser(name: UserName, email: Email, phone: PhoneNumber) { ... }

// ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã‚¨ãƒ©ãƒ¼ï¼Emailå‹ã®ã¨ã“ã‚ã« string ã‚’æ¸¡ã—ã¦ã„ã‚‹
createUser(Email.of("tanaka@example.com"), UserName.of("ç”°ä¸­"), ...);
```

**å€¤ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œã‚‹ã¹ãå ´åˆ:**
- ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆåˆ¶ç´„ãŒã‚ã‚‹ï¼ˆEmail, PhoneNumberï¼‰
- ç¯„å›²åˆ¶ç´„ãŒã‚ã‚‹ï¼ˆAge: 0-150, Percentage: 0-100ï¼‰
- ãƒ‰ãƒ¡ã‚¤ãƒ³å›ºæœ‰ã®æ„å‘³ãŒã‚ã‚‹ï¼ˆUserId, OrderIdï¼‰
- åŒã˜å‹ã®å€¤ãŒè¤‡æ•°ã‚ã£ã¦æ··åŒã—ã‚„ã™ã„ï¼ˆStartDate, EndDateï¼‰

---

## 5.4 Parameters: Max 1-2

å¼•æ•°ãŒ3å€‹ä»¥ä¸Šã«ãªã£ãŸã‚‰ã€ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«ã¾ã¨ã‚ã¾ã™ã€‚

```typescript
// âŒ å¼•æ•°ãŒå¤šã™ãã‚‹ã€é †ç•ªã‚’é–“é•ãˆã‚„ã™ã„
function createOrder(
  customerId: string,
  productId: string,
  quantity: number,
  shippingAddress: string,
  billingAddress: string,
  paymentMethod: string
) { ... }

// âœ… ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«ã¾ã¨ã‚ã‚‹
interface CreateOrderInput {
  customerId: CustomerId;
  productId: ProductId;
  quantity: Quantity;
  shipping: Address;
  billing: Address;
  paymentMethod: PaymentMethod;
}

function createOrder(input: CreateOrderInput) { ... }
```

---

## 5.5 Named Return Valuesï¼ˆã‚¿ãƒ—ãƒ«ç¦æ­¢ï¼‰

**ã‚¿ãƒ—ãƒ«**ã¨ã¯ `[Date, Date]` ã®ã‚ˆã†ã«è¤‡æ•°ã®å€¤ã‚’é…åˆ—ã§è¿”ã™ã“ã¨ã§ã™ã€‚

```typescript
// âŒ ã‚¿ãƒ—ãƒ«: ã©ã£ã¡ãŒ start ã§ã©ã£ã¡ãŒ endï¼Ÿ
function getDateRange(): [Date, Date] {
  return [startDate, endDate];  // ã¾ãŸã¯ [endDate, startDate]?
}

const [a, b] = getDateRange();
// a ãŒ startDate? endDate? åˆ†ã‹ã‚‰ãªã„

// âœ… åå‰ä»˜ãã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
function getDateRange(): { start: Date; end: Date } {
  return { start: startDate, end: endDate };
}

const range = getDateRange();
console.log(range.start, range.end);  // æ˜ç¢º
```

---

## 5.6 Tell, Don't Ask

### åŸå‰‡

> **ã€Œã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«ãƒ‡ãƒ¼ã‚¿ã‚’å•ã„åˆã‚ã›ã¦åˆ¤æ–­ã™ã‚‹ãªã€‚åˆ¤æ–­ã‚’ä¾é ¼ã›ã‚ˆã€**

ã€ŒTell, Don't Askã€ã¯ã€Pragmatic Programmers ã® Andy Hunt ã¨ Dave Thomas ãŒæå”±ã—ãŸåŸå‰‡ã§ã™ã€‚ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆæŒ‡å‘è¨­è¨ˆã®æ ¸å¿ƒã‚’çªã„ã¦ã„ã¾ã™ã€‚

```typescript
// âŒ Askï¼ˆå•ã„åˆã‚ã›ã¦åˆ¤æ–­ï¼‰
function canShip(order: Order): boolean {
  // Order ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–ã‚Šå‡ºã—ã¦ã€å¤–éƒ¨ã§åˆ¤æ–­ã—ã¦ã„ã‚‹
  if (order.getStatus() === 'paid' &&
      order.getStock() > 0 &&
      order.getShippingAddress() !== null) {
    return true
  }
  return false
}

// âœ… Tellï¼ˆåˆ¤æ–­ã‚’ä¾é ¼ï¼‰
function canShip(order: Order): boolean {
  // Order è‡ªèº«ã«åˆ¤æ–­ã‚’ä»»ã›ã‚‹
  return order.canShip()
}

class Order {
  canShip(): boolean {
    return this.status === 'paid' &&
           this.stock > 0 &&
           this.shippingAddress !== null
  }
}
```

### ãªãœ Ask ãŒãƒ€ãƒ¡ãªã®ã‹

**Feature Envyï¼ˆä»–ã‚¯ãƒ©ã‚¹ã¸ã®ç¾¨æœ›ï¼‰** ã‚’å¼•ãèµ·ã“ã—ã¾ã™ï¼š

```typescript
// âŒ Ask: Customer ã®ãƒ‡ãƒ¼ã‚¿ã°ã‹ã‚Šä½¿ã£ã¦ã„ã‚‹ï¼ˆFeature Envyï¼‰
class DiscountCalculator {
  calculate(customer: Customer): number {
    // Customer ã®å†…éƒ¨ãƒ‡ãƒ¼ã‚¿ã‚’å–ã‚Šå‡ºã—ã¦ã„ã‚‹
    const years = customer.getMembershipYears()
    const points = customer.getLoyaltyPoints()
    const purchases = customer.getTotalPurchases()
    
    if (years > 5 && points > 1000 && purchases > 50000) {
      return 0.2  // 20% OFF
    } else if (years > 3 && points > 500) {
      return 0.1  // 10% OFF
    }
    return 0
  }
}
```

**å•é¡Œç‚¹:**
1. **å‡é›†åº¦ãŒä½ã„** â€” åˆ¤æ–­ãƒ­ã‚¸ãƒƒã‚¯ãŒãƒ‡ãƒ¼ã‚¿ã‹ã‚‰é›¢ã‚Œã¦ã„ã‚‹
2. **å¤‰æ›´ã«å¼±ã„** â€” Customer ã®æ§‹é€ ãŒå¤‰ã‚ã‚‹ã¨ DiscountCalculator ã‚‚å¤‰æ›´
3. **å†åˆ©ç”¨ã§ããªã„** â€” åŒã˜åˆ¤æ–­ãŒå¿…è¦ãªåˆ¥ã®å ´æ‰€ã§ã‚³ãƒ”ãƒšç™ºç”Ÿ
4. **ã‚«ãƒ—ã‚»ãƒ«åŒ–é•å** â€” Customer ã®å†…éƒ¨æ§‹é€ ã‚’å¤–éƒ¨ãŒçŸ¥ã‚Šã™ãã¦ã„ã‚‹

### Tell ã®å®Ÿè£…ãƒ‘ã‚¿ãƒ¼ãƒ³

```typescript
// âœ… Tell: ãƒ­ã‚¸ãƒƒã‚¯ã‚’ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´æ‰€ã«ç§»å‹•
class Customer {
  private readonly membershipYears: number
  private readonly loyaltyPoints: number
  private readonly totalPurchases: number
  
  // åˆ¤æ–­ãƒ­ã‚¸ãƒƒã‚¯ã¯ãƒ‡ãƒ¼ã‚¿ã¨ä¸€ç·’ã«ã‚ã‚‹
  discountRate(): number {
    if (this.isVIP()) {
      return 0.2
    } else if (this.isRegular()) {
      return 0.1
    }
    return 0
  }
  
  private isVIP(): boolean {
    return this.membershipYears > 5 &&
           this.loyaltyPoints > 1000 &&
           this.totalPurchases > 50000
  }
  
  private isRegular(): boolean {
    return this.membershipYears > 3 &&
           this.loyaltyPoints > 500
  }
}

// ä½¿ã†å´ã¯ã‚·ãƒ³ãƒ—ãƒ«
class DiscountCalculator {
  calculate(customer: Customer): number {
    return customer.discountRate()  // Tell!
  }
}
```

### Anemic Domain Modelï¼ˆè²§è¡€ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ¢ãƒ‡ãƒ«ï¼‰

ã€ŒAskã€ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’å¤šç”¨ã™ã‚‹ã¨ã€**è²§è¡€ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ¢ãƒ‡ãƒ«**ã«ãªã‚Šã¾ã™ï¼š

| è²§è¡€ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ¢ãƒ‡ãƒ« | Rich Domain Model |
|------------------|-------------------|
| ãƒ‡ãƒ¼ã‚¿ã ã‘æŒã¤ã‚¯ãƒ©ã‚¹ | ãƒ‡ãƒ¼ã‚¿ + ãƒ­ã‚¸ãƒƒã‚¯ |
| Service ãŒãƒ­ã‚¸ãƒƒã‚¯ã‚’æŒã¤ | ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒãƒ­ã‚¸ãƒƒã‚¯ã‚’æŒã¤ |
| getter ã ã‚‰ã‘ | æ„å‘³ã®ã‚ã‚‹ãƒ¡ã‚½ãƒƒãƒ‰ |
| æ‰‹ç¶šãå‹ã®è¨­è¨ˆ | ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆæŒ‡å‘ã®è¨­è¨ˆ |

```typescript
// âŒ è²§è¡€ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ¢ãƒ‡ãƒ«
class Order {
  status: string
  items: OrderItem[]
  shippingAddress: Address | null
}

class OrderService {
  canShip(order: Order): boolean { /* ... */ }
  calculateTotal(order: Order): Money { /* ... */ }
  addItem(order: Order, item: OrderItem): void { /* ... */ }
}

// âœ… Rich Domain Model
class Order {
  constructor(
    private readonly status: OrderStatus,
    private readonly items: OrderItem[],
    private readonly shippingAddress: Address | null
  ) {}
  
  canShip(): boolean { /* ... */ }
  total(): Money { /* ... */ }
  withItem(item: OrderItem): Order { /* ... */ }
}
```

### æœ¬ã‚¹ã‚­ãƒ«ã¨ã®é–¢ä¿‚

| æœ¬ã‚¹ã‚­ãƒ«ã®ãƒ«ãƒ¼ãƒ« | Tell, Don't Ask ã¨ã®é–¢ä¿‚ |
|----------------|-------------------------|
| **Transition ã‚¯ãƒ©ã‚¹** | ãƒ­ã‚¸ãƒƒã‚¯ã‚’ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«æŒãŸã›ã‚‹ |
| **getter ç¦æ­¢** | Ask ã‚’å¼·åˆ¶çš„ã«é˜²ã |
| **1ã‚¯ãƒ©ã‚¹1ãƒ‘ãƒ–ãƒªãƒƒã‚¯ãƒ¡ã‚½ãƒƒãƒ‰** | æ„å‘³ã®ã‚ã‚‹æ“ä½œã ã‘ã‚’å…¬é–‹ |
| **4åˆ†é¡** | Service å±¤ã®è‚¥å¤§åŒ–ï¼ˆè²§è¡€ãƒ¢ãƒ‡ãƒ«ï¼‰ã‚’é˜²ã |

---

## 5.7 Law of Demeterï¼ˆãƒ‡ãƒ¡ãƒ†ãƒ«ã®æ³•å‰‡ï¼‰

### åŸå‰‡

> **ã€Œç›´æ¥ã®å‹é”ã¨ã ã‘è©±ã›ã€**

Law of Demeterï¼ˆãƒ‡ãƒ¡ãƒ†ãƒ«ã®æ³•å‰‡ï¼‰ã¯ã€1987å¹´ã«ãƒãƒ¼ã‚¹ã‚¤ãƒ¼ã‚¹ã‚¿ãƒ³å¤§å­¦ã® Demeter ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§æå”±ã•ã‚ŒãŸè¨­è¨ˆåŸå‰‡ã§ã™ã€‚ã€Œæœ€å°çŸ¥è­˜ã®åŸå‰‡ï¼ˆPrinciple of Least Knowledgeï¼‰ã€ã¨ã‚‚å‘¼ã°ã‚Œã¾ã™ã€‚

**æ­£å¼ãªå®šç¾©:**
ãƒ¡ã‚½ãƒƒãƒ‰ M ãŒå‘¼ã³å‡ºã›ã‚‹ã®ã¯ã€ä»¥ä¸‹ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ¡ã‚½ãƒƒãƒ‰ã ã‘ï¼š
1. M ã‚’æŒã¤ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆè‡ªèº«ï¼ˆ`this`ï¼‰
2. M ã®å¼•æ•°ã¨ã—ã¦æ¸¡ã•ã‚ŒãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
3. M å†…ã§ç”Ÿæˆã•ã‚ŒãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
4. M ã‚’æŒã¤ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰

```typescript
// âŒ ãƒ‡ãƒ¡ãƒ†ãƒ«ã®æ³•å‰‡é•å: ã€Œå‹é”ã®å‹é”ã€ã¨è©±ã—ã¦ã„ã‚‹
class OrderProcessor {
  process(order: Order): void {
    // order.getCustomer().getAddress().getCity() â€” 3æ®µéšã®ãƒ‰ãƒƒãƒˆãƒã‚§ãƒ¼ãƒ³
    const city = order.getCustomer().getAddress().getCity()
    // Order ã®å†…éƒ¨æ§‹é€ ã‚’çŸ¥ã‚Šã™ãã¦ã„ã‚‹
  }
}

// âœ… ãƒ‡ãƒ¡ãƒ†ãƒ«ã®æ³•å‰‡éµå®ˆ: ç›´æ¥ã®å‹é”ï¼ˆorderï¼‰ã¨ã ã‘è©±ã™
class OrderProcessor {
  process(order: Order): void {
    const city = order.shippingCity()  // Order ã«èã
  }
}

class Order {
  shippingCity(): string {
    return this.customer.shippingCity()  // Customer ã«å§”è­²
  }
}

class Customer {
  shippingCity(): string {
    return this.address.city  // Address ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’è¿”ã™
  }
}
```

### ãªãœãƒ‰ãƒƒãƒˆãƒã‚§ãƒ¼ãƒ³ãŒãƒ€ãƒ¡ãªã®ã‹

**çµåˆåº¦ãŒé«˜ããªã‚‹:**

```typescript
// âŒ order.getCustomer().getAddress().getCity()
// å•é¡Œ: OrderProcessor ã¯ Order, Customer, Address ã®3ã¤ã«ä¾å­˜ã—ã¦ã„ã‚‹

// Address ã®æ§‹é€ ãŒå¤‰ã‚ã£ãŸã‚‰ï¼Ÿ
// - Address.city â†’ Address.location.cityName ã«å¤‰æ›´
// - OrderProcessor ã‚‚ä¿®æ­£ãŒå¿…è¦ï¼ï¼ˆæœ¬æ¥é–¢ä¿‚ãªã„ã®ã«ï¼‰
```

**ã‚«ãƒ—ã‚»ãƒ«åŒ–é•å:**

```typescript
// âŒ å†…éƒ¨æ§‹é€ ã‚’çŸ¥ã‚Šã™ãã¦ã„ã‚‹
order.getCustomer().getWallet().getBalance().isGreaterThan(price)

// å•é¡Œ:
// 1. Order ãŒ Customer ã‚’æŒã¤ã“ã¨ã‚’çŸ¥ã£ã¦ã„ã‚‹
// 2. Customer ãŒ Wallet ã‚’æŒã¤ã“ã¨ã‚’çŸ¥ã£ã¦ã„ã‚‹
// 3. Wallet ãŒ Balance ã‚’æŒã¤ã“ã¨ã‚’çŸ¥ã£ã¦ã„ã‚‹
// 4. Balance ã« isGreaterThan ãŒã‚ã‚‹ã“ã¨ã‚’çŸ¥ã£ã¦ã„ã‚‹
// â†’ 4ã¤ã®ã‚¯ãƒ©ã‚¹ã®å†…éƒ¨æ§‹é€ ã«ä¾å­˜ï¼
```

### ãƒ‰ãƒƒãƒˆãƒã‚§ãƒ¼ãƒ³ã®ãƒ«ãƒ¼ãƒ«ï¼ˆSKILL.md ã‚ˆã‚Šï¼‰

æœ¬ã‚¹ã‚­ãƒ«ã§ã¯ã€ãƒ‰ãƒƒãƒˆãƒã‚§ãƒ¼ãƒ³ã«ã¤ã„ã¦ä»¥ä¸‹ã®ãƒ«ãƒ¼ãƒ«ã‚’è¨­ã‘ã¦ã„ã¾ã™ï¼š

| ã‚±ãƒ¼ã‚¹ | è¨±å®¹ | ç†ç”± |
|--------|:----:|------|
| `order.customer.address.city` | âŒ | ä»–ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®å†…éƒ¨æ§‹é€ ã‚’çŸ¥ã‚Šã™ã |
| `order.items.filter(...).map(...)` | âœ… | åŒä¸€ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã® fluent interface |
| `result.map(...).flatMap(...)` | âœ… | åŒä¸€å‹ã®ãƒ¢ãƒŠãƒ‰ãƒã‚§ãƒ¼ãƒ³ |
| `builder.setA(...).setB(...).build()` | âœ… | Builder ãƒ‘ã‚¿ãƒ¼ãƒ³ |

### è§£æ±ºç­–: å§”è­²ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½œã‚‹

```typescript
// âŒ é•å
const total = order.getItems().reduce((sum, item) => 
  sum + item.getProduct().getPrice() * item.getQuantity(), 0)

// âœ… éµå®ˆ
const total = order.total()

class Order {
  total(): Money {
    return this.items.reduce((sum, item) => sum.add(item.subtotal()), Money.zero())
  }
}

class OrderItem {
  subtotal(): Money {
    return this.product.price.multiply(this.quantity)
  }
}
```

### ãƒ‡ãƒ¡ãƒ†ãƒ«ã®æ³•å‰‡ã¨ Tell, Don't Ask ã®é–¢ä¿‚

ä¸¡è€…ã¯åŒã˜å•é¡Œã‚’ç•°ãªã‚‹è§’åº¦ã‹ã‚‰è¦‹ã¦ã„ã¾ã™ï¼š

| åŸå‰‡ | è¦–ç‚¹ | ç¦æ­¢ã™ã‚‹ã“ã¨ |
|------|------|------------|
| **Tell, Don't Ask** | ã€Œä½•ã‚’ã€ | ãƒ‡ãƒ¼ã‚¿ã‚’å–ã‚Šå‡ºã—ã¦å¤–éƒ¨ã§åˆ¤æ–­ã™ã‚‹ã“ã¨ |
| **Law of Demeter** | ã€Œèª°ã¨ã€ | ç›´æ¥ã®å‹é”ä»¥å¤–ã¨ä¼šè©±ã™ã‚‹ã“ã¨ |

```typescript
// ä¸¡æ–¹é•åã—ã¦ã„ã‚‹ä¾‹
function isEligibleForDiscount(order: Order): boolean {
  // Law of Demeter é•å: order â†’ customer â†’ loyalty â†’ points
  // Tell, Don't Ask é•å: ãƒ‡ãƒ¼ã‚¿ã‚’å–ã‚Šå‡ºã—ã¦å¤–éƒ¨ã§åˆ¤æ–­
  return order.getCustomer().getLoyalty().getPoints() > 1000
}

// ä¸¡æ–¹éµå®ˆã—ã¦ã„ã‚‹ä¾‹
function isEligibleForDiscount(order: Order): boolean {
  return order.customerIsEligibleForDiscount()  // Tell + ç›´æ¥ã®å‹é”
}
```

### æœ¬ã‚¹ã‚­ãƒ«ã¨ã®é–¢ä¿‚

| æœ¬ã‚¹ã‚­ãƒ«ã®ãƒ«ãƒ¼ãƒ« | Law of Demeter ã¨ã®é–¢ä¿‚ |
|----------------|------------------------|
| **ãƒ‰ãƒƒãƒˆãƒã‚§ãƒ¼ãƒ³ã®ãƒ«ãƒ¼ãƒ«** | ãƒ‡ãƒ¡ãƒ†ãƒ«ã®æ³•å‰‡ã‚’å…·ä½“åŒ– |
| **getter ç¦æ­¢** | ãƒ‰ãƒƒãƒˆãƒã‚§ãƒ¼ãƒ³ã‚’æ§‹é€ çš„ã«é˜²ã |
| **å§”è­²ãƒ¡ã‚½ãƒƒãƒ‰** | é•åã‚’è§£æ¶ˆã™ã‚‹æ‰‹æ®µ |
| **Rich Domain Model** | å¿…è¦ãªæ“ä½œã‚’ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«æŒãŸã›ã‚‹ |

### ä¾‹å¤–: Fluent Interface

ãƒ¡ã‚½ãƒƒãƒ‰ãƒã‚§ãƒ¼ãƒ³ã§ã‚‚ã€**åŒã˜å‹ã‚’è¿”ã—ç¶šã‘ã‚‹**å ´åˆã¯è¨±å®¹ã•ã‚Œã¾ã™ï¼š

```typescript
// âœ… è¨±å®¹: åŒã˜å‹ï¼ˆStreamï¼‰ã‚’è¿”ã—ç¶šã‘ã‚‹
users
  .filter(u => u.isActive)
  .map(u => u.email)
  .filter(e => e.endsWith('@company.com'))

// âœ… è¨±å®¹: Builder ãƒ‘ã‚¿ãƒ¼ãƒ³
new OrderBuilder()
  .withCustomer(customer)
  .withItems(items)
  .withShipping(address)
  .build()

// âœ… è¨±å®¹: Result ãƒã‚§ãƒ¼ãƒ³
parseInput(raw)
  .flatMap(validate)
  .map(transform)
  .unwrapOr(defaultValue)
```

**ãªãœè¨±å®¹ã•ã‚Œã‚‹ã‹:**
- å„ãƒ¡ã‚½ãƒƒãƒ‰ãŒåŒã˜å‹ï¼ˆã¾ãŸã¯åŒã˜ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ï¼‰ã‚’è¿”ã™
- å†…éƒ¨æ§‹é€ ã®è©³ç´°ã‚’æš´éœ²ã—ã¦ã„ãªã„
- å¤‰æ›´ãŒã‚ã£ã¦ã‚‚å½±éŸ¿ç¯„å›²ãŒé™å®šã•ã‚Œã‚‹

---

# Part 6: ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

## 6.1 Screaming Architecture

**Screaming Architecture**ã¨ã¯ã€ã€Œãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ ã‚’è¦‹ã‚Œã°ä½•ã®ã‚·ã‚¹ãƒ†ãƒ ã‹åˆ†ã‹ã‚‹ã€è¨­è¨ˆã§ã™ã€‚

### ãªãœ Screaming Architecture ãªã®ã‹ â€” 4ã¤ã®ä»£æ›¿æ¡ˆã¨ã®æ¯”è¼ƒ

ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ ã«ã¯4ã¤ã®è¨­è¨ˆæ–¹æ³•ãŒã‚ã‚Šã¾ã™ï¼š

| æ–¹æ³• | æ¦‚è¦ | æ¡ç”¨ |
|------|------|:----:|
| **â‘  æŠ€è¡“ãƒ¬ã‚¤ãƒ¤ãƒ¼åˆ†å‰²** | `controllers/`, `services/`, `repositories/` | âŒ |
| **â‘¡ æ©Ÿèƒ½ãƒ™ãƒ¼ã‚¹åˆ†å‰²ï¼ˆScreamingï¼‰** | `catalog/`, `ordering/`, `payments/` | âœ… |
| **â‘¢ Hexagonal Architecture** | `adapters/`, `ports/`, `domain/` | â–³ æ¡ä»¶ä»˜ã |
| **â‘£ Clean Architectureï¼ˆ4å±¤ï¼‰** | `entities/`, `use-cases/`, `interface-adapters/`, `frameworks/` | âŒ |

---

#### âŒ æ¡ˆâ‘  æŠ€è¡“ãƒ¬ã‚¤ãƒ¤ãƒ¼åˆ†å‰²ã‚’æ¡ç”¨ã—ãªã‹ã£ãŸç†ç”±

```
æŠ€è¡“ãƒ¬ã‚¤ãƒ¤ãƒ¼åˆ†å‰²
src/
â”œâ”€â”€ controllers/     # ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ï¼Ÿä½•ã®ï¼Ÿ
â”œâ”€â”€ services/        # ã‚µãƒ¼ãƒ“ã‚¹ï¼Ÿä½•ã®ï¼Ÿ
â”œâ”€â”€ repositories/    # ãƒªãƒã‚¸ãƒˆãƒªï¼Ÿä½•ã®ï¼Ÿ
â””â”€â”€ entities/        # ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ï¼Ÿä½•ã®ï¼Ÿ
```

**å•é¡Œ1: ä½•ã®ã‚·ã‚¹ãƒ†ãƒ ã‹åˆ†ã‹ã‚‰ãªã„**

ã“ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ ã‚’è¦‹ã¦ã€ECã‚µã‚¤ãƒˆãªã®ã‹ã€ç¤¾å†…ã‚·ã‚¹ãƒ†ãƒ ãªã®ã‹ã€SNSãªã®ã‹åˆ†ã‹ã‚Šã¾ã™ã‹ï¼Ÿ

**å•é¡Œ2: 1æ©Ÿèƒ½ä¿®æ­£ã§5ãƒ•ã‚©ãƒ«ãƒ€é–‹ã**

**å‡ºå…¸: "6 Months with Feature-Based Folder Structure â€” Why I'm Not Going Back"**
> "Editing one feature required opening 5+ folders. Structure became difficult for maintenance."

```
ã€Œç¨Ÿè­°æ©Ÿèƒ½ã‚’ä¿®æ­£ã€ã™ã‚‹ãŸã‚ã«é–‹ããƒ•ã‚©ãƒ«ãƒ€ï¼š
1. controllers/RingiController.ts
2. services/RingiService.ts
3. repositories/RingiRepository.ts
4. entities/Ringi.ts
5. dto/RingiDto.ts
6. validators/RingiValidator.ts
â†’ 6ãƒ•ã‚¡ã‚¤ãƒ«ãŒ6ç®‡æ‰€ã«æ•£ã‚‰ã°ã£ã¦ã„ã‚‹
```

**å•é¡Œ3: æ©Ÿèƒ½å‰Šé™¤ã§æ¼ã‚ŒãŒç™ºç”Ÿ**

```
ã€Œç¨Ÿè­°æ©Ÿèƒ½ã‚’å‰Šé™¤ã€ã—ãŸã¨ãï¼š
âœ… controllers/RingiController.ts    å‰Šé™¤ã—ãŸ
âœ… services/RingiService.ts          å‰Šé™¤ã—ãŸ
âŒ repositories/RingiRepository.ts   å¿˜ã‚ŒãŸï¼
âŒ entities/Ringi.ts                 å¿˜ã‚ŒãŸï¼
â†’ æ­»ã‚“ã ã‚³ãƒ¼ãƒ‰ãŒæ®‹ã‚‹
```

**å•é¡Œ4: ã‚ªãƒ³ãƒœãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãŒé…ã„**

æ–°ãƒ¡ãƒ³ãƒãƒ¼ï¼šã€Œç¨Ÿè­°æ©Ÿèƒ½ã®ã‚³ãƒ¼ãƒ‰ã©ã“ã§ã™ã‹ï¼Ÿã€
å›ç­”ï¼šã€Œãˆãƒ¼ã¨ã€controllers ã¨ services ã¨ repositories ã¨ entities ã¨ dto ã¨ validators ã‚’è¦‹ã¦...ã€

---

#### â–³ æ¡ˆâ‘¢ Hexagonal Architecture â€” æ¡ä»¶ä»˜ãã§æ¡ç”¨

```
Hexagonalï¼ˆãƒãƒ¼ãƒˆï¼†ã‚¢ãƒ€ãƒ—ã‚¿ãƒ¼ï¼‰
src/
â”œâ”€â”€ adapters/
â”‚   â”œâ”€â”€ web/
â”‚   â”œâ”€â”€ persistence/
â”‚   â””â”€â”€ messaging/
â”œâ”€â”€ ports/
â”‚   â”œâ”€â”€ inbound/
â”‚   â””â”€â”€ outbound/
â””â”€â”€ domain/
```

**åˆ©ç‚¹:** å¤–éƒ¨ã‚·ã‚¹ãƒ†ãƒ ã¨ã®æ¥ç‚¹ï¼ˆã‚¢ãƒ€ãƒ—ã‚¿ãƒ¼ï¼‰ãŒæ˜ç¢ºã«åˆ†é›¢ã•ã‚Œã‚‹ã€‚

**å•é¡Œ: å°ã€œä¸­è¦æ¨¡ã«ã¯éå‰°**

```
ã€Œç¨Ÿè­°æ©Ÿèƒ½ã‚’è¿½åŠ ã€ã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«æ•°ï¼š
- domain/ringi/Ringi.ts
- domain/ringi/RingiService.ts
- ports/inbound/RingiUseCase.ts
- ports/outbound/RingiRepository.ts
- adapters/web/RingiController.ts
- adapters/persistence/PostgresRingiRepository.ts
â†’ 6ãƒ•ã‚¡ã‚¤ãƒ«ä»¥ä¸Šã€3éšå±¤

ã‚·ãƒ³ãƒ—ãƒ«ãªCRUDã‚¢ãƒ—ãƒªã«ã¯é‡ã™ãã‚‹
```

**Hexagonal ã‚’è¨±å®¹ã™ã‚‹å ´åˆ:**
- è¤‡æ•°ã®å…¥åŠ›ãƒãƒ£ãƒãƒ«ï¼ˆWeb, CLI, Queue, gRPCï¼‰ãŒã‚ã‚‹
- è¤‡æ•°ã®æ°¸ç¶šåŒ–å…ˆï¼ˆPostgreSQL, MongoDB, å¤–éƒ¨APIï¼‰ãŒã‚ã‚‹
- ãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹ã§å¢ƒç•ŒãŒé‡è¦

---

#### âŒ æ¡ˆâ‘£ Clean Architectureï¼ˆ4å±¤ï¼‰ã‚’æ¡ç”¨ã—ãªã‹ã£ãŸç†ç”±

```
Clean Architecture
src/
â”œâ”€â”€ entities/           # Enterprise Business Rules
â”œâ”€â”€ use-cases/          # Application Business Rules
â”œâ”€â”€ interface-adapters/ # Controllers, Presenters, Gateways
â””â”€â”€ frameworks/         # Web, DB, External
```

**å•é¡Œ1: éå‰°ãªå±¤åˆ†ã‘**

ã€Œç¨Ÿè­°ã‚’ç”³è«‹ã™ã‚‹ã€ã ã‘ã§4ãƒ•ã‚¡ã‚¤ãƒ«ä»¥ä¸Šï¼š

```
entities/Ringi.ts
use-cases/SubmitRingiUseCase.ts
interface-adapters/RingiController.ts
interface-adapters/RingiPresenter.ts
frameworks/web/ExpressRingiRouter.ts
frameworks/persistence/PostgresRingiRepository.ts
```

**å•é¡Œ2: ã€Œã©ã®å±¤ã«ç½®ãã‹ã€ã§å»¶ã€…ã¨è­°è«–**

ã€Œã“ã®ãƒ­ã‚¸ãƒƒã‚¯ã¯ Entityï¼ŸUseCaseï¼ŸAdapterï¼Ÿã€

**Clean Architecture ã‚’è¨±å®¹ã™ã‚‹å ´åˆ:**
- å¤§è¦æ¨¡ã‚¨ãƒ³ã‚¿ãƒ¼ãƒ—ãƒ©ã‚¤ã‚ºã‚·ã‚¹ãƒ†ãƒ 
- è¤‡æ•°ãƒãƒ¼ãƒ ãŒåŒä¸€ã‚³ãƒ¼ãƒ‰ãƒ™ãƒ¼ã‚¹ã§ä½œæ¥­
- ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ä¹—ã‚Šæ›ãˆãŒäºˆå®šã•ã‚Œã¦ã„ã‚‹

---

#### âœ… æ¡ˆâ‘¡ Screaming Architecture ã‚’æ¡ç”¨ã—ãŸç†ç”±

```
Screaming Architectureï¼ˆæ©Ÿèƒ½ãƒ™ãƒ¼ã‚¹ï¼‰
src/
â”œâ”€â”€ catalog/      # å•†å“ã‚«ã‚¿ãƒ­ã‚°
â”œâ”€â”€ ordering/     # æ³¨æ–‡ç®¡ç†
â”œâ”€â”€ customers/    # é¡§å®¢ç®¡ç†
â””â”€â”€ payments/     # æ±ºæ¸ˆ
```

| ãƒ¡ãƒªãƒƒãƒˆ | èª¬æ˜ |
|---------|------|
| **ä½•ã®ã‚·ã‚¹ãƒ†ãƒ ã‹ä¸€ç›®ã§åˆ†ã‹ã‚‹** | ECã‚µã‚¤ãƒˆã ï¼ç¨Ÿè­°ã‚·ã‚¹ãƒ†ãƒ ã ï¼ |
| **1æ©Ÿèƒ½ = 1ãƒ•ã‚©ãƒ«ãƒ€** | é–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«ãŒ1ç®‡æ‰€ã«ã¾ã¨ã¾ã‚‹ |
| **å‰Šé™¤ãŒç°¡å˜** | ãƒ•ã‚©ãƒ«ãƒ€ã”ã¨å‰Šé™¤ã™ã‚Œã°å®Œäº† |
| **ã‚ªãƒ³ãƒœãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãŒé€Ÿã„** | ã€Œç¨Ÿè­°ã¯ `src/ringis/` ã‚’è¦‹ã¦ã€ |

**React/Next.js ã§ã®é©ç”¨ä¾‹:**

```
âŒ æŠ€è¡“ãƒ¬ã‚¤ãƒ¤ãƒ¼
src/
â”œâ”€â”€ components/   # ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆï¼Ÿä½•ã®ï¼Ÿ
â”œâ”€â”€ hooks/        # ãƒ•ãƒƒã‚¯ï¼Ÿä½•ã®ï¼Ÿ
â”œâ”€â”€ utils/        # ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ï¼Ÿä½•ã®ï¼Ÿ
â””â”€â”€ services/     # ã‚µãƒ¼ãƒ“ã‚¹ï¼Ÿä½•ã®ï¼Ÿ

âœ… æ©Ÿèƒ½ãƒ™ãƒ¼ã‚¹
src/
â”œâ”€â”€ catalog/
â”‚   â”œâ”€â”€ ProductList.tsx
â”‚   â”œâ”€â”€ useProducts.ts
â”‚   â””â”€â”€ productApi.ts
â”œâ”€â”€ cart/
â”‚   â”œâ”€â”€ CartView.tsx
â”‚   â””â”€â”€ useCart.ts
â””â”€â”€ checkout/
    â””â”€â”€ ...
```

---

### Screaming Architecture ã®æ¬ ç‚¹ã¨å¯¾å‡¦æ³•

**æ¬ ç‚¹1: å…±é€šã‚³ãƒ¼ãƒ‰ã©ã“ã«ç½®ãï¼Ÿ**

```
src/
â”œâ”€â”€ catalog/
â”œâ”€â”€ ordering/
â””â”€â”€ shared/     # å…±é€šã‚³ãƒ¼ãƒ‰ â†’ ã“ã“ãŒè‚¥å¤§åŒ–ã—ãŒã¡
```

**å¯¾å‡¦:** `shared/` ã¯ã€Œ2ã¤ä»¥ä¸Šã®æ©Ÿèƒ½ã§ä½¿ã‚ã‚Œã‚‹ã“ã¨ãŒç¢ºå®šã—ãŸã‚‚ã®ã€ã ã‘ã€‚æœ€åˆã‹ã‚‰å…±é€šåŒ–ã—ãªã„ã€‚

**æ¬ ç‚¹2: æ©Ÿèƒ½é–“ã®ä¾å­˜ãŒè¦‹ãˆã«ãã„**

```typescript
// âŒ catalog ãŒ ordering ã«ä¾å­˜ã—ã¦ã„ã‚‹ã“ã¨ã«æ°—ã¥ãã«ãã„
import { OrderItem } from '../ordering/OrderItem';
```

**å¯¾å‡¦:** ã‚¤ãƒ³ãƒãƒ¼ãƒˆæ™‚ã«æ˜ç¤ºçš„ãªä¾å­˜ã‚’æ„è­˜ã€‚å¾ªç’°ä¾å­˜ã¯ç¦æ­¢ã€‚

**å‡ºå…¸: "Layered Architecture vs Feature Folders"**
> "While Layered Architecture is safe and predictable, it led to slower delivery and higher cognitive load. After six months, onboarding became painful."

---

## 6.2 ç¦æ­¢: æŠ€è¡“ãƒ¬ã‚¤ãƒ¤ãƒ¼åã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª

**ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå**ã«ä»¥ä¸‹ã‚’ä½¿ã‚ãªã„ï¼š

```
âŒ domain/ infrastructure/ application/ 
âŒ services/ repositories/ controllers/
âŒ utils/ helpers/ common/ shared/
```

**ãƒ•ã‚¡ã‚¤ãƒ«åãƒ»ã‚¯ãƒ©ã‚¹å**ã«ã¯ä½¿ã£ã¦OKï¼š

```
âœ… RingiRepository.ts ï¼ˆãƒ•ã‚¡ã‚¤ãƒ«åï¼‰
âœ… class RingiController ï¼ˆã‚¯ãƒ©ã‚¹åï¼‰
âŒ repositories/RingiRepository.ts ï¼ˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªåã¯NGï¼‰
```

---

## 6.3 MECE Tree ã¨ Rule of 5

**MECEï¼ˆãƒŸãƒ¼ã‚·ãƒ¼ï¼‰**ã¨ã¯ã€ã€ŒMutually Exclusive, Collectively Exhaustiveã€ã®ç•¥ã§ã€ã€Œé‡è¤‡ãªãã€æ¼ã‚Œãªãã€ã¨ã„ã†æ„å‘³ã§ã™ã€‚

- å„ãƒ•ã‚¡ã‚¤ãƒ«/ã‚¯ãƒ©ã‚¹ã¯1ã¤ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ã®ã¿å±ã™ã‚‹ï¼ˆé‡è¤‡ãªã—ï¼‰
- å…¨ã¦ã®ãƒ•ã‚¡ã‚¤ãƒ«/ã‚¯ãƒ©ã‚¹ãŒã„ãšã‚Œã‹ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«å±ã™ã‚‹ï¼ˆæ¼ã‚Œãªã—ï¼‰

**Rule of 5**: å„ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ç›´æ¥ã®å­ã¯5ã¤ä»¥ä¸‹ã«ã€‚è¶…ãˆãŸã‚‰éšå±¤åŒ–ã‚’æ¤œè¨ã€‚

```
âŒ å¤šã™ãã‚‹
src/
â”œâ”€â”€ users/
â”œâ”€â”€ products/
â”œâ”€â”€ orders/
â”œâ”€â”€ payments/
â”œâ”€â”€ shipping/
â”œâ”€â”€ reviews/
â”œâ”€â”€ wishlists/
â”œâ”€â”€ coupons/
â”œâ”€â”€ notifications/
â””â”€â”€ ... (10å€‹ä»¥ä¸Š)

âœ… éšå±¤åŒ–ã§æ•´ç†
src/
â”œâ”€â”€ commerce/           # ECã‚³ã‚¢æ©Ÿèƒ½
â”‚   â”œâ”€â”€ catalog/
â”‚   â”œâ”€â”€ ordering/
â”‚   â””â”€â”€ payments/
â”œâ”€â”€ customer-experience/ # é¡§å®¢ä½“é¨“
â”‚   â”œâ”€â”€ reviews/
â”‚   â”œâ”€â”€ wishlists/
â”‚   â””â”€â”€ notifications/
â””â”€â”€ operations/         # é‹ç”¨æ©Ÿèƒ½
    â””â”€â”€ ...
```

---

## 6.4 Colocation

**Colocationï¼ˆã‚³ãƒ­ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰**ã¨ã¯ã€é–¢é€£ã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’åŒã˜ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«é…ç½®ã™ã‚‹ã“ã¨ã§ã™ã€‚

```
âœ… ãƒ†ã‚¹ãƒˆã¯ã‚½ãƒ¼ã‚¹ã¨åŒå±…
src/ringis/
â”œâ”€â”€ DraftRingi.ts          # æœ¬ä½“
â”œâ”€â”€ DraftRingi.test.ts     # ãƒ†ã‚¹ãƒˆï¼ˆéš£ã«ï¼‰
â”œâ”€â”€ SubmittedRingi.ts
â”œâ”€â”€ SubmittedRingi.test.ts
â””â”€â”€ RingiTestFactory.ts    # ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ç”Ÿæˆ

âŒ ãƒ†ã‚¹ãƒˆãŒåˆ¥ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
src/
â””â”€â”€ ringis/
    â”œâ”€â”€ DraftRingi.ts
    â””â”€â”€ SubmittedRingi.ts
tests/
â””â”€â”€ ringis/
    â”œâ”€â”€ DraftRingi.test.ts   # é›¢ã‚ŒãŸå ´æ‰€ã«
    â””â”€â”€ SubmittedRingi.test.ts
```

**ãªãœåŒå±…ã•ã›ã‚‹ã‹:**
- ãƒ•ã‚¡ã‚¤ãƒ«æ¢ã—ãŒæ¥½ï¼ˆåŒã˜ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ã‚ã‚‹ï¼‰
- ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°æ™‚ã«1ç®‡æ‰€ã ã‘ä¿®æ­£ã™ã‚Œã°ã„ã„
- å‰Šé™¤æ™‚ã«ãƒ†ã‚¹ãƒˆã‚‚ä¸€ç·’ã«å‰Šé™¤ã•ã‚Œã‚‹ï¼ˆå¿˜ã‚Œãªã„ï¼‰

---

# Part 7: ãƒ†ã‚¹ãƒˆæˆ¦ç•¥

## 7.1 ãªãœ InMemory å®Ÿè£…ãªã®ã‹ â€” 4ã¤ã®ä»£æ›¿æ¡ˆã¨ã®æ¯”è¼ƒ

å¤–éƒ¨ãƒªã‚½ãƒ¼ã‚¹ï¼ˆRepositoryç­‰ï¼‰ã®ãƒ†ã‚¹ãƒˆã«ã¯4ã¤ã®æ–¹æ³•ãŒã‚ã‚Šã¾ã™ï¼š

| æ–¹æ³• | æ¦‚è¦ | æ¡ç”¨ |
|------|------|:----:|
| **â‘  Mock ãƒ©ã‚¤ãƒ–ãƒ©ãƒª** | `jest.mock()`, `mockito` ã§æŒ¯ã‚‹èˆã„ã‚’å®šç¾© | âŒ |
| **â‘¡ Stub ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ** | å›ºå®šå€¤ã‚’è¿”ã™ã ã‘ã®å®Ÿè£… | â–³ é™å®šçš„ |
| **â‘¢ InMemory å®Ÿè£…** | ãƒ¡ãƒ¢ãƒªä¸Šã§å‹•ä½œã™ã‚‹å®Œå…¨ãªå®Ÿè£… | âœ… |
| **â‘£ Test Containers** | Docker ã§æœ¬ç‰©ã®DBã‚’èµ·å‹• | â–³ çµ±åˆãƒ†ã‚¹ãƒˆç”¨ |

---

#### âŒ æ¡ˆâ‘  Mock ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’æ¡ç”¨ã—ãªã‹ã£ãŸç†ç”±

```typescript
// Mock ãƒ©ã‚¤ãƒ–ãƒ©ãƒªæ–¹å¼
test('ç¨Ÿè­°ã‚’ç”³è«‹ã§ãã‚‹', async () => {
  const mockRepository = {
    save: jest.fn().mockResolvedValue(undefined),
    findById: jest.fn().mockResolvedValue(null),
  };
  
  const draft = new DraftRingi(id, data);
  await draft.submit(mockRepository, clock);
  
  expect(mockRepository.save).toHaveBeenCalledWith(/* ... */);
});
```

**å•é¡Œ1: å®Ÿè£…ã®è©³ç´°ã«ä¾å­˜ã™ã‚‹**

```typescript
// âŒ ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ã™ã‚‹ã¨ãƒ†ã‚¹ãƒˆãŒå£Šã‚Œã‚‹
// Before: save ã‚’1å›å‘¼ã‚“ã§ã„ãŸ
expect(mockRepository.save).toHaveBeenCalledTimes(1);

// After: å†…éƒ¨ã§ãƒãƒƒãƒå‡¦ç†ã«å¤‰æ›´ â†’ save ã‚’2å›å‘¼ã¶ã‚ˆã†ã«
// ãƒ†ã‚¹ãƒˆã¯å¤±æ•—ã™ã‚‹ãŒã€ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã¯æ­£ã—ã„
```

**å•é¡Œ2: ãƒ¢ãƒƒã‚¯ã®è¨­å®šæ¼ã‚Œ**

```typescript
// âŒ findById ã‚’ãƒ¢ãƒƒã‚¯å¿˜ã‚Œ
const mockRepository = {
  save: jest.fn(),
  // findById: ... å¿˜ã‚ŒãŸï¼
};

// å®Ÿè¡Œã™ã‚‹ã¨ undefined.then is not a function ã¿ãŸã„ãªã‚¨ãƒ©ãƒ¼
```

**å•é¡Œ3: ãƒ¢ãƒƒã‚¯ãŒè¤‡é›‘ã«ãªã‚‹**

```typescript
// âŒ æ¡ä»¶ä»˜ãã®è¿”ã‚Šå€¤ã‚’è¨­å®š
mockRepository.findById
  .mockResolvedValueOnce(ringi1)  // 1å›ç›®
  .mockResolvedValueOnce(ringi2)  // 2å›ç›®
  .mockResolvedValueOnce(null);   // 3å›ç›®
// é †ç•ªã‚’è¦šãˆã¦ã„ãªã„ã¨ã„ã‘ãªã„
```

---

#### â–³ æ¡ˆâ‘¡ Stub ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ â€” é™å®šçš„ã«æ¡ç”¨

```typescript
// Stub: å›ºå®šå€¤ã‚’è¿”ã™ã ã‘
class StubRingiRepository implements RingiRepository {
  async save(ringi: Ringi): Promise<void> {
    // ä½•ã‚‚ã—ãªã„
  }
  
  async findById(id: RingiId): Promise<Ringi | null> {
    return null;  // å¸¸ã« null
  }
}
```

**åˆ©ç‚¹:** ã‚·ãƒ³ãƒ—ãƒ«

**å•é¡Œ: æŸ”è»Ÿæ€§ãŒãªã„**

```typescript
// âŒ ãƒ†ã‚¹ãƒˆã«ã‚ˆã£ã¦è¿”ã‚Šå€¤ã‚’å¤‰ãˆãŸã„å ´åˆ
// â†’ Stub ã‚’è¤‡æ•°ä½œã‚‹å¿…è¦ãŒã‚ã‚‹

class StubReturnsRingi implements RingiRepository { ... }
class StubReturnsNull implements RingiRepository { ... }
class StubThrowsError implements RingiRepository { ... }
// Stub ãŒå¢—æ®–ã™ã‚‹
```

**Stub ã‚’è¨±å®¹ã™ã‚‹å ´åˆ:**
- æˆåŠŸã‚±ãƒ¼ã‚¹ã®ã¿ãƒ†ã‚¹ãƒˆã™ã‚‹å ´åˆ
- Gatewayï¼ˆå¤–éƒ¨APIï¼‰ã®ãƒ†ã‚¹ãƒˆã§ã€Œå¸¸ã«æˆåŠŸã€ã€Œå¸¸ã«å¤±æ•—ã€ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹ã ã‘ã®å ´åˆ

---

#### âœ… æ¡ˆâ‘¢ InMemory å®Ÿè£…ã‚’æ¡ç”¨ã—ãŸç†ç”±

```typescript
// InMemory: æœ¬ç‰©ã¨åŒã˜æŒ¯ã‚‹èˆã„ã‚’ãƒ¡ãƒ¢ãƒªä¸Šã§
class InMemoryRingiRepository implements RingiRepository {
  private storage = new Map<string, Ringi>();
  
  async save(ringi: Ringi): Promise<void> {
    this.storage.set(ringi.id.value, ringi);
  }
  
  async findById(id: RingiId): Promise<Ringi | null> {
    return this.storage.get(id.value) ?? null;
  }
  
  // ãƒ†ã‚¹ãƒˆç”¨ãƒ˜ãƒ«ãƒ‘ãƒ¼
  clear(): void {
    this.storage.clear();
  }
  
  count(): number {
    return this.storage.size;
  }
}
```

| ãƒ¡ãƒªãƒƒãƒˆ | èª¬æ˜ |
|---------|------|
| **æœ¬ç‰©ã¨åŒã˜æŒ¯ã‚‹èˆã„** | save ã—ãŸã‚‚ã®ã‚’ findById ã§å–å¾—ã§ãã‚‹ |
| **å®Ÿè£…è©³ç´°ã«ä¾å­˜ã—ãªã„** | å†…éƒ¨ã§ã©ã†å‘¼ã‚“ã§ã„ã‚‹ã‹ã¯é–¢ä¿‚ãªã„ |
| **æŸ”è»Ÿ** | ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’è‡ªç”±ã«ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã§ãã‚‹ |
| **é«˜é€Ÿ** | DBã‚¢ã‚¯ã‚»ã‚¹ãªã— |

```typescript
// âœ… InMemory ã‚’ä½¿ã£ãŸãƒ†ã‚¹ãƒˆ
test('ç¨Ÿè­°ã‚’ç”³è«‹ã§ãã‚‹', async () => {
  const repository = new InMemoryRingiRepository();
  const draft = new DraftRingi(id, data);
  
  const submitted = await draft.submit(repository, clock);
  
  // å®Ÿéš›ã«ä¿å­˜ã•ã‚ŒãŸã“ã¨ã‚’ç¢ºèª
  const saved = await repository.findById(id);
  expect(saved).not.toBeNull();
  expect(saved.status).toBe('submitted');
});
```

---

#### â–³ æ¡ˆâ‘£ Test Containers â€” çµ±åˆãƒ†ã‚¹ãƒˆç”¨

```typescript
// Test Containers: Docker ã§æœ¬ç‰©ã®DBã‚’èµ·å‹•
import { PostgreSqlContainer } from 'testcontainers';

let container: PostgreSqlContainer;
let repository: PostgresRingiRepository;

beforeAll(async () => {
  container = await new PostgreSqlContainer().start();
  repository = new PostgresRingiRepository(container.getConnectionUri());
});

afterAll(async () => {
  await container.stop();
});
```

**åˆ©ç‚¹:** æœ¬ç‰©ã®DBã§å‹•ä½œç¢ºèª

**å•é¡Œ:**
- **é…ã„**: ã‚³ãƒ³ãƒ†ãƒŠèµ·å‹•ã«æ•°ç§’ã€œåæ•°ç§’
- **ç’°å¢ƒä¾å­˜**: Docker ãŒå¿…è¦
- **ä¸¦åˆ—ãƒ†ã‚¹ãƒˆå›°é›£**: ãƒãƒ¼ãƒˆç«¶åˆ

**Test Containers ã‚’è¨±å®¹ã™ã‚‹å ´åˆ:**
- çµ±åˆãƒ†ã‚¹ãƒˆãƒ»E2Eãƒ†ã‚¹ãƒˆ
- è¤‡é›‘ãªSQLã‚¯ã‚¨ãƒªã®æ¤œè¨¼
- DBå›ºæœ‰æ©Ÿèƒ½ï¼ˆãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³åˆ†é›¢ãƒ¬ãƒ™ãƒ«ç­‰ï¼‰ã®ãƒ†ã‚¹ãƒˆ

---

### ãƒ†ã‚¹ãƒˆç¨®åˆ¥ã¨æ¨å¥¨ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ

| ãƒ†ã‚¹ãƒˆç¨®åˆ¥ | Repository | Gateway | æ¨å¥¨ç†ç”± |
|-----------|------------|---------|---------|
| **Unit Test** | InMemory | Stub | é«˜é€Ÿã€ç‹¬ç«‹ |
| **Integration Test** | Test Containers | Sandboxç’°å¢ƒ | æœ¬ç‰©ã®æŒ¯ã‚‹èˆã„ç¢ºèª |
| **E2E Test** | æœ¬ç•ªç›¸å½“DB | æœ¬ç•ªç›¸å½“API | æœ€çµ‚ç¢ºèª |

---

## 7.2 ãƒ†ã‚¹ãƒˆå½¢çŠ¶ã®è­°è«– â€” Pyramid vs Trophy vs Honeycomb vs Ice Cream

ãƒ†ã‚¹ãƒˆã‚’ã©ã®ã‚ˆã†ãªã€Œå½¢ã€ã§æ§‹æˆã™ã¹ãã‹ã€‚ã“ã‚Œã¯20å¹´ä»¥ä¸Šè­°è«–ã•ã‚Œã¦ã„ã‚‹ãƒˆãƒ”ãƒƒã‚¯ã§ã™ã€‚

### 4ã¤ã®ä¸»è¦ãªãƒ¢ãƒ‡ãƒ«

| ãƒ¢ãƒ‡ãƒ« | æå”±è€… | å½¢çŠ¶ | æ¨å¥¨æ¯”ç‡ |
|--------|--------|------|---------|
| **â‘  Test Pyramid** | Mike Cohn (2009) | â–³ ãƒ”ãƒ©ãƒŸãƒƒãƒ‰ | Unit 70% / Integration 20% / E2E 10% |
| **â‘¡ Testing Trophy** | Kent C. Dodds (2018) | ğŸ† ãƒˆãƒ­ãƒ•ã‚£ãƒ¼ | Static < Unit < Integration > E2E |
| **â‘¢ Testing Honeycomb** | Spotify (2018) | ğŸ¯ èœ‚ã®å·£ | Implementation > Integration > Integrated |
| **â‘£ Ice Cream Cone** | ã‚¢ãƒ³ãƒãƒ‘ã‚¿ãƒ¼ãƒ³ | ğŸ¦ é€†ãƒ”ãƒ©ãƒŸãƒƒãƒ‰ | E2Eå¤šã„ / Unitå°‘ãªã„ï¼ˆã‚„ã£ã¦ã¯ã„ã‘ãªã„ï¼‰ |

---

### â‘  Test Pyramidï¼ˆMike Cohn, 2009ï¼‰

```
        /\
       /E2E\        â† å°‘æ•°ï¼ˆé…ã„ã€è„†ã„ï¼‰
      /------\
     /Integra-\     â† ä¸­ç¨‹åº¦
    /---tion---\
   /-----------\
  /    Unit     \   â† å¤§é‡ï¼ˆé€Ÿã„ã€å®‰å®šï¼‰
 /---------------\
```

**å‡ºå…¸: "Succeeding with Agile" (Mike Cohn, 2009)**

**ä¸»å¼µ:**
- Unit ãƒ†ã‚¹ãƒˆã‚’æœ€ã‚‚å¤šãæ›¸ã‘
- ä¸Šã«è¡Œãã»ã©ãƒ†ã‚¹ãƒˆã¯é…ãã€è„†ãã€é«˜ã‚³ã‚¹ãƒˆ
- E2E ã¯å¿…è¦æœ€ä½é™ã«

**ã“ã®è€ƒãˆæ–¹ãŒç”Ÿã¾ã‚ŒãŸèƒŒæ™¯:**
- 2009å¹´å½“æ™‚ã€E2E ãƒ†ã‚¹ãƒˆã¯ Selenium ãŒä¸»æµã§éå¸¸ã«é…ã‹ã£ãŸ
- CI/CD ãŒã¾ã ä¸€èˆ¬çš„ã§ã¯ãªãã€ãƒ†ã‚¹ãƒˆæ™‚é–“ãŒå¤§ããªå•é¡Œã ã£ãŸ

**æ‰¹åˆ¤ï¼ˆ2018å¹´ä»¥é™ï¼‰:**
- ã€ŒUnit ãƒ†ã‚¹ãƒˆã°ã‹ã‚Šæ›¸ã„ã¦ã‚‚ã€çµ±åˆæ™‚ã«å£Šã‚Œã‚‹ã€
- ã€ŒMockã ã‚‰ã‘ã®ãƒ†ã‚¹ãƒˆã¯å®Ÿè£…è©³ç´°ã«ä¾å­˜ã—ã™ãã€

---

### â‘¡ Testing Trophyï¼ˆKent C. Dodds, 2018ï¼‰

```
         ğŸ†
        /  \
       / E2E \       â† å°‘æ•°ï¼ˆé‡è¦ãªãƒ•ãƒ­ãƒ¼ï¼‰
      /--------\
     /          \
    / Integration \  â† æœ€ã‚‚å¤šãï¼ˆè‡ªä¿¡ã‚’ä¸ãˆã‚‹ï¼‰
   /--------------\
  /                \
 /      Unit        \  â† ä¸­ç¨‹åº¦ï¼ˆè¤‡é›‘ãªãƒ­ã‚¸ãƒƒã‚¯ï¼‰
/--------------------\
|      Static        |  â† æœ€åˆã«ï¼ˆå‹ã€lintï¼‰
+--------------------+
```

**å‡ºå…¸: Kent C. Dodds "Write tests. Not too many. Mostly integration."**

**ä¸»å¼µ:**
- Integration ãƒ†ã‚¹ãƒˆãŒæœ€ã‚‚ã€Œè‡ªä¿¡ï¼ˆconfidenceï¼‰ã€ã‚’ä¸ãˆã‚‹
- Unit ãƒ†ã‚¹ãƒˆã¯ã€Œè¤‡é›‘ãªãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã€ã«ã®ã¿æ›¸ã
- Mock ã‚’æ¸›ã‚‰ã—ã€æœ¬ç‰©ã«è¿‘ã„ç’°å¢ƒã§ãƒ†ã‚¹ãƒˆ

**å…·ä½“ä¾‹ï¼ˆReact Testing Libraryï¼‰:**
```typescript
// âŒ Implementation detailï¼ˆKent C. Dodds ãŒæ‰¹åˆ¤ã™ã‚‹ã‚¹ã‚¿ã‚¤ãƒ«ï¼‰
test('ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯ã§ state ãŒå¤‰ã‚ã‚‹', () => {
  const { result } = renderHook(() => useCounter());
  act(() => result.current.increment());
  expect(result.current.count).toBe(1);  // å†…éƒ¨ state ã‚’ãƒ†ã‚¹ãƒˆ
});

// âœ… Testing behaviorï¼ˆKent C. Dodds ãŒæ¨å¥¨ã™ã‚‹ã‚¹ã‚¿ã‚¤ãƒ«ï¼‰
test('ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯ã§ã‚«ã‚¦ãƒ³ãƒˆãŒè¡¨ç¤ºã•ã‚Œã‚‹', () => {
  render(<Counter />);
  fireEvent.click(screen.getByRole('button', { name: 'Increment' }));
  expect(screen.getByText('Count: 1')).toBeInTheDocument();
  // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã‚‹ã‚‚ã®ã‚’ãƒ†ã‚¹ãƒˆ
});
```

**æ‰¹åˆ¤:**
- ã€ŒIntegration ãƒ†ã‚¹ãƒˆã¯é…ã„ã€‚CI ãŒé•·ããªã‚‹ã€
- ã€Œãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã§ã¯ Unit ãƒ†ã‚¹ãƒˆã®æ–¹ãŒåŠ¹ç‡çš„ãªã“ã¨ãŒå¤šã„ã€

---

### â‘¢ Testing Honeycombï¼ˆSpotify, 2018ï¼‰

```
    +-------------------+
    |    Integrated     |  â† å…¨ã‚·ã‚¹ãƒ†ãƒ çµåˆï¼ˆå°‘æ•°ï¼‰
    +-------------------+
    |                   |
    |   Integration     |  â† ã‚µãƒ¼ãƒ“ã‚¹é–“ï¼ˆä¸­ç¨‹åº¦ï¼‰
    |                   |
    +-------------------+
    |                   |
    |                   |
    |  Implementation   |  â† å˜ä¸€ã‚µãƒ¼ãƒ“ã‚¹å†…ï¼ˆå¤§é‡ï¼‰
    |    (Unit-ish)     |
    |                   |
    +-------------------+
```

**å‡ºå…¸: Spotify Engineering Blog "Testing of Microservices"**

**ä¸»å¼µ:**
- ãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹ã§ã¯ã€Œã‚µãƒ¼ãƒ“ã‚¹é–“ã®å¥‘ç´„ã€ãŒé‡è¦
- å˜ä½“ãƒ†ã‚¹ãƒˆã‚ˆã‚Šã‚‚ã€Œã‚µãƒ¼ãƒ“ã‚¹å†…çµåˆãƒ†ã‚¹ãƒˆã€ã‚’é‡è¦–
- Contract Testingï¼ˆPactç­‰ï¼‰ã§ã‚µãƒ¼ãƒ“ã‚¹é–“ã‚’æ¤œè¨¼

**ç‰¹å¾´:**
- ã€ŒUnit Testã€ã¨ã„ã†è¨€è‘‰ã‚’é¿ã‘ã€ŒImplementation Testã€ã¨å‘¼ã¶
- ãƒ¢ãƒãƒªã‚¹ã«ã¯é©ç”¨ã—ã«ãã„

---

### â‘£ Ice Cream Coneï¼ˆã‚¢ãƒ³ãƒãƒ‘ã‚¿ãƒ¼ãƒ³ï¼‰

```
   \_______________/
    \   Manual    /   â† æ‰‹å‹•ãƒ†ã‚¹ãƒˆå¤šã„
     \___________/
      \  E2E   /      â† E2E å¤šã„ï¼ˆé…ã„ã€è„†ã„ï¼‰
       \_______/
        \Int./        â† Integration å°‘ãªã„
         \__/
          \/          â† Unit ã»ã¼ãªã—
```

**ãªãœã‚¢ãƒ³ãƒãƒ‘ã‚¿ãƒ¼ãƒ³ã‹:**
- E2E ã¯é…ã„ â†’ CI ãŒ30åˆ†ã€1æ™‚é–“ã‹ã‹ã‚‹
- E2E ã¯è„†ã„ â†’ ç„¡é–¢ä¿‚ãªå¤‰æ›´ã§å£Šã‚Œã‚‹ï¼ˆflaky testï¼‰
- æ‰‹å‹•ãƒ†ã‚¹ãƒˆã¯å†ç¾æ€§ãŒãªã„
- ãƒã‚°ã®åŸå› ç‰¹å®šãŒå›°é›£ï¼ˆã©ã“ã§å£Šã‚ŒãŸï¼Ÿï¼‰

**ã“ã†ãªã‚‹åŸå› :**
- ã€Œã¨ã‚Šã‚ãˆãšå‹•ãã“ã¨ã‚’ç¢ºèªã€ã§E2Eã‹ã‚‰æ›¸ãå§‹ã‚ã‚‹
- Unit ãƒ†ã‚¹ãƒˆã®æ›¸ãæ–¹ã‚’çŸ¥ã‚‰ãªã„
- ã€ŒUnit ãƒ†ã‚¹ãƒˆã¯å®Ÿè£…è©³ç´°ã®ãƒ†ã‚¹ãƒˆã ã‹ã‚‰ç„¡é§„ã€ã¨ã„ã†èª¤è§£

---

### æœ¬ã‚¹ã‚­ãƒ«ã®ç«‹å ´: Pyramid + Trophy ã®ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰

| ãƒ†ã‚¹ãƒˆç¨®åˆ¥ | æ¯”ç‡ | å¯¾è±¡ |
|-----------|------|------|
| **Static** | - | TypeScript å‹ãƒã‚§ãƒƒã‚¯ã€ESLint |
| **Unit** | 50% | Pure Logicï¼ˆQuery, Transitionï¼‰ã€è¤‡é›‘ãªè¨ˆç®— |
| **Integration** | 40% | Command + InMemory Repository |
| **E2E** | 10% | ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ãƒ‘ã‚¹ï¼ˆæ±ºæ¸ˆã€èªè¨¼ï¼‰ã®ã¿ |

**ãªãœã“ã®æ¯”ç‡ã‹:**

1. **Unit 50%**: æœ¬ã‚¹ã‚­ãƒ«ã¯ã€ŒPure Logic ã‚’åˆ†é›¢ã€ã™ã‚‹ãŸã‚ã€Unit ãƒ†ã‚¹ãƒˆãŒæ›¸ãã‚„ã™ã„
2. **Integration 40%**: InMemory å®Ÿè£…ã«ã‚ˆã‚Šé«˜é€Ÿãª Integration ãƒ†ã‚¹ãƒˆãŒå¯èƒ½
3. **E2E 10%**: Playwright ç­‰ã§é‡è¦ãƒ•ãƒ­ãƒ¼ã®ã¿

```typescript
// Unitï¼ˆ50%ï¼‰: Pure Logic
test('ç¨é¡ã‚’è¨ˆç®—ã§ãã‚‹', () => {
  const tax = new TaxOn(Money.of(1000), TaxRate.of(0.1));
  expect(tax.amount.value).toBe(100);
});

// Integrationï¼ˆ40%ï¼‰: Command + InMemory
test('ç¨Ÿè­°ã‚’ç”³è«‹ã§ãã‚‹', async () => {
  const repository = new InMemoryRingiRepository();
  const draft = new DraftRingi(id, data);
  
  await draft.submit(repository, clock);
  
  expect(await repository.findById(id)).not.toBeNull();
});

// E2Eï¼ˆ10%ï¼‰: ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ãƒ‘ã‚¹ã®ã¿
test('ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ³¨æ–‡ã‚’å®Œäº†ã§ãã‚‹', async ({ page }) => {
  await page.goto('/products');
  await page.click('text=ã‚«ãƒ¼ãƒˆã«è¿½åŠ ');
  await page.click('text=è³¼å…¥æ‰‹ç¶šã');
  // ...
});
```

---

## 7.3 ãƒ†ã‚¹ãƒˆã‚µã‚¤ã‚ºåˆ†é¡ â€” Google æ–¹å¼ vs å¾“æ¥æ–¹å¼

### å¾“æ¥ã®åˆ†é¡: Unit / Integration / E2E

| åç§° | å®šç¾© |
|------|------|
| Unit | å˜ä¸€ã‚¯ãƒ©ã‚¹/é–¢æ•°ã®ãƒ†ã‚¹ãƒˆ |
| Integration | è¤‡æ•°ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®çµåˆãƒ†ã‚¹ãƒˆ |
| E2E | ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ã®ãƒ†ã‚¹ãƒˆ |

**å•é¡Œ:** å®šç¾©ãŒæ›–æ˜§
- ã€ŒUnitã€ã®ç¯„å›²ã¯ï¼Ÿã‚¯ãƒ©ã‚¹1ã¤ï¼Ÿãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«1ã¤ï¼Ÿ
- ã€ŒIntegrationã€ã§DBã¯ä½¿ã†ï¼ŸInMemoryï¼Ÿ

---

### Google Test Sizes: Small / Medium / Large

**å‡ºå…¸: Google Testing Blog "Test Sizes"**

| Size | åˆ¶ç´„ | å®Ÿè¡Œæ™‚é–“ | å¤–éƒ¨ãƒªã‚½ãƒ¼ã‚¹ |
|------|------|---------|-------------|
| **Small** | å˜ä¸€ãƒ—ãƒ­ã‚»ã‚¹ã€å˜ä¸€ã‚¹ãƒ¬ãƒƒãƒ‰ | < 60ç§’ | âŒ ç¦æ­¢ |
| **Medium** | å˜ä¸€ãƒã‚·ãƒ³ | < 300ç§’ | localhost ã®ã¿ |
| **Large** | åˆ¶é™ãªã— | åˆ¶é™ãªã— | åˆ¶é™ãªã— |

**Small Test ã®åˆ¶ç´„:**
- ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¢ã‚¯ã‚»ã‚¹ç¦æ­¢
- ãƒ•ã‚¡ã‚¤ãƒ«I/Oç¦æ­¢ï¼ˆã¾ãŸã¯ /tmp ã®ã¿ï¼‰
- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ç¦æ­¢
- Sleep ç¦æ­¢

**ãªãœã“ã®åˆ†é¡ãŒå„ªã‚Œã¦ã„ã‚‹ã‹:**
- ã€Œä½•ã‚’ãƒ†ã‚¹ãƒˆã™ã‚‹ã‹ã€ã§ã¯ãªãã€Œã©ã†ã„ã†åˆ¶ç´„ã‹ã€ã§åˆ†é¡
- æ˜ç¢ºãªåŸºæº–ï¼ˆæ›–æ˜§ã•ãŒãªã„ï¼‰
- CI ã§ã®ä¸¦åˆ—å®Ÿè¡ŒãŒå®¹æ˜“ï¼ˆSmall ã¯å®Œå…¨ä¸¦åˆ—å¯èƒ½ï¼‰

---

### t-wada æµã®è§£é‡ˆ

**å‡ºå…¸: t-wadaï¼ˆå’Œç”°å“äººï¼‰æ°ã®è¬›æ¼”ãƒ»ãƒ–ãƒ­ã‚°**

| Google | å®Ÿè³ªçš„ãªæ„å‘³ | æœ¬ã‚¹ã‚­ãƒ«ã¨ã®å¯¾å¿œ |
|--------|-------------|-----------------|
| Small | å¤–éƒ¨ãƒªã‚½ãƒ¼ã‚¹ãªã—ã€ç´”ç²‹ãªãƒ­ã‚¸ãƒƒã‚¯ | Query, Transition ã®ãƒ†ã‚¹ãƒˆ |
| Medium | localhost ã®DBã€InMemory | Command + InMemory Repository |
| Large | æœ¬ç‰©ã®å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹ | E2Eã€Contract Test |

**t-wada æ°ã®ä¸»å¼µ:**
> ã€Œãƒ†ã‚¹ãƒˆã®ã‚µã‚¤ã‚ºã¯å®Ÿè¡Œé€Ÿåº¦ã¨ä¿¡é ¼æ€§ã®ãƒˆãƒ¬ãƒ¼ãƒ‰ã‚ªãƒ•ã€‚Small ã‚’å¤šãã€Large ã‚’å°‘ãªãã€

---

### æœ¬ã‚¹ã‚­ãƒ«ã§ã®é©ç”¨

```typescript
// Small Test: å¤–éƒ¨ãƒªã‚½ãƒ¼ã‚¹ãªã—
// Query, Transition ã¯å…¨ã¦ Small
test('ç¨é¡è¨ˆç®—', () => {
  expect(new TaxOn(Money.of(1000), TaxRate.of(0.1)).amount.value).toBe(100);
});

// Medium Test: InMemory Repository
// Command ã¯ Mediumï¼ˆlocalhost ã®ã€Œãƒ¡ãƒ¢ãƒªDBã€ç›¸å½“ï¼‰
test('ç¨Ÿè­°ç”³è«‹', async () => {
  const repository = new InMemoryRingiRepository();
  await draft.submit(repository, clock);
  expect(await repository.findById(id)).not.toBeNull();
});

// Large Test: æœ¬ç‰©ã®DBã€å¤–éƒ¨API
// E2Eã€Testcontainers ã‚’ä½¿ã†çµ±åˆãƒ†ã‚¹ãƒˆ
test('æ±ºæ¸ˆãƒ•ãƒ­ãƒ¼', async () => {
  const container = await new PostgreSqlContainer().start();
  // ...
});
```

---

## 7.4 TDD ã®ã‚¹ã‚¿ã‚¤ãƒ« â€” London School vs Detroit/Chicago School

### 2ã¤ã®æµæ´¾

| æµæ´¾ | åˆ¥å | ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ | Mock ã®ä½¿ã„æ–¹ |
|------|------|-----------|--------------|
| **London School** | Mockist | Outside-inï¼ˆå¤–ã‹ã‚‰å†…ã¸ï¼‰ | ç©æ¥µçš„ã«ä½¿ã† |
| **Detroit/Chicago School** | Classicist | Inside-outï¼ˆå†…ã‹ã‚‰å¤–ã¸ï¼‰ | æœ€å°é™ã«æŠ‘ãˆã‚‹ |

---

### London Schoolï¼ˆMockistï¼‰

**ä»£è¡¨: Steve Freeman, Nat Pryce â€” "Growing Object-Oriented Software, Guided by Tests" (GOOS)**

**ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ:**
1. å¤–å´ï¼ˆAPI/UIï¼‰ã‹ã‚‰è¨­è¨ˆã‚’å§‹ã‚ã‚‹
2. å†…å´ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¯ Mock ã§ä»£æ›¿
3. å¾ã€…ã«å†…å´ã‚’å®Ÿè£…

```typescript
// London School: Repository ã‚’ Mock
test('ç¨Ÿè­°ã‚’ç”³è«‹ã§ãã‚‹', async () => {
  const mockRepository = {
    save: jest.fn().mockResolvedValue(undefined),
  };
  
  const draft = new DraftRingi(id, data);
  await draft.submit(mockRepository, clock);
  
  expect(mockRepository.save).toHaveBeenCalledWith(
    expect.objectContaining({ id, status: 'submitted' })
  );
});
```

**é•·æ‰€:**
- è¨­è¨ˆãŒ API ãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆã«ãªã‚‹ï¼ˆä½¿ã„ã‚„ã™ã„ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ï¼‰
- ãƒ†ã‚¹ãƒˆãŒé«˜é€Ÿï¼ˆå¤–éƒ¨ä¾å­˜ãªã—ï¼‰
- ä¾å­˜é–¢ä¿‚ãŒæ˜ç¢ºã«ãªã‚‹

**çŸ­æ‰€:**
- Mock ã®è¨­å®šãŒè¤‡é›‘ã«ãªã‚ŠãŒã¡
- å®Ÿè£…è©³ç´°ï¼ˆ`save` ãŒå‘¼ã°ã‚ŒãŸã‹ï¼‰ã«ä¾å­˜
- ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ã§ãƒ†ã‚¹ãƒˆãŒå£Šã‚Œã‚„ã™ã„

---

### Detroit/Chicago Schoolï¼ˆClassicistï¼‰

**ä»£è¡¨: Kent Beck â€” "Test-Driven Development: By Example"**

**ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ:**
1. å†…å´ï¼ˆãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ­ã‚¸ãƒƒã‚¯ï¼‰ã‹ã‚‰è¨­è¨ˆã‚’å§‹ã‚ã‚‹
2. å¯èƒ½ãªé™ã‚Šæœ¬ç‰©ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½¿ã†
3. Mock ã¯å¤–éƒ¨ã‚·ã‚¹ãƒ†ãƒ ï¼ˆDBã€APIï¼‰ã«ã®ã¿ä½¿ã†

```typescript
// Detroit School: InMemory Repository ã‚’ä½¿ã†
test('ç¨Ÿè­°ã‚’ç”³è«‹ã§ãã‚‹', async () => {
  const repository = new InMemoryRingiRepository();
  const draft = new DraftRingi(id, data);
  
  await draft.submit(repository, clock);
  
  const saved = await repository.findById(id);
  expect(saved).not.toBeNull();
  expect(saved!.status).toBe('submitted');
});
```

**é•·æ‰€:**
- ãƒ†ã‚¹ãƒˆãŒå®Ÿè£…è©³ç´°ã«ä¾å­˜ã—ãªã„
- ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ã—ã¦ã‚‚ãƒ†ã‚¹ãƒˆãŒå£Šã‚Œã«ãã„
- ã€Œæœ¬å½“ã«ä¿å­˜ã•ã‚ŒãŸã€ã“ã¨ã‚’ç¢ºèªã§ãã‚‹

**çŸ­æ‰€:**
- è¨­è¨ˆãŒå†…éƒ¨ãƒ­ã‚¸ãƒƒã‚¯ã«å¼•ããšã‚‰ã‚Œã‚‹å¯èƒ½æ€§
- å¤§ããªçµåˆãƒ†ã‚¹ãƒˆã«ãªã‚ŠãŒã¡

---

### æœ¬ã‚¹ã‚­ãƒ«ã®ç«‹å ´: Detroit School + Pending Object ã®çµ„ã¿åˆã‚ã›

**æœ¬ã‚¹ã‚­ãƒ«ã¯ Detroit School å¯„ã‚Š:**
- InMemory å®Ÿè£…ã‚’ä½¿ã†ï¼ˆMock ã‚ˆã‚Šæœ¬ç‰©ã«è¿‘ã„ï¼‰
- å®Ÿè£…è©³ç´°ï¼ˆ`save` ãŒå‘¼ã°ã‚ŒãŸã‹ï¼‰ã§ã¯ãªãçµæœï¼ˆä¿å­˜ã•ã‚ŒãŸï¼‰ã‚’æ¤œè¨¼

**ãŸã ã— Pending Object Pattern ã¨ã®ç›¸æ€§ã§ä¿®æ­£:**
- Outside-in ã®è€ƒãˆæ–¹ã‚‚å–ã‚Šå…¥ã‚Œã‚‹ï¼ˆå‹ã§è¨­è¨ˆã‚’é§†å‹•ï¼‰
- `DraftRingi` â†’ `SubmittedRingi` ã¨ã„ã†å‹é·ç§»ãŒãƒ†ã‚¹ãƒˆã‚’å°ã

```typescript
// æœ¬ã‚¹ã‚­ãƒ«ã®ã‚¹ã‚¿ã‚¤ãƒ«: Detroit + å‹é§†å‹•
test('ä¸‹æ›¸ãç¨Ÿè­°ã‚’ç”³è«‹ã™ã‚‹ã¨ã€ç”³è«‹æ¸ˆã¿ç¨Ÿè­°ãŒè¿”ã‚‹', async () => {
  const repository = new InMemoryRingiRepository();
  const draft = new DraftRingi(id, data);
  
  // æˆ»ã‚Šå€¤ã®å‹ãŒ SubmittedRingi ã§ã‚ã‚‹ã“ã¨ãŒãƒ†ã‚¹ãƒˆã®æœ¬è³ª
  const submitted: SubmittedRingi = await draft.submit(repository, clock);
  
  expect(submitted.submittedAt).toEqual(clock.now());
  expect(await repository.findById(id)).toEqual(submitted);
});
```

---

## 7.5 TDD è‡ªä½“ã®æ˜¯é â€” "TDD is Dead" è«–äº‰

### è«–äº‰ã®çµŒç·¯

**2014å¹´: DHHï¼ˆRuby on Rails ä½œè€…ï¼‰ãŒ "TDD is dead. Long live testing." ã‚’ç™ºè¡¨**

**å‡ºå…¸: DHH's blog "TDD is dead. Long live testing." (2014)**

DHH ã®ä¸»å¼µ:
> "Test-first fundamentalism is like abstinence-only sex education: An unrealistic, ineffective morality campaign for self-loathing and shaming."

> "ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆåŸç†ä¸»ç¾©ã¯ã€ç¦æ¬²ä¸»ç¾©ã®ã‚»ãƒƒã‚¯ã‚¹æ•™è‚²ã®ã‚ˆã†ãªã‚‚ã®ã€‚éç¾å®Ÿçš„ã§åŠ¹æœãŒãªãã€è‡ªå·±å«Œæ‚ªã¨æ¥è¾±ã®ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ã "

---

### ä¸»è¦ãªè«–ç‚¹

#### DHH ã®æ‰¹åˆ¤

| æ‰¹åˆ¤ | èª¬æ˜ |
|------|------|
| **Test-induced design damage** | ãƒ†ã‚¹ãƒˆã®ãŸã‚ã«ä¸è‡ªç„¶ãªè¨­è¨ˆã‚’å¼·ã„ã‚‰ã‚Œã‚‹ |
| **éå‰°ãªãƒ¢ãƒƒã‚¯** | ãƒ¢ãƒƒã‚¯ã ã‚‰ã‘ã®ãƒ†ã‚¹ãƒˆã¯å®Ÿè£…è©³ç´°ã«ä¾å­˜ |
| **é…ã„ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯** | ãƒ†ã‚¹ãƒˆã‚’å…ˆã«æ›¸ãã¨é–‹ç™ºãŒé…ããªã‚‹ |
| **æ•™æ¡ä¸»ç¾©** | ã€ŒTDD ã—ãªã„ã¨æ‚ªã„é–‹ç™ºè€…ã€ã¨ã„ã†ç©ºæ°— |

**DHH ã®ä»£æ›¿æ¡ˆ:**
- ãƒ†ã‚¹ãƒˆã¯æ›¸ãã€‚ãŸã ã—ã€Œãƒ†ã‚¹ãƒˆãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆã€ã«ã“ã ã‚ã‚‰ãªã„
- çµ±åˆãƒ†ã‚¹ãƒˆã‚’é‡è¦–ï¼ˆRails ã®ã‚·ã‚¹ãƒ†ãƒ ãƒ†ã‚¹ãƒˆï¼‰
- è¨­è¨ˆã¯ãƒ†ã‚¹ãƒˆã®ãŸã‚ã§ã¯ãªãã€ãƒ‰ãƒ¡ã‚¤ãƒ³ã®ãŸã‚ã«

---

#### Kent Beck ã®åè«–

**å‡ºå…¸: Kent Beck, DHH, Martin Fowler ã«ã‚ˆã‚‹ "Is TDD Dead?" å¯¾è«‡ã‚·ãƒªãƒ¼ã‚º (2014)**

Kent Beck ã®ç«‹å ´:
> "I practice TDD. I don't recommend TDD to others. It's like asking 'do you recommend tai chi?'"

> "ç§ã¯ TDD ã‚’å®Ÿè·µã™ã‚‹ã€‚ä»–äººã« TDD ã‚’å‹§ã‚ã¯ã—ãªã„ã€‚ã€å¤ªæ¥µæ‹³ã‚’å‹§ã‚ã¾ã™ã‹ï¼Ÿã€ã¨èã‹ã‚Œã¦ã„ã‚‹ã‚ˆã†ãªã‚‚ã®ã "

**Beck ã®ä¸»å¼µ:**
- TDD ã¯ã€Œã‚¹ã‚­ãƒ«ã€ã§ã‚ã‚Šã€Œå®—æ•™ã€ã§ã¯ãªã„
- åŠ¹æœã¯å€‹äººå·®ãŒã‚ã‚‹
- å¼·åˆ¶ã™ã¹ãã§ã¯ãªã„ãŒã€å­¦ã¶ä¾¡å€¤ã¯ã‚ã‚‹

---

#### Martin Fowler ã®ä¸­ç«‹çš„è¦‹è§£

**Martin Fowler:**
> "The problem is not TDD itself, but TDD done poorly."

> "å•é¡Œã¯ TDD è‡ªä½“ã§ã¯ãªãã€ä¸‹æ‰‹ãª TDD ã "

**Fowler ãŒæŒ‡æ‘˜ã™ã‚‹ã€Œä¸‹æ‰‹ãª TDDã€:**
- å®Ÿè£…è©³ç´°ã‚’ãƒ†ã‚¹ãƒˆã™ã‚‹ï¼ˆMock ã®ä¹±ç”¨ï¼‰
- ãƒ†ã‚¹ãƒˆã®ãŸã‚ã ã‘ã«è¨­è¨ˆã‚’æ­ªã‚ã‚‹
- ã‚«ãƒãƒ¬ãƒƒã‚¸æ•°å€¤ã‚’ç›®çš„åŒ–ã™ã‚‹

---

### "Test-induced design damage" ã¨ã¯

DHH ãŒæŒ‡æ‘˜ã™ã‚‹ã€Œãƒ†ã‚¹ãƒˆãŒè¨­è¨ˆã‚’å£Šã™ã€ä¾‹:

```ruby
# âŒ ãƒ†ã‚¹ãƒˆã®ãŸã‚ã«ä¸è‡ªç„¶ãªä¾å­˜æ³¨å…¥
class OrderProcessor
  def initialize(payment_gateway, email_service, inventory_checker)
    @payment_gateway = payment_gateway
    @email_service = email_service
    @inventory_checker = inventory_checker
  end
  
  def process(order)
    @inventory_checker.check(order)
    @payment_gateway.charge(order)
    @email_service.send_confirmation(order)
  end
end

# DHH ã®ä¸»å¼µ: ã€Œã“ã‚Œã¯ãƒ†ã‚¹ãƒˆã®ãŸã‚ã ã‘ã®è¨­è¨ˆã€‚å®Ÿéš›ã®Railsã‚¢ãƒ—ãƒªã§ã¯
# PaymentGateway.charge(order) ã¨ç›´æ¥å‘¼ã¹ã°ã„ã„ã€
```

**åè«–ï¼ˆæœ¬ã‚¹ã‚­ãƒ«ã®ç«‹å ´ï¼‰:**
- ä¾å­˜æ³¨å…¥ã¯ã€Œãƒ†ã‚¹ãƒˆã®ãŸã‚ã€ã§ã¯ãªãã€Œå¤‰æ›´å®¹æ˜“æ€§ã®ãŸã‚ã€
- ãŸã ã—ã€ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã®æµå„€ã«å¾“ã†ã“ã¨ã¯è¨±å®¹ã™ã‚‹ï¼ˆNestJS ã® DI ãªã©ï¼‰

---

### æœ¬ã‚¹ã‚­ãƒ«ã®ç«‹å ´

| è¦³ç‚¹ | æœ¬ã‚¹ã‚­ãƒ«ã®ç«‹å ´ |
|------|---------------|
| **TDD å¿…é ˆã‹** | âŒ å¼·åˆ¶ã—ãªã„ã€‚ãŸã ã—ã€Œãƒ†ã‚¹ãƒˆã‚’æ›¸ãã€ã¯å¿…é ˆ |
| **ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆ** | â–³ æ¨å¥¨ã™ã‚‹ãŒã€å¾Œã‹ã‚‰æ›¸ã„ã¦ã‚‚è‰¯ã„ |
| **Mock ã®ä½¿ç”¨** | â–³ æœ€å°é™ã«ã€‚InMemory å®Ÿè£…ã‚’å„ªå…ˆ |
| **ã‚«ãƒãƒ¬ãƒƒã‚¸ç›®æ¨™** | â–³ æ•°å€¤ç›®æ¨™ã‚ˆã‚Šã€Œé‡è¦ãªãƒ­ã‚¸ãƒƒã‚¯ã®ã‚«ãƒãƒ¼ã€ã‚’é‡è¦– |

**ãªãœ TDD ã‚’å¼·åˆ¶ã—ãªã„ã‹:**

1. **ã‚¹ã‚­ãƒ«ãƒ¬ãƒ™ãƒ«ã®å·®**: TDD ã¯ç¿’ç†Ÿã«æ™‚é–“ãŒã‹ã‹ã‚‹ã€‚å¼·åˆ¶ã™ã‚‹ã¨è³ªãŒä¸‹ãŒã‚‹
2. **æ¢ç´¢çš„é–‹ç™º**: æ–°ã—ã„é ˜åŸŸã‚’æ¢ç´¢ã™ã‚‹ã¨ãã¯ã€å…ˆã«ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ã„ãŸæ–¹ãŒæ—©ã„ã“ã¨ãŒã‚ã‚‹
3. **DHH ã®æŒ‡æ‘˜ã¯ä¸€ç†ã‚ã‚‹**: ãƒ†ã‚¹ãƒˆã®ãŸã‚ã«è¨­è¨ˆã‚’æ­ªã‚ã‚‹ã®ã¯æœ¬æœ«è»¢å€’

**ãŸã ã—ä»¥ä¸‹ã¯å®ˆã‚‹:**
- ãƒ†ã‚¹ãƒˆã¯å¿…ãšæ›¸ãï¼ˆå¾Œã‹ã‚‰ã§ã‚‚ï¼‰
- Pure Logicï¼ˆQuery, Transitionï¼‰ã¯ Unit ãƒ†ã‚¹ãƒˆãŒå®¹æ˜“ãªã®ã§æ›¸ã
- Command ã¯ InMemory Repository ã§ Integration ãƒ†ã‚¹ãƒˆã‚’æ›¸ã

---

## 7.6 ä¾å­˜åˆ†é¡åˆ¥ã®ãƒ†ã‚¹ãƒˆæ–¹æ³•

| åˆ†é¡ | ãƒ†ã‚¹ãƒˆæ–¹æ³• | ãƒ¢ãƒƒã‚¯ | ä¾‹ |
|------|-----------|:------:|-----|
| Pure Logic | å…¥åŠ›â†’å‡ºåŠ›ã‚’ç›´æ¥ãƒ†ã‚¹ãƒˆ | ä¸è¦ | TaxCalculator |
| Configured Logic | è¨­å®šã‚’å¤‰ãˆã¦ãƒ†ã‚¹ãƒˆ | ä¸è¦ | RateCalculator(rate: 0.1) |
| External Resource | InMemoryå®Ÿè£…ã‚’ä½¿ç”¨ | å¿…è¦ | Repository |
| Non-deterministic | å›ºå®šå€¤ã‚’æ³¨å…¥ | å¿…è¦ | Clock |

---

## 7.7 Test Data Factory

### å•é¡Œ: å…±æœ‰ãƒ•ã‚£ã‚¯ã‚¹ãƒãƒ£

```typescript
// âŒ å…±æœ‰ãƒ•ã‚£ã‚¯ã‚¹ãƒãƒ£: ãƒ†ã‚¹ãƒˆé–“ã§çŠ¶æ…‹ãŒå…±æœ‰ã•ã‚Œã‚‹
// fixtures/users.ts
export const testUsers = {
  admin: new User('admin', 'admin@example.com', Role.ADMIN),
  normalUser: new User('user1', 'user@example.com', Role.USER),
};

// ãƒ†ã‚¹ãƒˆA
test('ç®¡ç†è€…ã¯ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹', () => {
  expect(canAccess(testUsers.admin)).toBe(true);
});

// ãƒ†ã‚¹ãƒˆB
test('ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’å¤‰æ›´ã§ãã‚‹', () => {
  testUsers.admin.name = 'changed';  // ğŸ’¥ å…±æœ‰ãƒ‡ãƒ¼ã‚¿ã‚’å¤‰æ›´ï¼
  // ãƒ†ã‚¹ãƒˆAã«å½±éŸ¿ã‚’ä¸ãˆã‚‹å¯èƒ½æ€§
});
```

### è§£æ±º: Factory ã§æ¯å›ç”Ÿæˆ

```typescript
// âœ… Test Data Factory: æ¯å›æ–°ã—ã„ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹
export const UserTestFactory = {
  admin: (overrides?: Partial<UserData>) => new User({
    id: UserId.generate(),
    name: 'Test Admin',
    email: 'admin@example.com',
    role: Role.ADMIN,
    ...overrides,  // å¿…è¦ãªéƒ¨åˆ†ã ã‘ä¸Šæ›¸ãå¯èƒ½
  }),
  
  normalUser: (overrides?: Partial<UserData>) => new User({
    id: UserId.generate(),
    name: 'Test User',
    email: 'user@example.com',
    role: Role.USER,
    ...overrides,
  }),
};

// ãƒ†ã‚¹ãƒˆA
test('ç®¡ç†è€…ã¯ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹', () => {
  const admin = UserTestFactory.admin();  // æ–°ã—ã„ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹
  expect(canAccess(admin)).toBe(true);
});

// ãƒ†ã‚¹ãƒˆB
test('ç‰¹å®šã®åå‰ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’æ¤œç´¢ã§ãã‚‹', () => {
  const user = UserTestFactory.normalUser({ name: 'Tanaka' });  // ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º
  // ...
});
```

---

## 7.8 InMemory Repository

**InMemory Repository**ã¨ã¯ã€ãƒ¡ãƒ¢ãƒªä¸Šã§å‹•ä½œã™ã‚‹ãƒ†ã‚¹ãƒˆç”¨ã®Repositoryå®Ÿè£…ã§ã™ã€‚

```typescript
// æœ¬ç•ªç”¨: å®Ÿéš›ã®DBã«ã‚¢ã‚¯ã‚»ã‚¹
class PostgresRingiRepository implements RingiRepository {
  async save(ringi: Ringi): Promise<void> {
    await this.db.query('INSERT INTO ringis ...', [ringi]);
  }
  async findById(id: RingiId): Promise<Ringi | null> {
    return this.db.query('SELECT * FROM ringis WHERE id = ?', [id]);
  }
}

// ãƒ†ã‚¹ãƒˆç”¨: ãƒ¡ãƒ¢ãƒªä¸Šã®Mapã‚’ä½¿ã†
class InMemoryRingiRepository implements RingiRepository {
  private storage = new Map<string, Ringi>();
  
  async save(ringi: Ringi): Promise<void> {
    this.storage.set(ringi.id.value, ringi);
  }
  
  async findById(id: RingiId): Promise<Ringi | null> {
    return this.storage.get(id.value) ?? null;
  }
  
  // ãƒ†ã‚¹ãƒˆç”¨ãƒ˜ãƒ«ãƒ‘ãƒ¼
  clear(): void {
    this.storage.clear();
  }
}
```

**ãªãœå¿…è¦ã‹:**
- å˜ä½“ãƒ†ã‚¹ãƒˆãŒé«˜é€Ÿï¼ˆDBã‚¢ã‚¯ã‚»ã‚¹ãªã—ï¼‰
- ãƒ†ã‚¹ãƒˆé–“ã§çŠ¶æ…‹ãŒå…±æœ‰ã•ã‚Œãªã„ï¼ˆç‹¬ç«‹æ€§ï¼‰
- æœ¬ç•ªDBã«ä¾å­˜ã—ãªã„

---

## 7.9 Gateway ãƒ‘ã‚¿ãƒ¼ãƒ³

å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹ï¼ˆStripeã€SendGridã€S3ãªã©ï¼‰ã‚’Interfaceã§æŠ½è±¡åŒ–ã—ã€ãƒ†ã‚¹ãƒˆæ™‚ã«å·®ã—æ›¿ãˆå¯èƒ½ã«ã—ã¾ã™ã€‚

```typescript
// Interfaceå®šç¾©
interface PaymentGateway {
  charge(amount: Money): Promise<PaymentResult>;
}

// æœ¬ç•ªç”¨å®Ÿè£…
class StripePaymentGateway implements PaymentGateway {
  async charge(amount: Money): Promise<PaymentResult> {
    // å®Ÿéš›ã«Stripe APIã‚’å‘¼ã¶
  }
}

// ãƒ†ã‚¹ãƒˆç”¨å®Ÿè£…ï¼ˆå¸¸ã«æˆåŠŸï¼‰
class StubPaymentGateway implements PaymentGateway {
  async charge(amount: Money): Promise<PaymentResult> {
    return { success: true, transactionId: 'test-123' };
  }
}

// ãƒ†ã‚¹ãƒˆç”¨å®Ÿè£…ï¼ˆå¸¸ã«å¤±æ•—ï¼‰
class FailingPaymentGateway implements PaymentGateway {
  async charge(amount: Money): Promise<PaymentResult> {
    return { success: false, error: 'ã‚«ãƒ¼ãƒ‰ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸ' };
  }
}
```

---

# Part 8: ç™ºå±•ç·¨ â€” æœ¬ã‚¹ã‚­ãƒ«ã€Œä»¥å¤–ã€ã®é¸æŠè‚¢

> **ã“ã®ãƒ‘ãƒ¼ãƒˆã«ã¤ã„ã¦:**
> æœ¬ã‚¹ã‚­ãƒ«ã¯ã€Œ90%ã®ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰é–‹ç™ºã€ã‚’ã‚«ãƒãƒ¼ã™ã‚‹å®Ÿè·µçš„ãªãƒ«ãƒ¼ãƒ«é›†ã§ã™ã€‚
> ã—ã‹ã—ã€æ®‹ã‚Š10%ã«ã¯æœ¬ã‚¹ã‚­ãƒ«ã§ã¯æ‰±ã‚ãªã„é¸æŠè‚¢ãŒå­˜åœ¨ã—ã¾ã™ã€‚
> 
> ã“ã®ãƒ‘ãƒ¼ãƒˆã§ã¯ã€Œæœ¬ã‚¹ã‚­ãƒ«ã‚’ä½¿ã‚ãªã„æ–¹ãŒè‰¯ã„ã‚±ãƒ¼ã‚¹ã€ã¨ã€ŒçŸ¥ã£ã¦ãŠãã¹ãä»£æ›¿ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã€ã‚’è§£èª¬ã—ã¾ã™ã€‚
> **èª­ã¿é£›ã°ã—å¯èƒ½**ã§ã™ãŒã€ã‚·ãƒ‹ã‚¢ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã‚’ç›®æŒ‡ã™ãªã‚‰ä¸€èª­ã‚’ãŠå‹§ã‚ã—ã¾ã™ã€‚

---

## 8.1 CQRS â€” 90%ã®ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã«ã¯éå‰°

### CQRS ã¨ã¯

**CQRSï¼ˆCommand Query Responsibility Segregationï¼‰**ã¨ã¯ã€èª­ã¿å–ã‚Šï¼ˆQueryï¼‰ã¨æ›¸ãè¾¼ã¿ï¼ˆCommandï¼‰ã‚’å®Œå…¨ã«åˆ†é›¢ã™ã‚‹ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã§ã™ã€‚

```
å¾“æ¥:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   åŒã˜ Model    â”‚ â† èª­ã¿æ›¸ãä¸¡æ–¹
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

CQRS:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Write Model    â”‚     â”‚   Read Model    â”‚
â”‚  (Commandå´)    â”‚     â”‚   (Queryå´)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†“                       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Write DB      â”‚ â”€â”€â†’ â”‚    Read DB      â”‚
â”‚  (æ­£è¦åŒ–)       â”‚ syncâ”‚  (éæ­£è¦åŒ–)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### ãªãœ CQRS ãŒé­…åŠ›çš„ã«è¦‹ãˆã‚‹ã‹

| ä¸»å¼µ | èª¬æ˜ |
|------|------|
| **ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£** | èª­ã¿å–ã‚Šã¨æ›¸ãè¾¼ã¿ã‚’ç‹¬ç«‹ã—ã¦ã‚¹ã‚±ãƒ¼ãƒ« |
| **æœ€é©åŒ–** | èª­ã¿å–ã‚Šç”¨ã«éæ­£è¦åŒ–ã—ãŸé«˜é€Ÿãªãƒ¢ãƒ‡ãƒ« |
| **è¤‡é›‘ãªã‚¯ã‚¨ãƒª** | é›†è¨ˆãƒ»æ¤œç´¢ã«ç‰¹åŒ–ã—ãŸãƒ¢ãƒ‡ãƒ«ã‚’æŒã¦ã‚‹ |

---

### ãªãœ 90% ã®ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã«ã¯éå‰°ã‹

**å‡ºå…¸: Udi Dahan "CQRS â€“ but different"**
> "CQRS is not a top-level architecture. It is a pattern that applies to a very specific slice of your system."

> "CQRS ã¯ãƒˆãƒƒãƒ—ãƒ¬ãƒ™ãƒ«ã®ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã§ã¯ãªã„ã€‚ã‚·ã‚¹ãƒ†ãƒ ã®éå¸¸ã«ç‰¹å®šã®éƒ¨åˆ†ã«é©ç”¨ã•ã‚Œã‚‹ãƒ‘ã‚¿ãƒ¼ãƒ³ã "

**å•é¡Œ1: è¤‡é›‘ã•ã®çˆ†ç™º**

```
å˜ç´”ãªCRUDï¼ˆCQRSãªã—ï¼‰:
- User ãƒ¢ãƒ‡ãƒ«: 1ã¤
- Repository: 1ã¤
- ãƒ†ãƒ¼ãƒ–ãƒ«: 1ã¤

CQRSé©ç”¨å¾Œ:
- UserWriteModel: æ›¸ãè¾¼ã¿ç”¨
- UserReadModel: èª­ã¿å–ã‚Šç”¨
- UserCommandRepository: æ›¸ãè¾¼ã¿ç”¨
- UserQueryRepository: èª­ã¿å–ã‚Šç”¨
- åŒæœŸå‡¦ç†: Write â†’ Read ã®åæ˜ 
- 2ã¤ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã€ã¾ãŸã¯2ã¤ã®DB
```

**å•é¡Œ2: Eventual Consistency ã®ç½ **

```typescript
// âŒ ã‚ˆãã‚ã‚‹å•é¡Œ: ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²ç›´å¾Œã«ã€Œãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚‰ãªã„ã€
async function registerUser(data: UserData) {
  await commandService.createUser(data);  // Write DB ã«ä¿å­˜
  
  redirect('/users/' + data.id);  // Read DB ã‚’å‚ç…§
  // â†’ "User not found" â€” åŒæœŸãŒã¾ã å®Œäº†ã—ã¦ã„ãªã„ï¼
}
```

**å‡ºå…¸: Martin Fowler "CQRS"**
> "For some situations, this kind of complexity is fine. For others, it's a significant burden that isn't worth the overhead."

> "çŠ¶æ³ã«ã‚ˆã£ã¦ã¯ã“ã®è¤‡é›‘ã•ã¯å•é¡Œãªã„ã€‚ã—ã‹ã—ä»–ã®å¤šãã®å ´åˆã€ã‚ªãƒ¼ãƒãƒ¼ãƒ˜ãƒƒãƒ‰ã«è¦‹åˆã‚ãªã„é‡å¤§ãªè² æ‹…ã«ãªã‚‹"

**å•é¡Œ3: ãƒ‡ãƒãƒƒã‚°ã®å›°é›£**

ã€Œãªãœ Read Model ã®ãƒ‡ãƒ¼ã‚¿ãŒå¤ã„ï¼Ÿã€
- ã‚¤ãƒ™ãƒ³ãƒˆãŒå¤±ã‚ã‚ŒãŸï¼Ÿ
- åŒæœŸãŒé…å»¶ã—ã¦ã„ã‚‹ï¼Ÿ
- ãƒã‚°ï¼Ÿ

---

### CQRS ã‚’æ¡ç”¨ã™ã¹ãå ´åˆ

| çŠ¶æ³ | æ¡ç”¨æ¨å¥¨åº¦ |
|------|:--------:|
| èª­ã¿å–ã‚Šã¨æ›¸ãè¾¼ã¿ã®ã‚¹ã‚±ãƒ¼ãƒ«ãŒ10å€ä»¥ä¸Šé•ã† | âœ… |
| è¤‡é›‘ãªæ¤œç´¢ãƒ»é›†è¨ˆãŒé »ç¹ã«ã‚ã‚‹ï¼ˆBIãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ç­‰ï¼‰ | âœ… |
| ã‚¤ãƒ™ãƒ³ãƒˆã‚½ãƒ¼ã‚·ãƒ³ã‚°ã‚’æ—¢ã«æ¡ç”¨ã—ã¦ã„ã‚‹ | âœ… |
| é€šå¸¸ã® CRUD ã‚¢ãƒ—ãƒª | âŒ |
| ãƒãƒ¼ãƒ ãŒ CQRS æœªçµŒé¨“ | âŒ |
| MVP / ãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ— | âŒ |

---

### æœ¬ã‚¹ã‚­ãƒ«ã¨ã®é–¢ä¿‚

æœ¬ã‚¹ã‚­ãƒ«ã®ã€Œ4åˆ†é¡ã€ã¯ **CQRS ã§ã¯ãªã„**:

| æœ¬ã‚¹ã‚­ãƒ« | CQRS |
|---------|------|
| åŒã˜ Repository ã‚’ä½¿ã† | åˆ¥ã€…ã® Repositoryï¼ˆWrite/Readï¼‰ |
| åŒã˜ DB | åˆ¥ã€…ã® DBï¼ˆã¾ãŸã¯åˆ¥ãƒ†ãƒ¼ãƒ–ãƒ«ï¼‰ |
| å³æ™‚ä¸€è²«æ€§ | Eventual Consistency |
| è²¬å‹™ã®åˆ†é¡ | ãƒ‡ãƒ¼ã‚¿ã‚¹ãƒˆã‚¢ã®åˆ†é›¢ |

æœ¬ã‚¹ã‚­ãƒ«ã® Command/Query ã¯ã€Œè²¬å‹™ã®æ˜ç¢ºåŒ–ã€ã§ã‚ã‚Šã€CQRSã®ã‚ˆã†ãªã€Œç‰©ç†çš„åˆ†é›¢ã€ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚

---

## 8.2 DDD â€” 5% ã®è¤‡é›‘ãªã‚¢ãƒ—ãƒªå‘ã‘

### DDD ã¨ã¯

**DDDï¼ˆDomain-Driven Designï¼‰**ã¨ã¯ã€Eric Evans ãŒ2003å¹´ã«æå”±ã—ãŸã€è¤‡é›‘ãªãƒ“ã‚¸ãƒã‚¹ãƒ‰ãƒ¡ã‚¤ãƒ³ã«å¯¾å‡¦ã™ã‚‹ãŸã‚ã®è¨­è¨ˆæ‰‹æ³•ã§ã™ã€‚

**ä¸»è¦ãªæ¦‚å¿µ:**
- Ubiquitous Languageï¼ˆãƒ¦ãƒ“ã‚­ã‚¿ã‚¹è¨€èªï¼‰
- Bounded Contextï¼ˆå¢ƒç•Œã¥ã‘ã‚‰ã‚ŒãŸã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆï¼‰
- Aggregateï¼ˆé›†ç´„ï¼‰
- Entity / Value Object
- Domain Event
- Repository

---

### ãªãœ DDD ãŒé­…åŠ›çš„ã«è¦‹ãˆã‚‹ã‹

| ä¸»å¼µ | èª¬æ˜ |
|------|------|
| **ãƒ“ã‚¸ãƒã‚¹ã¨ã‚³ãƒ¼ãƒ‰ã®ä¸€è‡´** | ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚¨ã‚­ã‚¹ãƒ‘ãƒ¼ãƒˆã¨åŒã˜è¨€è‘‰ã§è©±ã›ã‚‹ |
| **è¤‡é›‘ã•ã®ç®¡ç†** | Bounded Context ã§è¤‡é›‘ã•ã‚’åˆ†å‰² |
| **å¤‰æ›´ã¸ã®å¼·ã•** | ãƒ“ã‚¸ãƒã‚¹ãƒ«ãƒ¼ãƒ«ãŒã‚³ãƒ¼ãƒ‰ã«æ˜ç¤ºã•ã‚Œã‚‹ |

---

### ãªãœ 95% ã®ã‚¢ãƒ—ãƒªã«ã¯éå‰°ã‹

**å‡ºå…¸: Nick Tune "DDD is Overrated"**
> "Most systems are simple CRUD apps where DDD adds unnecessary complexity. Reserve DDD for genuinely complex domains."

> "ã»ã¨ã‚“ã©ã®ã‚·ã‚¹ãƒ†ãƒ ã¯å˜ç´”ãª CRUD ã‚¢ãƒ—ãƒªã§ã‚ã‚Šã€DDD ã¯ä¸å¿…è¦ãªè¤‡é›‘ã•ã‚’è¿½åŠ ã™ã‚‹ã€‚DDD ã¯æœ¬å½“ã«è¤‡é›‘ãªãƒ‰ãƒ¡ã‚¤ãƒ³ã®ãŸã‚ã«å–ã£ã¦ãŠã‘"

**å•é¡Œ1: ã€Œãƒ‰ãƒ¡ã‚¤ãƒ³ã‚¨ã‚­ã‚¹ãƒ‘ãƒ¼ãƒˆã€ãŒã„ãªã„**

```
DDD ã®å‰æ:
- ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚¨ã‚­ã‚¹ãƒ‘ãƒ¼ãƒˆãŒã„ã‚‹
- ã‚¨ã‚­ã‚¹ãƒ‘ãƒ¼ãƒˆã¨é–‹ç™ºè€…ãŒé »ç¹ã«å¯¾è©±ã™ã‚‹
- ãƒ¦ãƒ“ã‚­ã‚¿ã‚¹è¨€èªã‚’ä¸€ç·’ã«ä½œã‚‹

ç¾å®Ÿã®å¤šãã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ:
- ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚¨ã‚­ã‚¹ãƒ‘ãƒ¼ãƒˆ = å¿™ã—ã„å–¶æ¥­éƒ¨é•·ï¼ˆé€±1å›30åˆ†ã ã‘ï¼‰
- è¦ä»¶ = Excel ã®ä»•æ§˜æ›¸
- ã€Œãƒ¦ãƒ“ã‚­ã‚¿ã‚¹è¨€èªã€ã‚’ä½œã‚‹æ™‚é–“ãŒãªã„
```

**å•é¡Œ2: CRUD ã§ååˆ†ãªã‚±ãƒ¼ã‚¹ãŒå¤šã„**

```typescript
// âŒ DDD ã§è¨­è¨ˆã™ã‚‹ã¨...
class User extends AggregateRoot {
  private constructor(
    private readonly id: UserId,
    private readonly email: Email,
    private readonly profile: UserProfile
  ) {
    super();
  }
  
  static create(command: CreateUserCommand): User {
    const user = new User(
      UserId.generate(),
      Email.of(command.email),
      UserProfile.empty()
    );
    user.addDomainEvent(new UserCreatedEvent(user));
    return user;
  }
  
  updateProfile(command: UpdateProfileCommand): void {
    this.profile.update(command);
    this.addDomainEvent(new ProfileUpdatedEvent(this));
  }
}

// âœ… CRUD ã§ååˆ†ãªã‚±ãƒ¼ã‚¹
class User {
  constructor(
    readonly id: string,
    readonly email: string,
    readonly name: string
  ) {}
}

await db.users.insert({ id, email, name });
```

**å•é¡Œ3: Aggregate è¨­è¨ˆã®ç½ **

ã€ŒAggregate ã®å¢ƒç•Œã¯ã©ã“ï¼Ÿã€ã¨ã„ã†è­°è«–ã§1é€±é–“ãŒéãã‚‹ã€‚

```typescript
// Order ã¨ OrderItem ã¯åŒã˜ Aggregateï¼Ÿ
// User ã¨ Order ã®é–¢ä¿‚ã¯ï¼Ÿ
// Payment ã¯ Order ã®ä¸€éƒ¨ï¼Ÿåˆ¥ Aggregateï¼Ÿ

// â†’ æ­£è§£ãŒãªã„ã€‚ãƒãƒ¼ãƒ ã§å»¶ã€…ã¨è­°è«–ã«ãªã‚‹
```

---

### DDD ã‚’æ¡ç”¨ã™ã¹ãå ´åˆ

| çŠ¶æ³ | æ¡ç”¨æ¨å¥¨åº¦ |
|------|:--------:|
| ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚¨ã‚­ã‚¹ãƒ‘ãƒ¼ãƒˆã¨é »ç¹ã«å¯¾è©±ã§ãã‚‹ | âœ… |
| ãƒ“ã‚¸ãƒã‚¹ãƒ«ãƒ¼ãƒ«ãŒè¤‡é›‘ï¼ˆé‡‘èã€ä¿é™ºã€åŒ»ç™‚ï¼‰ | âœ… |
| é•·æœŸé‹ç”¨ï¼ˆ5å¹´ä»¥ä¸Šï¼‰ãŒç¢ºå®šã—ã¦ã„ã‚‹ | âœ… |
| å˜ç´”ãª CRUDï¼ˆç®¡ç†ç”»é¢ã€ãƒ–ãƒ­ã‚°ç­‰ï¼‰ | âŒ |
| MVP / ãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ— | âŒ |
| ãƒãƒ¼ãƒ ãŒ DDD æœªçµŒé¨“ | â–³ ï¼ˆå­¦ç¿’ã‚³ã‚¹ãƒˆã‚’è¦šæ‚Ÿï¼‰ |

---

### æœ¬ã‚¹ã‚­ãƒ«ã¨ã®é–¢ä¿‚

æœ¬ã‚¹ã‚­ãƒ«ã¯ **DDD ã®ä¸€éƒ¨ã‚’å–ã‚Šå…¥ã‚Œã¦ã„ã‚‹**:

| æ¦‚å¿µ | æœ¬ã‚¹ã‚­ãƒ« | å®Œå…¨ãª DDD |
|------|---------|-----------|
| Value Object | âœ… æ¡ç”¨ | âœ… |
| Entity | â–³ éƒ¨åˆ†çš„ï¼ˆPending Objectï¼‰ | âœ… |
| Repository | âœ… æ¡ç”¨ | âœ… |
| Aggregate | âŒ ä¸æ¡ç”¨ | âœ… |
| Bounded Context | âŒ ä¸æ¡ç”¨ | âœ… |
| Domain Event | âŒ ä¸æ¡ç”¨ | âœ… |
| Ubiquitous Language | â–³ æ„è­˜ã™ã‚‹ãŒå³å¯†ã§ã¯ãªã„ | âœ… |

**æœ¬ã‚¹ã‚­ãƒ«ã®ç«‹å ´:** DDD ã®ã€Œè‰¯ã„ã¨ã“å–ã‚Šã€ã€‚Value Object ã¨ Repository ã¯æ±ç”¨çš„ã«æœ‰ç”¨ã€‚Aggregate ã‚„ Bounded Context ã¯ã€Œæœ¬å½“ã«å¿…è¦ãªæ™‚ã ã‘ã€ã€‚

---

## 8.3 Microservices vs Monolith vs Modular Monolith

### 3ã¤ã®ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

| ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ | æ¦‚è¦ | ãƒ‡ãƒ—ãƒ­ã‚¤å˜ä½ |
|--------------|------|-------------|
| **Monolith** | å˜ä¸€ã®ã‚³ãƒ¼ãƒ‰ãƒ™ãƒ¼ã‚¹ã€å˜ä¸€ã®ãƒ‡ãƒ—ãƒ­ã‚¤ | 1ã¤ |
| **Microservices** | æ©Ÿèƒ½ã”ã¨ã«ç‹¬ç«‹ã—ãŸã‚µãƒ¼ãƒ“ã‚¹ | å¤šæ•° |
| **Modular Monolith** | å˜ä¸€ãƒ‡ãƒ—ãƒ­ã‚¤ã ãŒå†…éƒ¨ã¯ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«åˆ†é›¢ | 1ã¤ |

---

### ãªãœ Microservices ãŒé­…åŠ›çš„ã«è¦‹ãˆã‚‹ã‹

| ä¸»å¼µ | èª¬æ˜ |
|------|------|
| **ç‹¬ç«‹ãƒ‡ãƒ—ãƒ­ã‚¤** | 1ã¤ã®ã‚µãƒ¼ãƒ“ã‚¹ã ã‘æ›´æ–°ã§ãã‚‹ |
| **æŠ€è¡“é¸æŠã®è‡ªç”±** | ã‚µãƒ¼ãƒ“ã‚¹ã”ã¨ã«è¨€èªãƒ»DBã‚’é¸ã¹ã‚‹ |
| **ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£** | å¿…è¦ãªã‚µãƒ¼ãƒ“ã‚¹ã ã‘ã‚¹ã‚±ãƒ¼ãƒ« |
| **éšœå®³åˆ†é›¢** | 1ã¤ãŒè½ã¡ã¦ã‚‚å…¨ä½“ã¯å‹•ã |

---

### ãªãœå¤šãã®ã‚±ãƒ¼ã‚¹ã§å¤±æ•—ã™ã‚‹ã‹

**å‡ºå…¸: Amazon Prime Video "Scaling up the Prime Video audio/video monitoring service" (2023)**

> "Microservices architecture wasn't delivering the cost savings we expected. Moving to a monolith reduced our infrastructure cost by over 90%."

> "ãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã¯æœŸå¾…ã—ãŸã‚³ã‚¹ãƒˆå‰Šæ¸›ã‚’é”æˆã§ããªã‹ã£ãŸã€‚ãƒ¢ãƒãƒªã‚¹ã«ç§»è¡Œã™ã‚‹ã“ã¨ã§ã€ã‚¤ãƒ³ãƒ•ãƒ©ã‚³ã‚¹ãƒˆã‚’90%ä»¥ä¸Šå‰Šæ¸›ã§ããŸ"

**Prime Video ã®äº‹ä¾‹:**
- ãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹ã§æ§‹ç¯‰ â†’ AWS Step Functions + Lambda
- ã‚³ã‚¹ãƒˆãŒé«˜ã™ããŸï¼ˆã‚µãƒ¼ãƒ“ã‚¹é–“é€šä¿¡ã€ã‚ªãƒ¼ã‚±ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰
- ãƒ¢ãƒãƒªã‚¹ã«çµ±åˆ â†’ ã‚³ã‚¹ãƒˆ 90% å‰Šæ¸›

**å‡ºå…¸: Istio (Google) "Istio's move to a monolithic architecture"**

> "The original microservices architecture, while theoretically pure, created operational complexity that slowed down development."

> "å…ƒã®ãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã¯ç†è«–çš„ã«ã¯ç´”ç²‹ã ã£ãŸãŒã€é–‹ç™ºã‚’é…ãã™ã‚‹é‹ç”¨ä¸Šã®è¤‡é›‘ã•ã‚’ç”Ÿã¿å‡ºã—ãŸ"

---

### Microservices ã®éš ã‚ŒãŸã‚³ã‚¹ãƒˆ

| ã‚³ã‚¹ãƒˆ | èª¬æ˜ |
|--------|------|
| **åˆ†æ•£ã‚·ã‚¹ãƒ†ãƒ ã®è¤‡é›‘ã•** | ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯é…å»¶ã€éƒ¨åˆ†éšœå®³ã€å†ªç­‰æ€§ |
| **ãƒ‡ãƒ¼ã‚¿ä¸€è²«æ€§** | åˆ†æ•£ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã€Saga ãƒ‘ã‚¿ãƒ¼ãƒ³ |
| **é‹ç”¨è² è·** | ã‚µãƒ¼ãƒ“ã‚¹ã”ã¨ã«ç›£è¦–ã€ãƒ­ã‚°ã€ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ |
| **ãƒ†ã‚¹ãƒˆã®è¤‡é›‘ã•** | ã‚µãƒ¼ãƒ“ã‚¹é–“ã®çµåˆãƒ†ã‚¹ãƒˆã€Contract Testing |
| **ãƒãƒ¼ãƒ èª¿æ•´** | ã‚µãƒ¼ãƒ“ã‚¹é–“ API ã®å¤‰æ›´èª¿æ•´ |

```
âŒ ã‚ˆãã‚ã‚‹å¤±æ•—ãƒ‘ã‚¿ãƒ¼ãƒ³:

1. ã€Œãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹ã«ã—ã‚ˆã†ï¼ã€
2. 5äººã®ãƒãƒ¼ãƒ ã§10å€‹ã®ã‚µãƒ¼ãƒ“ã‚¹ã‚’ä½œã‚‹
3. 1äººãŒ2ã‚µãƒ¼ãƒ“ã‚¹æ‹…å½“ â†’ ã€Œç‹¬ç«‹ã—ãŸãƒãƒ¼ãƒ ã€ã®åˆ©ç‚¹ãªã—
4. ã‚µãƒ¼ãƒ“ã‚¹é–“ã®èª¿æ•´ã«æ™‚é–“ã‚’å–ã‚‰ã‚Œã‚‹
5. çµå±€ãƒ¢ãƒãƒªã‚¹ã‚ˆã‚Šé…ã„
```

---

### Modular Monolith ã¨ã„ã†é¸æŠè‚¢

**å‡ºå…¸: Shopify Engineering "Deconstructing the Monolith"**

> "We didn't go microservices. We modularized our monolith. Each module has clear boundaries and can be extracted to a service if needed."

> "ãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹ã«ã¯ã—ãªã‹ã£ãŸã€‚ãƒ¢ãƒãƒªã‚¹ã‚’ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«åŒ–ã—ãŸã€‚å„ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã¯æ˜ç¢ºãªå¢ƒç•Œã‚’æŒã¡ã€å¿…è¦ã«å¿œã˜ã¦ã‚µãƒ¼ãƒ“ã‚¹ã¨ã—ã¦æŠ½å‡ºã§ãã‚‹"

```
Modular Monolith:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            å˜ä¸€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Catalog â”‚ â”‚ Orders  â”‚ â”‚Payments â”‚ â”‚
â”‚  â”‚ Module  â”‚ â”‚ Module  â”‚ â”‚ Module  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚       â†“           â†“           â†“      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚         å…±æœ‰ Database           â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«é–“ã¯æ˜ç¢ºãªã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã§é€šä¿¡
å¿…è¦ã«ãªã£ãŸã‚‰ Module â†’ Service ã«æŠ½å‡ºå¯èƒ½
```

---

### æ¡ç”¨åˆ¤æ–­ã‚¬ã‚¤ãƒ‰

| çŠ¶æ³ | æ¨å¥¨ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ |
|------|------------------|
| ã‚¹ã‚¿ãƒ¼ãƒˆã‚¢ãƒƒãƒ—ã€MVP | Monolith |
| ãƒãƒ¼ãƒ 5äººä»¥ä¸‹ | Monolith |
| ãƒãƒ¼ãƒ 10-50äººã€è¤‡æ•°ãƒ‰ãƒ¡ã‚¤ãƒ³ | Modular Monolith |
| ãƒãƒ¼ãƒ 50äººä»¥ä¸Šã€ç‹¬ç«‹ã—ãŸãƒ—ãƒ­ãƒ€ã‚¯ãƒˆ | Microservices |
| ç‰¹å®šæ©Ÿèƒ½ã ã‘åˆ¥ã‚¹ã‚±ãƒ¼ãƒ«ãŒå¿…è¦ | Monolith + ä¸€éƒ¨ Service åˆ†é›¢ |
| ã€ŒMicroservices ãŒãƒˆãƒ¬ãƒ³ãƒ‰ã ã‹ã‚‰ã€ | âŒ Monolith ã§å§‹ã‚ã‚ |

---

### æœ¬ã‚¹ã‚­ãƒ«ã¨ã®é–¢ä¿‚

æœ¬ã‚¹ã‚­ãƒ«ã® Screaming Architecture ã¯ **Modular Monolith ã¨ç›¸æ€§ãŒè‰¯ã„**:

```
âœ… æœ¬ã‚¹ã‚­ãƒ«ã®æ¨å¥¨æ§‹é€ ï¼ˆScreaming Architectureï¼‰
src/
â”œâ”€â”€ catalog/      # å°†æ¥ Service ã«åˆ†é›¢å¯èƒ½
â”œâ”€â”€ ordering/     # å°†æ¥ Service ã«åˆ†é›¢å¯èƒ½
â”œâ”€â”€ payments/     # å°†æ¥ Service ã«åˆ†é›¢å¯èƒ½
â””â”€â”€ shared/       # å…±é€šã‚³ãƒ¼ãƒ‰ï¼ˆåˆ†é›¢ã—ãªã„ï¼‰
```

æœ€åˆã‹ã‚‰ã€Œåˆ†é›¢å¯èƒ½ãªæ§‹é€ ã€ã§ä½œã£ã¦ãŠã‘ã°ã€æœ¬å½“ã«å¿…è¦ã«ãªã£ãŸæ™‚ã ã‘ Microservices ã«ç§»è¡Œã§ãã¾ã™ã€‚

---

## 8.4 ã‚³ãƒ¡ãƒ³ãƒˆ vs è‡ªå·±æ–‡æ›¸åŒ–ã‚³ãƒ¼ãƒ‰

### 2ã¤ã®è€ƒãˆæ–¹

| è€ƒãˆæ–¹ | ä¸»å¼µ |
|--------|------|
| **è‡ªå·±æ–‡æ›¸åŒ–ã‚³ãƒ¼ãƒ‰æ´¾** | è‰¯ã„ã‚³ãƒ¼ãƒ‰ã¯ã‚³ãƒ¡ãƒ³ãƒˆä¸è¦ã€‚ã‚³ãƒ¡ãƒ³ãƒˆã¯ã€Œã‚³ãƒ¼ãƒ‰ã®å¤±æ•—ã€ |
| **ã‚³ãƒ¡ãƒ³ãƒˆé‡è¦–æ´¾** | WHY ã¯å¸¸ã«ã‚³ãƒ¡ãƒ³ãƒˆã§æ›¸ãã¹ã |

---

### Uncle Bob ã®ä¸»å¼µ

**å‡ºå…¸: Robert C. Martin "Clean Code" (2008)**

> "Comments are always failures. We must have them because we cannot always figure out how to express ourselves without them, but their use is not a cause for celebration."

> "ã‚³ãƒ¡ãƒ³ãƒˆã¯å¸¸ã«å¤±æ•—ã§ã‚ã‚‹ã€‚ã‚³ãƒ¡ãƒ³ãƒˆãªã—ã§è‡ªåˆ†ã‚’è¡¨ç¾ã™ã‚‹æ–¹æ³•ãŒåˆ†ã‹ã‚‰ãªã„ã¨ãã«ä½¿ã‚ã–ã‚‹ã‚’å¾—ãªã„ãŒã€ãã®ä½¿ç”¨ã¯ç¥ç¦ã™ã¹ãã“ã¨ã§ã¯ãªã„"

**Uncle Bob ã®ç«‹å ´:**
- è‰¯ã„åå‰ã‚’ä»˜ã‘ã‚Œã°ã‚³ãƒ¡ãƒ³ãƒˆã¯ä¸è¦
- ã‚³ãƒ¡ãƒ³ãƒˆã¯å˜˜ã‚’ã¤ãï¼ˆã‚³ãƒ¼ãƒ‰ã¨ä¹–é›¢ã™ã‚‹ï¼‰
- ã‚³ãƒ¡ãƒ³ãƒˆã¯ä¿å®ˆã•ã‚Œãªã„

```java
// âŒ ã‚³ãƒ¡ãƒ³ãƒˆã§èª¬æ˜ï¼ˆUncle Bob ãŒæ‰¹åˆ¤ã™ã‚‹ã‚¹ã‚¿ã‚¤ãƒ«ï¼‰
// Check if the user is eligible for the discount
if (user.purchaseCount > 10 && user.memberSince.isBefore(oneYearAgo)) {
  applyDiscount();
}

// âœ… è‡ªå·±æ–‡æ›¸åŒ–ï¼ˆUncle Bob ãŒæ¨å¥¨ã™ã‚‹ã‚¹ã‚¿ã‚¤ãƒ«ï¼‰
if (user.isEligibleForLoyaltyDiscount()) {
  applyDiscount();
}
```

---

### æ‰¹åˆ¤ã¨åè«–

**å•é¡Œ: WHY ã¯åå‰ã ã‘ã§ã¯è¡¨ç¾ã§ããªã„**

```typescript
// âœ… ã“ã‚Œã¯è‡ªå·±æ–‡æ›¸åŒ–ã§ãã‚‹ï¼ˆWHATï¼‰
function calculateTax(price: Money, rate: TaxRate): Money {
  return price.multiply(rate.value);
}

// âŒ ã“ã‚Œã¯è‡ªå·±æ–‡æ›¸åŒ–ã§ã¯è¡¨ç¾ã§ããªã„ï¼ˆWHYï¼‰
// ãªãœ 1.08 ã§ã¯ãªã 1.1 ãªã®ã‹ï¼Ÿ
// â†’ 2024å¹´ã®æ³•æ”¹æ­£ã§ç¨ç‡ãŒå¤‰ã‚ã£ãŸã‹ã‚‰
// â†’ ã“ã®æƒ…å ±ã¯ãƒ¡ã‚½ãƒƒãƒ‰åã§ã¯è¡¨ç¾ã§ããªã„
```

**å‡ºå…¸: Jeff Atwood "Coding Horror" - "Code Tells You How, Comments Tell You Why"**

> "Code can only tell you HOW the program works. Comments can tell you WHY."

> "ã‚³ãƒ¼ãƒ‰ã¯ HOWï¼ˆã©ã†å‹•ãã‹ï¼‰ã—ã‹ä¼ãˆã‚‰ã‚Œãªã„ã€‚ã‚³ãƒ¡ãƒ³ãƒˆã¯ WHYï¼ˆãªãœãã†ã™ã‚‹ã‹ï¼‰ã‚’ä¼ãˆã‚‰ã‚Œã‚‹"

---

### æœ¬ã‚¹ã‚­ãƒ«ã®ç«‹å ´

| ç¨®é¡ | ã‚³ãƒ¡ãƒ³ãƒˆ | ç†ç”± |
|------|:------:|------|
| **WHATï¼ˆä½•ã‚’ã—ã¦ã„ã‚‹ã‹ï¼‰** | âŒ ä¸è¦ | ã‚³ãƒ¼ãƒ‰è‡ªä½“ã§è¡¨ç¾ã™ã¹ã |
| **HOWï¼ˆã©ã†å‹•ãã‹ï¼‰** | âŒ ä¸è¦ | ã‚³ãƒ¼ãƒ‰è‡ªä½“ã§è¡¨ç¾ã™ã¹ã |
| **WHYï¼ˆãªãœãã†ã™ã‚‹ã‹ï¼‰** | âœ… å¿…è¦ | ã‚³ãƒ¼ãƒ‰ã§ã¯è¡¨ç¾ã§ããªã„ |
| **WARNINGï¼ˆæ³¨æ„äº‹é …ï¼‰** | âœ… å¿…è¦ | è½ã¨ã—ç©´ã®è­¦å‘Š |
| **TODO** | â–³ ä¸€æ™‚çš„ | Issue ã«ç§»è¡Œã™ã¹ã |

---

### è‰¯ã„ã‚³ãƒ¡ãƒ³ãƒˆã®ä¾‹

```typescript
// âœ… WHY: ãƒ“ã‚¸ãƒã‚¹ä¸Šã®ç†ç”±
// 2024å¹´4æœˆã®æ³•æ”¹æ­£ã«ã‚ˆã‚Šã€æ¶ˆè²»ç¨ç‡ãŒ10%ã‹ã‚‰11%ã«å¤‰æ›´
// æ–½è¡Œæ—¥: 2024-04-01
// å‚ç…§: https://example.com/tax-law-2024
const TAX_RATE = 0.11;

// âœ… WARNING: è½ã¨ã—ç©´ã®è­¦å‘Š
// âš ï¸ ã“ã® API ã¯1ç§’ã‚ãŸã‚Š10ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®åˆ¶é™ãŒã‚ã‚‹
// åˆ¶é™ã‚’è¶…ãˆã‚‹ã¨ 429 ãŒè¿”ã‚‹
// å‚ç…§: https://api.example.com/docs/rate-limits
await externalApi.fetch(data);

// âœ… WHY: éè‡ªæ˜ãªè¨­è¨ˆåˆ¤æ–­
// ãªãœ Redis ã§ã¯ãªã PostgreSQL ã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ä½¿ã†ã®ã‹:
// 1. æ—¢å­˜ã‚¤ãƒ³ãƒ•ãƒ©ã§ Redis ãŒãªã„
// 2. ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ›´æ–°é »åº¦ãŒä½ã„ï¼ˆ1æ—¥1å›ï¼‰
// 3. PostgreSQL ã® UNLOGGED TABLE ã§ååˆ†ãªæ€§èƒ½
class PostgresCacheRepository implements CacheRepository {
  // ...
}
```

---

### æ‚ªã„ã‚³ãƒ¡ãƒ³ãƒˆã®ä¾‹

```typescript
// âŒ WHAT: ã‚³ãƒ¼ãƒ‰ã‚’èª­ã‚ã°åˆ†ã‹ã‚‹
// ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å–å¾—ã™ã‚‹
const user = await userRepository.findById(id);

// âŒ å˜˜ã®ã‚³ãƒ¡ãƒ³ãƒˆï¼ˆã‚³ãƒ¼ãƒ‰ã¨ä¹–é›¢ï¼‰
// ç¨ç‡10%ã§è¨ˆç®—
const tax = price * 0.11;  // å®Ÿéš›ã¯11%

// âŒ ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆã•ã‚ŒãŸã‚³ãƒ¼ãƒ‰
// function oldCalculation() {
//   return price * 0.08;
// }

// âŒ æ„å‘³ã®ãªã„ã‚³ãƒ¡ãƒ³ãƒˆ
// ----------------
// User Class
// ----------------
class User {
```

---


# Part A: ç†è«–çš„èƒŒæ™¯ â€” ãªãœã“ã‚Œã‚‰ã®ãƒ«ãƒ¼ãƒ«ãªã®ã‹

> **ã“ã®ãƒ‘ãƒ¼ãƒˆã«ã¤ã„ã¦:**
> æœ¬ã‚¹ã‚­ãƒ«ã®ãƒ«ãƒ¼ãƒ«ã¯ã€50å¹´ä»¥ä¸Šã®ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢è¨­è¨ˆç ”ç©¶ã«åŸºã¥ã„ã¦ã„ã¾ã™ã€‚
> ã“ã“ã§ã¯ã€Œãªãœã“ã®ãƒ«ãƒ¼ãƒ«ãªã®ã‹ã€ã®ç†è«–çš„æ ¹æ‹ ã‚’è§£èª¬ã—ã¾ã™ã€‚
> 
> **èª­ã¿é£›ã°ã—å¯èƒ½**ã§ã™ã€‚ã¾ãšã¯Part 1-7ã§ãƒ«ãƒ¼ãƒ«ã‚’å­¦ã³ã€
> ã€Œãªãœï¼Ÿã€ãŒæ°—ã«ãªã£ãŸã‚‰æˆ»ã£ã¦ãã¦ãã ã•ã„ã€‚

---

## A.1 å‡é›†åº¦ã¨çµåˆåº¦ï¼ˆCohesion and Couplingï¼‰

### ãªãœã“ã‚ŒãŒæœ€ã‚‚é‡è¦ãªæ¦‚å¿µãªã®ã‹

**å‡é›†åº¦**ã¨**çµåˆåº¦**ã¯ã€ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢è¨­è¨ˆã«ãŠã‘ã‚‹æœ€ã‚‚åŸºç¤çš„ãªå“è³ªæŒ‡æ¨™ã§ã™ã€‚1974å¹´ã«Larry Constantineã¨Edward YourdonãŒæå”±ã—ã¦ä»¥æ¥ã€50å¹´é–“å¤‰ã‚ã‚‰ãšè¨­è¨ˆã®æ ¹å¹¹ã‚’æˆã—ã¦ã„ã¾ã™ã€‚

**ãƒŸãƒé§†å‹•æœ¬ï¼ˆæˆç€¬å…å®£ã€è‰¯ã„ã‚³ãƒ¼ãƒ‰/æ‚ªã„ã‚³ãƒ¼ãƒ‰ã§å­¦ã¶è¨­è¨ˆå…¥é–€ã€ï¼‰** ã§ã‚‚ã€å‡é›†åº¦ã¨çµåˆåº¦ã¯å…¨ãƒ«ãƒ¼ãƒ«ã®æ ¹æ‹ ã¨ã—ã¦ç¹°ã‚Šè¿”ã—ç™»å ´ã—ã¾ã™ã€‚

| æŒ‡æ¨™ | å®šç¾© | è‰¯ã„çŠ¶æ…‹ | æ‚ªã„çŠ¶æ…‹ |
|------|------|---------|---------|
| **å‡é›†åº¦ï¼ˆCohesionï¼‰** | ã‚¯ãƒ©ã‚¹å†…ã®è¦ç´ ãŒã©ã‚Œã ã‘å¯†æ¥ã«é–¢é€£ã—ã¦ã„ã‚‹ã‹ | é«˜å‡é›†ï¼ˆHigh Cohesionï¼‰ | ä½å‡é›†ï¼ˆLow Cohesionï¼‰ |
| **çµåˆåº¦ï¼ˆCouplingï¼‰** | ã‚¯ãƒ©ã‚¹é–“ãŒã©ã‚Œã ã‘ä¾å­˜ã—åˆã£ã¦ã„ã‚‹ã‹ | ä½çµåˆï¼ˆLoose Couplingï¼‰ | é«˜çµåˆï¼ˆTight Couplingï¼‰ |

**ç›®æ¨™ã¯ã€Œé«˜å‡é›†ãƒ»ä½çµåˆã€ã§ã™ã€‚**

### é«˜å‡é›†ï¼ˆHigh Cohesionï¼‰

**é«˜å‡é›†**ã¨ã¯ã€ã€Œ1ã¤ã®ã‚¯ãƒ©ã‚¹ãŒ1ã¤ã®è²¬å‹™ã«é›†ä¸­ã—ã¦ã„ã‚‹ã€çŠ¶æ…‹ã§ã™ã€‚

```typescript
// âŒ ä½å‡é›†: è¤‡æ•°ã®è²¬å‹™ãŒæ··åœ¨
class UserManager {
  validateEmail(email: string): boolean { /* ... */ }
  hashPassword(password: string): string { /* ... */ }
  sendWelcomeEmail(user: User): void { /* ... */ }
  calculateLoyaltyPoints(user: User): number { /* ... */ }
  generateReport(users: User[]): string { /* ... */ }
}

// âœ… é«˜å‡é›†: å„ã‚¯ãƒ©ã‚¹ãŒ1ã¤ã®è²¬å‹™ã«é›†ä¸­
class EmailValidator { validate(email: string): boolean { /* ... */ } }
class PasswordHasher { hash(password: string): string { /* ... */ } }
class WelcomeEmailSender { send(user: User): void { /* ... */ } }
class LoyaltyPointsCalculator { calculate(user: User): number { /* ... */ } }
class UserReportGenerator { generate(users: User[]): string { /* ... */ } }
```

**ãªãœé«˜å‡é›†ãŒè‰¯ã„ã®ã‹:**
- å¤‰æ›´ç†ç”±ãŒ1ã¤ â†’ å¤‰æ›´æ™‚ã«ä»–ã®æ©Ÿèƒ½ã«å½±éŸ¿ã—ãªã„
- ã‚¯ãƒ©ã‚¹åã‚’è¦‹ã‚Œã°ä½•ã‚’ã™ã‚‹ã‹åˆ†ã‹ã‚‹
- ãƒ†ã‚¹ãƒˆãŒæ›¸ãã‚„ã™ã„ï¼ˆè²¬å‹™ãŒæ˜ç¢ºï¼‰

### ä½çµåˆï¼ˆLoose Couplingï¼‰

**ä½çµåˆ**ã¨ã¯ã€ã€Œã‚¯ãƒ©ã‚¹é–“ã®ä¾å­˜ãŒæœ€å°é™ã€ãªçŠ¶æ…‹ã§ã™ã€‚

```typescript
// âŒ é«˜çµåˆ: OrderService ãŒ MySQL ã®å†…éƒ¨å®Ÿè£…ã«ä¾å­˜
class OrderService {
  constructor(private mysqlConnection: MySQLConnection) {}
  
  save(order: Order): void {
    // MySQL å›ºæœ‰ã® SQL ã‚’ç›´æ¥å®Ÿè¡Œ
    this.mysqlConnection.query(`INSERT INTO orders VALUES (...)`)
  }
}

// âœ… ä½çµåˆ: ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã«ä¾å­˜
interface OrderRepository {
  save(order: Order): Promise<void>
}

class OrderService {
  save(order: Order, repository: OrderRepository): Promise<void> {
    return repository.save(order)
  }
}
```

**ãªãœä½çµåˆãŒè‰¯ã„ã®ã‹:**
- ä¾å­˜å…ˆã‚’å·®ã—æ›¿ãˆã‚‰ã‚Œã‚‹ï¼ˆMySQL â†’ PostgreSQLï¼‰
- ãƒ†ã‚¹ãƒˆæ™‚ã«ãƒ¢ãƒƒã‚¯ã‚’æ³¨å…¥ã§ãã‚‹
- å¤‰æ›´ã®å½±éŸ¿ç¯„å›²ãŒé™å®šã•ã‚Œã‚‹

### æœ¬ã‚¹ã‚­ãƒ«ã®4åˆ†é¡ã¨å‡é›†åº¦ã®é–¢ä¿‚

æœ¬ã‚¹ã‚­ãƒ«ã®4åˆ†é¡ï¼ˆCommand / Transition / Query / ReadModelï¼‰ã¯ã€**å‡é›†åº¦ã‚’æœ€å¤§åŒ–ã™ã‚‹è¨­è¨ˆãƒ‘ã‚¿ãƒ¼ãƒ³**ã§ã™ï¼š

| åˆ†é¡ | è²¬å‹™ | å‡é›†åº¦ã¸ã®è²¢çŒ® |
|------|------|--------------|
| **Command** | å‰¯ä½œç”¨ã‚’å®Ÿè¡Œã™ã‚‹ | å‰¯ä½œç”¨ã‚’1ç®‡æ‰€ã«é›†ç´„ï¼ˆä»–ã®ã‚¯ãƒ©ã‚¹ã¯å‰¯ä½œç”¨ã‚’æŒãŸãªã„ï¼‰ |
| **Transition** | çŠ¶æ…‹é·ç§»ãƒ­ã‚¸ãƒƒã‚¯ | ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã‚’1ç®‡æ‰€ã«é›†ç´„ |
| **Query** | ç´”ç²‹ãªè¨ˆç®— | å…¥åŠ›â†’å‡ºåŠ›ã®å¤‰æ›ã«é›†ä¸­ |
| **ReadModel** | èª­ã¿å–ã‚Šå°‚ç”¨ãƒ‡ãƒ¼ã‚¿ | è¡¨ç¤ºç”¨ãƒ‡ãƒ¼ã‚¿ã®ä¿æŒã«é›†ä¸­ |

**å¾“æ¥ã®ã‚¢ãƒ—ãƒ­ãƒ¼ãƒï¼ˆServiceå±¤ã«å…¨éƒ¨å…¥ã‚Œã‚‹ï¼‰ã¨ã®æ¯”è¼ƒ:**

```typescript
// âŒ ä½å‡é›†: Service ã«å…¨è²¬å‹™ãŒé›†ä¸­
class OrderService {
  create(dto: OrderDTO): Order { /* ç”Ÿæˆãƒ­ã‚¸ãƒƒã‚¯ */ }
  validate(order: Order): boolean { /* æ¤œè¨¼ãƒ­ã‚¸ãƒƒã‚¯ */ }
  save(order: Order): void { /* DBä¿å­˜ */ }
  calculateTotal(order: Order): number { /* è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ */ }
  sendConfirmation(order: Order): void { /* ãƒ¡ãƒ¼ãƒ«é€ä¿¡ */ }
}

// âœ… é«˜å‡é›†: è²¬å‹™ã”ã¨ã«åˆ†é›¢ï¼ˆ4åˆ†é¡ï¼‰
class OrderCreator { create(dto: OrderDTO): Order { /* Transition */ } }
class OrderValidator { validate(order: Order): boolean { /* Query */ } }
class OrderSaver { save(order: Order, repo: OrderRepository): void { /* Command */ } }
class OrderTotalCalculator { calculate(order: Order): number { /* Query */ } }
class OrderConfirmationSender { send(order: Order, mailer: Mailer): void { /* Command */ } }
```

### å‡é›†åº¦ã®7æ®µéšï¼ˆLarry Constantineï¼‰

æ­´å²çš„ã«ã€å‡é›†åº¦ã¯7æ®µéšã§åˆ†é¡ã•ã‚Œã¾ã™ï¼ˆä¸Šã»ã©è‰¯ã„ï¼‰ï¼š

| ãƒ¬ãƒ™ãƒ« | åç§° | èª¬æ˜ | æœ¬ã‚¹ã‚­ãƒ«ã¨ã®é–¢ä¿‚ |
|--------|------|------|----------------|
| 1ï¼ˆæœ€é«˜ï¼‰ | æ©Ÿèƒ½çš„å‡é›† | 1ã¤ã®æ©Ÿèƒ½ã®ã¿ã‚’å®Ÿè¡Œ | âœ… 4åˆ†é¡ã®å„ã‚¯ãƒ©ã‚¹ |
| 2 | é †åºçš„å‡é›† | é †ç•ªã«å®Ÿè¡Œã•ã‚Œã‚‹å‡¦ç†ã‚’ã¾ã¨ã‚ã‚‹ | â–³ Commandã§è¨±å®¹ |
| 3 | é€šä¿¡çš„å‡é›† | åŒã˜ãƒ‡ãƒ¼ã‚¿ã‚’æ‰±ã†å‡¦ç†ã‚’ã¾ã¨ã‚ã‚‹ | â–³ æ³¨æ„ãŒå¿…è¦ |
| 4 | æ‰‹ç¶šãçš„å‡é›† | å®Ÿè¡Œé †åºã§ã¾ã¨ã‚ã‚‹ | âŒ é¿ã‘ã‚‹ã¹ã |
| 5 | æ™‚é–“çš„å‡é›† | åŒæ™‚ã«å®Ÿè¡Œã•ã‚Œã‚‹å‡¦ç†ã‚’ã¾ã¨ã‚ã‚‹ | âŒ é¿ã‘ã‚‹ã¹ã |
| 6 | è«–ç†çš„å‡é›† | è«–ç†çš„ã«ä¼¼ãŸå‡¦ç†ã‚’ã¾ã¨ã‚ã‚‹ | âŒ é¿ã‘ã‚‹ã¹ã |
| 7ï¼ˆæœ€ä½ï¼‰ | å¶ç™ºçš„å‡é›† | ãŸã¾ãŸã¾ä¸€ç·’ã«ã‚ã‚‹ã ã‘ | âŒ æœ€æ‚ª |

**æœ¬ã‚¹ã‚­ãƒ«ã®ç›®æ¨™:** ã™ã¹ã¦ã®ã‚¯ãƒ©ã‚¹ã‚’ã€Œæ©Ÿèƒ½çš„å‡é›†ï¼ˆãƒ¬ãƒ™ãƒ«1ï¼‰ã€ã«ã™ã‚‹ã€‚

---

## A.2 SOLIDåŸå‰‡

**SOLIDåŸå‰‡**ã¯ã€Robert C. Martinï¼ˆUncle Bobï¼‰ãŒ2000å¹´ä»£ã«ã¾ã¨ã‚ãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆæŒ‡å‘è¨­è¨ˆã®5åŸå‰‡ã§ã™ã€‚æœ¬ã‚¹ã‚­ãƒ«ã®å¤šãã®ãƒ«ãƒ¼ãƒ«ã¯ã€SOLIDåŸå‰‡ã‚’å…·ä½“åŒ–ã—ãŸã‚‚ã®ã§ã™ã€‚

### S: Single Responsibility Principleï¼ˆå˜ä¸€è²¬ä»»åŸå‰‡ï¼‰

> **ã€Œã‚¯ãƒ©ã‚¹ã‚’å¤‰æ›´ã™ã‚‹ç†ç”±ã¯1ã¤ã ã‘ã§ã‚ã‚‹ã¹ãã€**

**é‡è¦:** SRPã¯ã€Œ1ã‚¯ãƒ©ã‚¹1ãƒ¡ã‚½ãƒƒãƒ‰ã€ã¨ã„ã†æ„å‘³ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ã€Œå¤‰æ›´ç†ç”±ãŒ1ã¤ã€ã¨ã„ã†æ„å‘³ã§ã™ã€‚

```typescript
// âŒ è¤‡æ•°ã®å¤‰æ›´ç†ç”±ãŒã‚ã‚‹
class Employee {
  calculatePay(): Money { /* çµ¦ä¸è¨ˆç®—ãƒ«ãƒ¼ãƒ«ãŒå¤‰ã‚ã£ãŸã‚‰å¤‰æ›´ */ }
  reportHours(): string { /* ãƒ¬ãƒãƒ¼ãƒˆå½¢å¼ãŒå¤‰ã‚ã£ãŸã‚‰å¤‰æ›´ */ }
  save(): void { /* DBè¨­è¨ˆãŒå¤‰ã‚ã£ãŸã‚‰å¤‰æ›´ */ }
}

// âœ… å¤‰æ›´ç†ç”±ãŒ1ã¤ãšã¤
class PayCalculator { calculate(employee: Employee): Money { /* ... */ } }
class HourReporter { report(employee: Employee): string { /* ... */ } }
class EmployeeSaver { save(employee: Employee, repo: EmployeeRepository): void { /* ... */ } }
```

**æœ¬ã‚¹ã‚­ãƒ«ã¨ã®é–¢ä¿‚:**
- 4åˆ†é¡ï¼ˆCommand/Transition/Query/ReadModelï¼‰ã¯ã€è²¬å‹™ã‚’æ˜ç¢ºã«åˆ†é›¢ã™ã‚‹
- ã€Œ1ã‚¯ãƒ©ã‚¹1ãƒ‘ãƒ–ãƒªãƒƒã‚¯ãƒ¡ã‚½ãƒƒãƒ‰ã€ãƒ«ãƒ¼ãƒ«ã¯ã€SRPã‚’å¾¹åº•ã—ãŸã‚‚ã®

### O: Open/Closed Principleï¼ˆé–‹æ”¾é–‰é–åŸå‰‡ï¼‰

> **ã€Œæ‹¡å¼µã«å¯¾ã—ã¦é–‹ã„ã¦ãŠã‚Šã€ä¿®æ­£ã«å¯¾ã—ã¦é–‰ã˜ã¦ã„ã‚‹ã¹ãã€**

æ–°ã—ã„æ©Ÿèƒ½ã‚’è¿½åŠ ã™ã‚‹ã¨ãã€æ—¢å­˜ã®ã‚³ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã›ãšã«æ‹¡å¼µã§ãã‚‹ã¹ãã§ã™ã€‚

```typescript
// âŒ æ–°ã—ã„æ”¯æ‰•ã„æ–¹æ³•ã‚’è¿½åŠ ã™ã‚‹ãŸã³ã«æ—¢å­˜ã‚³ãƒ¼ãƒ‰ã‚’ä¿®æ­£
class PaymentProcessor {
  process(payment: Payment): void {
    switch (payment.type) {
      case 'credit': /* ... */ break
      case 'debit': /* ... */ break
      case 'crypto': /* ... */ break  // â† æ–°è¦è¿½åŠ ã®ãŸã³ã«ä¿®æ­£
    }
  }
}

// âœ… æ–°ã—ã„æ”¯æ‰•ã„æ–¹æ³•ã‚’è¿½åŠ ã—ã¦ã‚‚æ—¢å­˜ã‚³ãƒ¼ãƒ‰ã¯å¤‰æ›´ä¸è¦
interface PaymentMethod {
  process(amount: Money): Promise<void>
}

class CreditCardPayment implements PaymentMethod { /* ... */ }
class DebitCardPayment implements PaymentMethod { /* ... */ }
class CryptoPayment implements PaymentMethod { /* ... */ }  // â† è¿½åŠ ã™ã‚‹ã ã‘

class PaymentProcessor {
  process(payment: PaymentMethod, amount: Money): Promise<void> {
    return payment.process(amount)  // â† å¤‰æ›´ä¸è¦
  }
}
```

**æœ¬ã‚¹ã‚­ãƒ«ã¨ã®é–¢ä¿‚:**
- ã€ŒPolymorphism over Switchã€ãƒ«ãƒ¼ãƒ«ã¯ã€OCPã‚’å®Ÿç¾ã™ã‚‹å…·ä½“çš„æ‰‹æ®µ
- ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚’ä½¿ã£ãŸè¨­è¨ˆãŒã€æ‹¡å¼µæ€§ã‚’ä¿è¨¼ã™ã‚‹

### L: Liskov Substitution Principleï¼ˆãƒªã‚¹ã‚³ãƒ•ç½®æ›åŸå‰‡ï¼‰

> **ã€Œæ´¾ç”Ÿã‚¯ãƒ©ã‚¹ã¯ã€åŸºåº•ã‚¯ãƒ©ã‚¹ã¨ç½®æ›å¯èƒ½ã§ã‚ã‚‹ã¹ãã€**

è¦ªã‚¯ãƒ©ã‚¹ã‚’ä½¿ã£ã¦ã„ã‚‹ã‚³ãƒ¼ãƒ‰ã§ã€å­ã‚¯ãƒ©ã‚¹ã«å·®ã—æ›¿ãˆã¦ã‚‚æ­£ã—ãå‹•ãã¹ãã§ã™ã€‚

```typescript
// âŒ LSPé•å: Square ã¯ Rectangle ã¨ç½®æ›ã§ããªã„
class Rectangle {
  constructor(protected width: number, protected height: number) {}
  setWidth(w: number) { this.width = w }
  setHeight(h: number) { this.height = h }
  area(): number { return this.width * this.height }
}

class Square extends Rectangle {
  setWidth(w: number) { this.width = w; this.height = w }  // â† äºˆæœŸã—ãªã„å‹•ä½œ
  setHeight(h: number) { this.width = h; this.height = h }
}

// å•é¡Œ: Rectangle ã‚’æœŸå¾…ã™ã‚‹ã‚³ãƒ¼ãƒ‰ã§ Square ã‚’æ¸¡ã™ã¨å£Šã‚Œã‚‹
function doubleWidth(rect: Rectangle) {
  const originalArea = rect.area()
  rect.setWidth(rect.width * 2)
  // Rectangle ãªã‚‰é¢ç©ã¯2å€ã«ãªã‚‹ã¯ãš
  // Square ã ã¨4å€ã«ãªã£ã¦ã—ã¾ã†ï¼
}
```

**æœ¬ã‚¹ã‚­ãƒ«ã¨ã®é–¢ä¿‚:**
- **ã€Œç¶™æ‰¿ç¦æ­¢ã€ãƒ«ãƒ¼ãƒ«ã¯ã€LSPé•åã‚’æ ¹æœ¬ã‹ã‚‰é˜²ã**
- ç¶™æ‰¿ã®ä»£ã‚ã‚Šã«ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚’ä½¿ã†ã“ã¨ã§ã€ã“ã®å•é¡Œã‚’å›é¿

### I: Interface Segregation Principleï¼ˆã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹åˆ†é›¢åŸå‰‡ï¼‰

> **ã€Œã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãŒä½¿ã‚ãªã„ãƒ¡ã‚½ãƒƒãƒ‰ã¸ã®ä¾å­˜ã‚’å¼·åˆ¶ã™ã¹ãã§ã¯ãªã„ã€**

```typescript
// âŒ å¤ªã„ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹: å…¨å“¡ãŒå…¨ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å®Ÿè£…ã™ã‚‹å¿…è¦ãŒã‚ã‚‹
interface Worker {
  work(): void
  eat(): void
  sleep(): void
}

class Robot implements Worker {
  work(): void { /* OK */ }
  eat(): void { throw new Error('ãƒ­ãƒœãƒƒãƒˆã¯é£Ÿã¹ãªã„') }  // â† ç„¡æ„å‘³
  sleep(): void { throw new Error('ãƒ­ãƒœãƒƒãƒˆã¯å¯ãªã„') }  // â† ç„¡æ„å‘³
}

// âœ… åˆ†é›¢ã•ã‚ŒãŸã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹
interface Workable { work(): void }
interface Eatable { eat(): void }
interface Sleepable { sleep(): void }

class Robot implements Workable {
  work(): void { /* OK */ }
}

class Human implements Workable, Eatable, Sleepable {
  work(): void { /* ... */ }
  eat(): void { /* ... */ }
  sleep(): void { /* ... */ }
}
```

**æœ¬ã‚¹ã‚­ãƒ«ã¨ã®é–¢ä¿‚:**
- ã€Œ1ã‚¯ãƒ©ã‚¹1ãƒ‘ãƒ–ãƒªãƒƒã‚¯ãƒ¡ã‚½ãƒƒãƒ‰ã€ã¯ã€ISPã‚’æ¥µé™ã¾ã§é©ç”¨ã—ãŸã‚‚ã®
- å°ã•ãªã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚’è¤‡æ•°å®Ÿè£…ã™ã‚‹æ–¹ãŒã€å¤§ããªã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚ˆã‚Šè‰¯ã„

### D: Dependency Inversion Principleï¼ˆä¾å­˜æ€§é€†è»¢åŸå‰‡ï¼‰

> **ã€Œä¸Šä½ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã¯ä¸‹ä½ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã«ä¾å­˜ã™ã¹ãã§ã¯ãªã„ã€‚ä¸¡è€…ã¯æŠ½è±¡ã«ä¾å­˜ã™ã¹ãã€**

```typescript
// âŒ DIPé•å: ä¸Šä½ï¼ˆOrderServiceï¼‰ãŒä¸‹ä½ï¼ˆMySQLRepositoryï¼‰ã«ç›´æ¥ä¾å­˜
class MySQLOrderRepository { /* MySQLå›ºæœ‰ã®å®Ÿè£… */ }

class OrderService {
  private repository = new MySQLOrderRepository()  // â† å…·è±¡ã«ä¾å­˜
  
  createOrder(data: OrderData): Order {
    // ...
    this.repository.save(order)
    return order
  }
}

// âœ… DIPéµå®ˆ: ä¸¡è€…ãŒæŠ½è±¡ï¼ˆã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ï¼‰ã«ä¾å­˜
interface OrderRepository {
  save(order: Order): Promise<void>
}

class MySQLOrderRepository implements OrderRepository { /* ... */ }
class InMemoryOrderRepository implements OrderRepository { /* ... */ }

class OrderService {
  createOrder(data: OrderData, repository: OrderRepository): Order {
    // ...
    repository.save(order)
    return order
  }
}
```

**æœ¬ã‚¹ã‚­ãƒ«ã¨ã®é–¢ä¿‚:**
- **ã€Œãƒ¡ã‚½ãƒƒãƒ‰å¼•æ•°ã§Repositoryã‚’å—ã‘å–ã‚‹ã€**ãƒ«ãƒ¼ãƒ«ã¯ã€DIPã‚’å®Ÿç¾ã™ã‚‹å…·ä½“çš„æ‰‹æ®µ
- ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ã§ã¯ãªããƒ¡ã‚½ãƒƒãƒ‰ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ã‚’æ¨å¥¨ã™ã‚‹ç†ç”±

### SOLIDåŸå‰‡ã®è¦ç´„ã¨æœ¬ã‚¹ã‚­ãƒ«ã¨ã®å¯¾å¿œ

| åŸå‰‡ | è¦ç´„ | æœ¬ã‚¹ã‚­ãƒ«ã®å¯¾å¿œãƒ«ãƒ¼ãƒ« |
|------|------|-------------------|
| **SRP** | å¤‰æ›´ç†ç”±ã¯1ã¤ | 4åˆ†é¡ã€1ã‚¯ãƒ©ã‚¹1ãƒ‘ãƒ–ãƒªãƒƒã‚¯ãƒ¡ã‚½ãƒƒãƒ‰ |
| **OCP** | æ‹¡å¼µã«é–‹ãã€ä¿®æ­£ã«é–‰ã˜ã‚‹ | Polymorphism over Switch |
| **LSP** | ç½®æ›å¯èƒ½æ€§ | ç¶™æ‰¿ç¦æ­¢ |
| **ISP** | å°ã•ãªã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ | 1ã‚¯ãƒ©ã‚¹1ãƒ‘ãƒ–ãƒªãƒƒã‚¯ãƒ¡ã‚½ãƒƒãƒ‰ |
| **DIP** | æŠ½è±¡ã«ä¾å­˜ | ãƒ¡ã‚½ãƒƒãƒ‰å¼•æ•°ã§ä¾å­˜ã‚’å—ã‘å–ã‚‹ |

---

## A.3 Code Smellsï¼ˆã‚³ãƒ¼ãƒ‰ã®ä¸å‰ãªè‡­ã„ï¼‰

**Code Smells**ã¯ã€Martin Fowlerã®ã€Refactoringã€ï¼ˆ1999å¹´ï¼‰ã§ä½“ç³»åŒ–ã•ã‚ŒãŸã€Œè¨­è¨ˆä¸Šã®å•é¡Œã‚’ç¤ºå”†ã™ã‚‹å…†å€™ã€ã§ã™ã€‚ã€Œè‡­ã„ã€ã¨ã„ã†è¡¨ç¾ã¯ã€ã€Œå¿…ãšã—ã‚‚ãƒã‚°ã§ã¯ãªã„ãŒã€ä½•ã‹ãŠã‹ã—ã„ã€ã“ã¨ã‚’ç¤ºã—ã¾ã™ã€‚

### æœ¬ã‚¹ã‚­ãƒ«ãŒè§£æ±ºã™ã‚‹Code Smells

| Code Smell | èª¬æ˜ | æœ¬ã‚¹ã‚­ãƒ«ã®å¯¾å¿œ |
|-----------|------|--------------|
| **Long Method** | é•·ã™ãã‚‹ãƒ¡ã‚½ãƒƒãƒ‰ | ã€Œ10è¡Œä»¥å†…ã€ãƒ«ãƒ¼ãƒ« |
| **Long Class** | å·¨å¤§ãªã‚¯ãƒ©ã‚¹ | 4åˆ†é¡ã§è²¬å‹™åˆ†é›¢ |
| **Feature Envy** | ä»–ã‚¯ãƒ©ã‚¹ã®ãƒ‡ãƒ¼ã‚¿ã°ã‹ã‚Šä½¿ã† | Tell, Don't Askï¼ˆ5.6ï¼‰ |
| **Data Class** | ãƒ‡ãƒ¼ã‚¿ã ã‘ã§ãƒ­ã‚¸ãƒƒã‚¯ãŒãªã„ | Rich Domain Model |
| **Shotgun Surgery** | 1å¤‰æ›´ãŒå¤šãã®ã‚¯ãƒ©ã‚¹ã«å½±éŸ¿ | Polymorphismã§è§£æ±º |
| **Primitive Obsession** | ãƒ—ãƒªãƒŸãƒ†ã‚£ãƒ–å‹ã®ä¹±ç”¨ | å€¤ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆï¼ˆ5.3ï¼‰ |
| **Switch Statements** | switchæ–‡ã®ä¹±ç”¨ | Polymorphism over Switch |
| **Parallel Inheritance** | ç¶™æ‰¿éšå±¤ãŒä¸¦è¡Œã—ã¦å¢—ãˆã‚‹ | ç¶™æ‰¿ç¦æ­¢ |
| **Speculative Generality** | ã€Œã„ã¤ã‹ä½¿ã†ã‹ã‚‚ã€ã®æ±ç”¨åŒ– | YAGNI |
| **Middle Man** | å§”è­²ã™ã‚‹ã ã‘ã®ã‚¯ãƒ©ã‚¹ | ç›´æ¥å‘¼ã³å‡ºã— |

### Long Methodï¼ˆé•·ã„ãƒ¡ã‚½ãƒƒãƒ‰ï¼‰

```typescript
// âŒ Long Method: ä½•ã‚’ã—ã¦ã„ã‚‹ã‹æŠŠæ¡å›°é›£
function processOrder(order: Order): void {
  // 50è¡Œã®æ¤œè¨¼ãƒ­ã‚¸ãƒƒã‚¯...
  // 30è¡Œã®è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯...
  // 40è¡Œã®ä¿å­˜ãƒ­ã‚¸ãƒƒã‚¯...
  // 20è¡Œã®é€šçŸ¥ãƒ­ã‚¸ãƒƒã‚¯...
}

// âœ… åˆ†å‰²: å„ãƒ¡ã‚½ãƒƒãƒ‰ãŒ1ã¤ã®ã“ã¨ã‚’ã™ã‚‹
class OrderProcessor {
  process(order: Order, deps: Dependencies): void {
    const validated = new OrderValidator().validate(order)
    const calculated = new OrderCalculator().calculate(validated)
    new OrderSaver().save(calculated, deps.repository)
    new OrderNotifier().notify(calculated, deps.mailer)
  }
}
```

**æœ¬ã‚¹ã‚­ãƒ«ã®ãƒ«ãƒ¼ãƒ«:** ãƒ¡ã‚½ãƒƒãƒ‰ã¯10è¡Œä»¥å†…ã€‚è¶…ãˆã‚‹å ´åˆã¯è²¬å‹™ã‚’åˆ†å‰²ã€‚

### Feature Envyï¼ˆä»–ã‚¯ãƒ©ã‚¹ã¸ã®ç¾¨æœ›ï¼‰

```typescript
// âŒ Feature Envy: Customer ã®ãƒ‡ãƒ¼ã‚¿ã°ã‹ã‚Šä½¿ã£ã¦ã„ã‚‹
class OrderPricer {
  calculateDiscount(order: Order): Money {
    const customer = order.customer
    if (customer.loyaltyPoints > 1000 &&
        customer.membershipYears > 5 &&
        customer.totalPurchases > 10000) {
      return order.total.multiply(0.2)
    }
    return Money.zero()
  }
}

// âœ… ãƒ­ã‚¸ãƒƒã‚¯ã‚’ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´æ‰€ã«ç§»å‹•
class Customer {
  isVIP(): boolean {
    return this.loyaltyPoints > 1000 &&
           this.membershipYears > 5 &&
           this.totalPurchases > 10000
  }
}

class OrderPricer {
  calculateDiscount(order: Order): Money {
    if (order.customer.isVIP()) {
      return order.total.multiply(0.2)
    }
    return Money.zero()
  }
}
```

**æœ¬ã‚¹ã‚­ãƒ«ã®ãƒ«ãƒ¼ãƒ«:** è©³ç´°ã¯ã€Œ5.6 Tell, Don't Askã€ã§è§£èª¬ã€‚

### Data Classï¼ˆãƒ‡ãƒ¼ã‚¿ã‚¯ãƒ©ã‚¹ï¼‰/ Anemic Domain Modelï¼ˆè²§è¡€ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ¢ãƒ‡ãƒ«ï¼‰

```typescript
// âŒ Data Class: ãƒ‡ãƒ¼ã‚¿ã ã‘ã§ãƒ­ã‚¸ãƒƒã‚¯ãŒãªã„ï¼ˆè²§è¡€ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ¢ãƒ‡ãƒ«ï¼‰
class Order {
  items: OrderItem[]
  status: string
  createdAt: Date
}

// è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ã¯å¤–éƒ¨ã® Service ã«ã‚ã‚‹
class OrderService {
  calculateTotal(order: Order): Money { /* ... */ }
  canBeCancelled(order: Order): boolean { /* ... */ }
  addItem(order: Order, item: OrderItem): void { /* ... */ }
}

// âœ… Rich Domain Model: ãƒ‡ãƒ¼ã‚¿ã¨ãƒ­ã‚¸ãƒƒã‚¯ãŒä¸€ç·’
class Order {
  constructor(
    private readonly items: OrderItem[],
    private readonly status: OrderStatus,
    private readonly createdAt: Date
  ) {}
  
  total(): Money {
    return this.items.reduce((sum, item) => sum.add(item.subtotal()), Money.zero())
  }
  
  canBeCancelled(): boolean {
    return this.status.allowsCancellation() &&
           this.createdAt.isWithinLast(24, 'hours')
  }
  
  withItem(item: OrderItem): Order {
    return new Order([...this.items, item], this.status, this.createdAt)
  }
}
```

**æœ¬ã‚¹ã‚­ãƒ«ã®ãƒ«ãƒ¼ãƒ«:**
- Transition ã‚¯ãƒ©ã‚¹ã«ã¯ãƒ­ã‚¸ãƒƒã‚¯ã‚’æŒãŸã›ã‚‹
- ã€Œãƒ‡ãƒ¼ã‚¿ã ã‘æŒã£ã¦ã„ã‚‹ã€ã‚¯ãƒ©ã‚¹ã¯ ReadModel ã®ã¿

### Shotgun Surgeryï¼ˆæ•£å¼¾éŠƒæ‰‹è¡“ï¼‰

```typescript
// âŒ Shotgun Surgery: æ–°ã—ã„æ”¯æ‰•ã„æ–¹æ³•ã‚’è¿½åŠ ã™ã‚‹ã¨è¤‡æ•°ç®‡æ‰€ã‚’ä¿®æ­£
// 1. PaymentProcessor.ts
switch (payment.type) {
  case 'credit': ...
  case 'paypal': ...
  case 'crypto': ...  // â† è¿½åŠ 
}

// 2. PaymentValidator.ts
switch (payment.type) {
  case 'credit': ...
  case 'paypal': ...
  case 'crypto': ...  // â† è¿½åŠ 
}

// 3. PaymentReporter.ts
switch (payment.type) {
  case 'credit': ...
  case 'paypal': ...
  case 'crypto': ...  // â† è¿½åŠ 
}

// âœ… Polymorphism: 1ç®‡æ‰€ã«é›†ç´„
interface PaymentMethod {
  process(): Promise<void>
  validate(): ValidationResult
  report(): PaymentReport
}

class CryptoPayment implements PaymentMethod {
  process(): Promise<void> { /* ... */ }
  validate(): ValidationResult { /* ... */ }
  report(): PaymentReport { /* ... */ }
}
```

**æœ¬ã‚¹ã‚­ãƒ«ã®ãƒ«ãƒ¼ãƒ«:** ã€ŒPolymorphism over Switchã€ã§1ç®‡æ‰€ã«ã¾ã¨ã‚ã‚‹ã€‚

### Primitive Obsessionï¼ˆãƒ—ãƒªãƒŸãƒ†ã‚£ãƒ–å‹ã¸ã®åŸ·ç€ï¼‰

```typescript
// âŒ Primitive Obsession: string ã‚„ number ã‚’ç›´æ¥ä½¿ã†
function createUser(
  email: string,      // ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹
  phone: string,      // é›»è©±ç•ªå·
  age: number,        // å¹´é½¢
  zipCode: string     // éƒµä¾¿ç•ªå·
): User {
  // email ã®å½¢å¼ãƒã‚§ãƒƒã‚¯ã¯ã©ã“ã§ï¼Ÿ
  // age ãŒè² ã®æ•°ã ã£ãŸã‚‰ï¼Ÿ
  // å‘¼ã³å‡ºã—å´ã§ email ã¨ phone ã‚’é€†ã«æ¸¡ã—ãŸã‚‰ï¼Ÿ
}

// âœ… å€¤ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã§æ„å‘³ã¨åˆ¶ç´„ã‚’è¡¨ç¾
function createUser(
  email: Email,
  phone: PhoneNumber,
  age: Age,
  zipCode: ZipCode
): User {
  // å„å€¤ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒè‡ªèº«ã®æ¤œè¨¼ã‚’æŒã¤
  // å‹ãŒé•ã†ã®ã§å¼•æ•°ã®é †åºã‚’é–“é•ãˆã‚‹ã¨ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã‚¨ãƒ©ãƒ¼
}

class Email {
  private constructor(private readonly value: string) {}
  
  static create(value: string): Email | ValidationError {
    if (!value.includes('@')) {
      return new ValidationError('Invalid email format')
    }
    return new Email(value)
  }
}
```

**æœ¬ã‚¹ã‚­ãƒ«ã®ãƒ«ãƒ¼ãƒ«:** è©³ç´°ã¯ã€Œ5.3 Primitive Obsession ã®å›é¿ã€ã§è§£èª¬ã€‚

---

# Appendix: ã‚¯ã‚¤ãƒƒã‚¯ãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹

## åˆ¤æ–­ãƒ•ãƒ­ãƒ¼

### 4åˆ†é¡

```
ã“ã®ã‚¯ãƒ©ã‚¹ã¯å¤–éƒ¨ãƒªã‚½ãƒ¼ã‚¹ï¼ˆDBã€APIç­‰ï¼‰ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ï¼Ÿ
â”œâ”€ YES â†’ æ›¸ãè¾¼ã¿ãŒã‚ã‚‹ï¼Ÿ
â”‚   â”œâ”€ YES â†’ Command
â”‚   â””â”€ NO â†’ ReadModel
â””â”€ NO â†’ å‹ãŒå¤‰ã‚ã‚‹ï¼Ÿï¼ˆå…¥åŠ›å‹ â‰  å‡ºåŠ›å‹ï¼‰
    â”œâ”€ YES â†’ Transition
    â””â”€ NO â†’ Query
```

### Polymorphism vs switch

```
ä»¥ä¸‹ã®è³ªå•ã«1ã¤ã§ã‚‚ YES ãŒã‚ã‚Œã° Polymorphism ã‚’ä½¿ã†

1. å„åˆ†å²ã§ç•°ãªã‚‹è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ãŒã‚ã‚‹ï¼Ÿ
2. å„åˆ†å²ã‚’ç‹¬ç«‹ã—ã¦ãƒ†ã‚¹ãƒˆã—ãŸã„ï¼Ÿ
3. ä»Šå¾Œã€åˆ†å²ãŒè¿½åŠ ã•ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ï¼Ÿ

å…¨ã¦ NO â†’ switch OK
```

### ä¾å­˜ã®ç”Ÿæˆæ–¹æ³•

```
ã“ã®ä¾å­˜ã¯...
â”œâ”€ å¤–éƒ¨ãƒªã‚½ãƒ¼ã‚¹ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ï¼Ÿ â†’ ãƒ¡ã‚½ãƒƒãƒ‰å¼•æ•°ã§å—ã‘å–ã‚‹
â”œâ”€ å®Ÿè¡Œã™ã‚‹ãŸã³ã«çµæœãŒå¤‰ã‚ã‚‹ï¼Ÿ â†’ ãƒ¡ã‚½ãƒƒãƒ‰å¼•æ•°ã§å—ã‘å–ã‚‹
â”œâ”€ è¨­å®šå€¤ã«ä¾å­˜ã™ã‚‹ï¼Ÿ â†’ ConfigçµŒç”±ã§ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿å†…ç”Ÿæˆ
â””â”€ ä¸Šè¨˜å…¨ã¦NO â†’ ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿å†…ã§ new
```

---

## ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

### æ–°è¦ã‚¯ãƒ©ã‚¹ä½œæˆæ™‚
- [ ] Command / Transition / Query / ReadModel ã®ã„ãšã‚Œã‹ã«åˆ†é¡ã—ãŸã‹
- [ ] å®Œå…¨ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã«ãªã£ã¦ã„ã‚‹ã‹ï¼ˆå…¨ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã§è¨­å®šï¼‰
- [ ] ç¶™æ‰¿ã‚’ä½¿ã£ã¦ã„ãªã„ã‹ï¼ˆInterface + Composition ã‚’ä½¿ç”¨ï¼‰
- [ ] å¼•æ•°ã¯2å€‹ä»¥ä¸‹ã‹ï¼ˆå¤šã„å ´åˆã¯ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«ã¾ã¨ã‚ã‚‹ï¼‰

### ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼æ™‚
- [ ] else ã‚’ä½¿ã£ã¦ã„ãªã„ã‹ï¼ˆEarly Return ã‚’ä½¿ç”¨ï¼‰
- [ ] switch ã§æŒ¯ã‚‹èˆã„ã‚’åˆ†å²ã—ã¦ã„ãªã„ã‹ï¼ˆPolymorphism ã‚’æ¤œè¨ï¼‰
- [ ] string/number ã‚’ä¹±ç”¨ã—ã¦ã„ãªã„ã‹ï¼ˆå€¤ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’æ¤œè¨ï¼‰
- [ ] ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªåãŒæŠ€è¡“ãƒ¬ã‚¤ãƒ¤ãƒ¼åã§ã¯ãªã„ã‹

### ãƒ†ã‚¹ãƒˆä½œæˆæ™‚
- [ ] Pure Logic ã¯ç›´æ¥ãƒ†ã‚¹ãƒˆã—ã¦ã„ã‚‹ã‹ï¼ˆãƒ¢ãƒƒã‚¯ä¸è¦ï¼‰
- [ ] External Resource ã«ã¯ InMemory å®Ÿè£…ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ã‹
- [ ] å…±æœ‰ãƒ•ã‚£ã‚¯ã‚¹ãƒãƒ£ã‚’ä½¿ã£ã¦ã„ãªã„ã‹ï¼ˆFactory ã‚’ä½¿ç”¨ï¼‰
- [ ] ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚½ãƒ¼ã‚¹ã¨åŒå±…ã—ã¦ã„ã‚‹ã‹

---

## ç”¨èªé›†

| ç”¨èª | æ„å‘³ |
|------|------|
| **Command** | æ°¸ç¶šçŠ¶æ…‹ã‚’å¤‰æ›´ã™ã‚‹ã‚¯ãƒ©ã‚¹ã€‚å‰¯ä½œç”¨ã‚ã‚Šã€‚ä¾‹: ç¨Ÿè­°ã‚’ç”³è«‹ã™ã‚‹ |
| **Transition** | å‹å¤‰æ›ã‚’è¡Œã†ç´”ç²‹é–¢æ•°ã‚¯ãƒ©ã‚¹ã€‚ä¾‹: ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ |
| **Query** | è¨ˆç®—ã‚’è¡Œã†ç´”ç²‹é–¢æ•°ã‚¯ãƒ©ã‚¹ã€‚ä¾‹: ç¨é¡è¨ˆç®— |
| **ReadModel** | èª­ã¿å–ã‚Šå°‚ç”¨ã§ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹ã‚¯ãƒ©ã‚¹ã€‚ä¾‹: ä¸€è¦§å–å¾— |
| **å®Œå…¨ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿** | ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã‚’æŠœã‘ãŸæ™‚ç‚¹ã§ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒå®Œå…¨ã«æœ‰åŠ¹ |
| **Pending Object Pattern** | çŠ¶æ…‹é·ç§»ã‚’å‹ã§è¡¨ç¾ã™ã‚‹ãƒ‘ã‚¿ãƒ¼ãƒ³ |
| **Resultå‹** | æˆåŠŸ/å¤±æ•—ã‚’æˆ»ã‚Šå€¤ã®å‹ã§è¡¨ç¾ã™ã‚‹ä»•çµ„ã¿ |
| **DomainError** | ãƒ“ã‚¸ãƒã‚¹ãƒ«ãƒ¼ãƒ«é•åã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå¯¾å‡¦å¯èƒ½ |
| **InfrastructureError** | æŠ€è¡“çš„éšœå®³ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã¯å¯¾å‡¦ä¸å¯èƒ½ |
| **Polymorphism** | åŒã˜ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã§ç•°ãªã‚‹å®Ÿè£…ã‚’æ‰±ã† |
| **å€¤ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ** | æ„å‘³ã®ã‚ã‚‹å˜ä½ã§å‹ã‚’ä½œã‚‹ã“ã¨ï¼ˆEmail, UserIdç­‰ï¼‰ |
| **Early Return** | ç•°å¸¸ç³»ã‚’å…ˆã«ãƒã‚§ãƒƒã‚¯ã—ã¦æ—©æœŸã«return |
| **Screaming Architecture** | ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ ãŒã‚·ã‚¹ãƒ†ãƒ ã®æ„å›³ã‚’ç¤ºã™ |
| **Colocation** | é–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«ã‚’åŒã˜ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«é…ç½® |
| **Test Data Factory** | ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’æ¯å›æ–°ã—ãç”Ÿæˆã™ã‚‹é–¢æ•° |
| **InMemory Repository** | ãƒ¡ãƒ¢ãƒªä¸Šã§å‹•ä½œã™ã‚‹ãƒ†ã‚¹ãƒˆç”¨Repository |
| **Gateway** | å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹ã‚’æŠ½è±¡åŒ–ã™ã‚‹ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ |

> **ãƒ†ã‚¹ãƒˆç”¨èªï¼ˆãƒ¢ãƒƒã‚¯ã€ã‚¹ã‚¿ãƒ–ã€ãƒ•ã‚£ã‚¯ã‚¹ãƒãƒ£ï¼‰** ã¯ 0.2 ç¯€ã§è§£èª¬ã—ã¦ã„ã¾ã™ã€‚
